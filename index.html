<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini POS</title>
    
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#2563eb">
	<link rel="icon" type="image/x-icon" href="./mini_pos.ico">
    
    <link rel="apple-touch-icon" href="./mini_pos.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<!--<script src="https://unpkg.com/@zxing/library@latest"></script>-->
	<script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.5.0/dist/easy.qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; user-select: none; }
        .hidden { display: none !important; }
        .scan-success { animation: popIn 0.3s ease-out; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .history-table th { font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 700; padding: 8px; text-align: left; background: #f9fafb; }
        .history-table td { padding: 8px; font-size: 13px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .locked-item { opacity: 0.6; background-color: #f3f4f6; }
        .locked-item img { filter: grayscale(100%); }
		
		/* --- THÃŠM VÃ€O CUá»I THáºº STYLE --- */
		.modal-overlay { z-index: 60 !important; } /* Äáº£m báº£o nÃ³ Ä‘Ã¨ lÃªn má»i thá»© */
		.modal-enter { animation: modalSlideIn 0.2s ease-out forwards; }
		@keyframes modalSlideIn { 
			from { transform: scale(0.95); opacity: 0; } 
			to { transform: scale(1); opacity: 1; } 
		}
		
		/* --- Sá»¬A Lá»–I CAMERA CO GIÃƒN --- */
		#reader {
			width: 100%;
			height: 100%;
			overflow: hidden;
			position: absolute !important; /* <--- Sá»­a thÃ nh absolute Ä‘á»ƒ ghim cháº·t vÃ o khung cha */
			top: 0;
			left: 0;
		}

		#reader video {
			width: 100% !important;
			height: 100% !important;
			object-fit: cover !important; /* Láº¥p Ä‘áº§y khung, khÃ´ng mÃ©o */
			border-radius: 0 !important;
		}

		#custom-alert {
			z-index: 2147483647 !important; /* Sá»‘ lá»›n nháº¥t mÃ  trÃ¬nh duyá»‡t hiá»ƒu Ä‘Æ°á»£c */
		}
		
		/* --- HIá»†U á»¨NG GIá» HÃ€NG CAO Cáº¤P --- */

		/* 1. NÃºt rung nháº¹ khi chá» thanh toÃ¡n */
		@keyframes soft-pulse {
			0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
			70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
			100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
		}

		/* 2. Class kÃ­ch hoáº¡t hiá»‡u á»©ng rung */
		.cart-active-pulse {
			animation: soft-pulse 2s infinite;
		}

		/* 3. Hiá»‡u á»©ng sá»‘ náº£y lÃªn (Pop) khi thÃªm hÃ ng */
		.badge-pop {
			animation: popInBadge 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}
		@keyframes popInBadge {
			0% { transform: scale(0.8); }
			50% { transform: scale(1.5); }
			100% { transform: scale(1); }
		}
		
		/* --- Cáº¤U HÃŒNH IN HÃ“A ÄÆ N (ÄÃ£ canh lá» chuáº©n) --- */
		@media print {
			/* 1. áº¨n giao diá»‡n web */
			body > * { display: none !important; }
			
			/* 2. Cáº¥u hÃ¬nh khung hÃ³a Ä‘Æ¡n */
			#receipt-print-area { 
				display: block !important; 
				position: absolute; 
				left: 0; 
				top: 0; 
				width: 100%; 
				
				/* --- CANH Lá»€ Táº I ÄÃ‚Y --- */
				/* Padding: TrÃªn/DÆ°á»›i 0mm, TrÃ¡i/Pháº£i 3mm (hoáº·c 5mm tÃ¹y mÃ¡y) */
				padding: 0mm 5mm !important; 
				
				box-sizing: border-box; /* Giá»¯ kÃ­ch thÆ°á»›c chuáº©n khÃ´ng bá»‹ vá»¡ */
				background: white;
				color: black;
				font-family: monospace; /* Font chá»¯ Ä‘Æ¡n cÃ¡ch cho tháº³ng hÃ ng sá»‘ */
			}

			/* 3. XÃ³a lá» máº·c Ä‘á»‹nh cá»§a trÃ¬nh duyá»‡t Ä‘á»ƒ ta tá»± kiá»ƒm soÃ¡t */
			@page { 
				size: auto; 
				margin: 0mm; /* Quan trá»ng: Äáº·t vá» 0 Ä‘á»ƒ khÃ´ng bá»‹ trÃ¬nh duyá»‡t tá»± thÃªm lá» tráº¯ng */
			}
		}
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">

    <div id="login-screen" class="fixed inset-0 z-50 bg-gray-100 flex items-center justify-center p-4">
		<div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
			<div class="text-center mb-6">
				<div class="">
					<img src="./mini_pos.png" class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-3">
				</div>
				<h1 class="text-2xl font-bold text-gray-800">Mini POS</h1>
				<p class="text-gray-400 text-sm">Há»‡ thá»‘ng há»— trá»£ bÃ¡n hÃ ng</p>
			</div>
			
			<div class="space-y-4">
				<div>
					<label class="block text-xs font-bold text-gray-500 mb-1">Email</label>
					<!--<input type="email" id="email" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="name@example.com">-->
					<input 
						type="email" 
						id="email" 
						class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
						placeholder="name@example.com"
						enterkeyhint="next"
						onkeyup="if(event.key === 'Enter') document.getElementById('password').focus()"
					>
				</div>
				<div>
					<label class="block text-xs font-bold text-gray-500 mb-1">Máº­t kháº©u</label>
					<!--<input type="password" id="password" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">-->
					<input 
						type="password" 
						id="password" 
						class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
						placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
						enterkeyhint="go"
						onkeyup="handleLoginKey(event)"
					>
				</div>
				
				<div id="login-msg" class="text-center text-red-500 text-xs font-bold min-h-[20px]"></div>
				
				<button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">ÄÄ‚NG NHáº¬P</button>
				
				<div class="relative flex py-2 items-center">
					<div class="flex-grow border-t border-gray-200"></div>
					<span class="flex-shrink-0 mx-4 text-gray-400 text-xs">Hoáº·c</span>
					<div class="flex-grow border-t border-gray-200"></div>
				</div>
				
				<button onclick="startLoginScanner()" class="w-full bg-white text-gray-700 border border-gray-300 py-3 rounded-xl font-bold shadow-sm active:scale-95 transition-transform flex items-center justify-center gap-2">
					<i class="fas fa-qrcode"></i> QuÃ©t mÃ£ QR Ä‘Äƒng nháº­p
				</button>
			</div>
		</div>

		<div id="login-scanner-overlay" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[60] flex flex-col items-center justify-center">
			<p class="text-white font-bold mb-4 text-lg">ÄÆ°a mÃ£ QR vÃ o khung</p>
			
			<div class="relative w-80 h-80 border-4 border-blue-500 rounded-2xl overflow-hidden shadow-2xl bg-black">
				<div id="reader-login" class="w-full h-full"></div>
			</div>

			<button onclick="stopLoginScanner()" class="mt-8 bg-white text-red-600 px-6 py-2 rounded-full font-bold shadow-lg">ÄÃ³ng Camera</button>
		</div>
	</div>

    <div id="scan-screen" class="flex-1 flex flex-col hidden bg-gray-100">
        <div class="bg-white p-3 flex justify-between items-center shadow-sm z-20 sticky top-0">
            <div class="flex flex-col">
                <span id="user-email" class="text-xs font-bold text-gray-400 uppercase">Staff</span>
                <div class="flex items-center gap-2"><span class="text-lg font-bold text-gray-800">BÃ¡n HÃ ng</span><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span></div>
            </div>
            
        </div>

		<div class="bg-white px-3 py-2 border-b shadow-sm z-20 sticky top-0">
			<div class="flex gap-3 overflow-x-auto no-scrollbar pb-1">
				<button onclick="toggleCheckPriceMode()" class="flex items-center gap-2 bg-teal-50 text-teal-700 px-4 py-2 rounded-full border border-teal-100 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0">
					<span>ğŸ”</span> <span>Kiá»ƒm tra giÃ¡</span>
				</button>

				<button onclick="showRecallModal()" class="flex items-center gap-2 bg-orange-50 text-orange-600 px-4 py-2 rounded-full border border-orange-100 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0 relative">
					<span id="parked-count" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center border border-white">0</span>
					<span>ğŸ›‘ Giao dá»‹ch chá»</span>
				</button>

				<button onclick="openHistory()" class="flex items-center gap-2 bg-blue-50 text-blue-600 px-4 py-2 rounded-full border border-blue-100 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0">
					<span>ğŸ•’ Lá»‹ch sá»­ giao dá»‹ch</span>
				</button>
				
				<button id="btn-open-admin" onclick="openAdminScreen()" class="hidden flex items-center gap-2 bg-purple-50 text-purple-600 px-4 py-2 rounded-full border border-purple-100 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0">
					<span>âš™ï¸ Quáº£n lÃ½</span>
				</button>
				
				<button onclick="confirmLogout()" class="flex items-center gap-2 bg-gray-100 text-gray-600 px-4 py-2 rounded-full border border-gray-200 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0">
					<span>ğŸšª ÄÄƒng xuáº¥t</span>
				</button>
			</div>
		</div>

        <div class="relative bg-black flex-1 flex flex-col items-center justify-center overflow-hidden group w-full">
    
			<div id="reader" class="w-full h-full absolute inset-0 z-0"></div>

			<video id="scan-video" class="w-full h-full object-cover" autoplay playsinline muted></video>
			<canvas id="scan-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>

			<button id="btn-stop-cam" onclick="stopScanner()" class="hidden absolute top-4 right-4 z-40 bg-black/50 text-white p-2 rounded-full border border-white/30 backdrop-blur-md hover:bg-red-600 transition">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
			</button>
			
			<div id="multiplier-badge" 
				 class="hidden absolute top-10 inset-x-0 mx-auto w-fit z-30 bg-red-600 text-white px-4 py-1 rounded-full font-bold shadow-lg border border-white animate-bounce">
				Sá»‘ lÆ°á»£ng: x<span id="multiplier-val">1</span><span> Sáº£n pháº©m</span>
			</div>

			<div id="camera-placeholder" class="z-20 text-center absolute">
				<button onclick="startScanner()" class="bg-white/20 backdrop-blur-md border border-white/40 text-white px-8 py-4 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-white/30 transition">
					ğŸ“· Báº¬T CAMERA
				</button>
			</div>
		</div>

        <div class="sticky bottom-0 z-50 bg-white border-t rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] -mt-6 pb-[env(safe-area-inset-bottom)] overflow-hidden transition-all duration-300">
    
			<div id="sales-panel" class="block">
				<div class="p-4 pb-2">
					<div class="mb-3 flex gap-2 items-center">
						
						<button onclick="openScanSettings()" class="w-12 h-12 rounded-xl bg-gray-200 text-gray-600 flex items-center justify-center text-xl shadow-sm active:scale-95 transition-transform shrink-0">
							âš™ï¸
						</button>

						<div class="relative flex-1 group">
							<input 
								type="tel" 
								id="manual-input" 
								placeholder="Nháº­p mÃ£..." 
								class="w-full bg-gray-100 p-3.5 pl-10 rounded-xl text-lg font-semibold outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all shadow-inner" 
								onkeyup="handleManualInput(event)"
								enterkeyhint="search"
								autocomplete="off"
							>
							<span class="absolute left-3 top-4 text-gray-400">âŒ¨ï¸</span>
						</div>

						<div id="scan-buttons-container" class="flex gap-1 shrink-0"></div>
					</div>
					
					<div id="last-scanned-card" class="bg-emerald-50 p-3 rounded-2xl border border-emerald-100 flex items-center justify-between hidden scan-success mb-3 shadow-sm">
						<div>
							<h3 id="last-item-name" class="font-bold text-gray-800 line-clamp-1">...</h3>
							<div id="last-item-info" class="text-[11px] text-gray-500 font-semibold mb-1">...</div>
							<div id="last-item-price-container"></div>
						</div>
						<div class="bg-white px-3 py-1 rounded-xl border border-emerald-200 shadow-sm"><span id="last-item-qty" class="text-xl font-bold text-emerald-600">+1</span></div>
					</div>

					<div class="grid grid-cols-2 gap-3">
						<button onclick="voidTransaction()" class="bg-red-50 text-red-600 py-3.5 rounded-xl font-bold text-xs hover:bg-red-100 transition-colors">ğŸ—‘ Há»¦Y ÄÆ N</button>
						<button onclick="parkOrder()" class="bg-orange-50 text-orange-600 py-3.5 rounded-xl font-bold text-xs hover:bg-orange-100 transition-colors">â¸ HOÃƒN GIAO Dá»ŠCH</button>
					</div>
				</div>

				<div class="px-4 pb-4 pt-2">
					<button id="btn-cart-payment" onclick="goToPayment()" class="w-full bg-gray-200 text-gray-400 p-4 rounded-2xl font-bold text-xl shadow-none flex justify-between items-center active:scale-[0.98] transition-all duration-300 group pointer-events-none">
						<div class="flex items-center gap-3">
							<span class="bg-black/10 px-3 py-1 rounded-lg text-sm backdrop-blur-md" id="quick-count">0</span>
							<span class="text-sm font-normal opacity-90">Giá» hÃ ng</span>
						</div>
						<span id="quick-total">0Ä‘ &rarr;</span>
					</button>
				</div>
			</div>

			<div id="check-price-panel" class="hidden bg-teal-50 h-full flex flex-col">
				
				<div class="px-4 py-3 bg-teal-600 text-white flex justify-between items-center shadow-md shrink-0">
					<div class="flex items-center gap-2">
						<span class="text-2xl animate-bounce">ğŸ”</span>
						<div>
							<h3 class="font-bold text-lg leading-none">Cháº¿ Ä‘á»™ Xem GiÃ¡</h3>
							<p class="text-[10px] opacity-80">QuÃ©t mÃ£ Ä‘á»ƒ xem, khÃ´ng thÃªm vÃ o giá»</p>
						</div>
					</div>
					<button onclick="toggleCheckPriceMode()" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg text-xs font-bold border border-white/30">ÄÃ³ng</button>
				</div>

				<div class="p-4 flex-1 flex flex-col gap-3">
					<div class="flex gap-2 items-center">
						<button onclick="openScanSettings()" class="w-12 h-12 rounded-xl bg-teal-100 text-teal-600 flex items-center justify-center text-xl shadow-sm active:scale-95 transition-transform shrink-0 border border-teal-200">
							âš™ï¸
						</button>

						<div class="relative flex-1 group">
							<input 
								type="tel" 
								id="check-price-input" 
								placeholder="QuÃ©t hoáº·c nháº­p mÃ£..." 
								class="w-full bg-white border-2 border-teal-200 p-3.5 pl-10 rounded-xl text-lg font-bold outline-none focus:border-teal-500 text-teal-800 transition-all shadow-inner" 
								onkeyup="handleCheckPriceManual(event)"
								enterkeyhint="search"
								autocomplete="off"
							>
							<span class="absolute left-3 top-4 text-teal-300">ğŸ”</span>
						</div>

						<div id="scan-buttons-container-check" class="flex gap-1 shrink-0"></div>
					</div>

					<div id="check-result-container" class="bg-white rounded-2xl border border-teal-100 shadow-sm flex-1 flex flex-col items-center justify-center p-4 text-center min-h-[160px]">
						<div class="opacity-50 grayscale">
							<div class="text-5xl mb-2">ğŸ·ï¸</div>
							<p class="text-gray-400 text-sm">Má»i quÃ©t sáº£n pháº©m...</p>
						</div>
					</div>
				</div>
			</div>
		</div>
    </div>

    <div id="admin-screen" class="hidden fixed inset-0 z-40 bg-gray-50 flex flex-col h-full animate-fade-in">
        <div class="bg-white p-4 shadow-md flex justify-between items-center z-10 sticky top-0">
            <div class="flex items-center gap-2">
				<!--<button onclick="closeAdminScreen()" class="p-2 -ml-2 hover:bg-gray-100 rounded-full">â¬…</button>-->
				<button onclick="closeAdminScreen()" class="group w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 shadow-sm text-gray-500 hover:text-blue-600 hover:border-blue-200 active:scale-95 transition-all -ml-1 mr-2">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:-translate-x-0.5 transition-transform">
						<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
					</svg>
				</button>
				<h2 class="font-bold text-xl text-gray-800">Quáº£n LÃ½</h2>
			</div>
            <button onclick="forceLogout()" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded">ÄÄƒng xuáº¥t</button>
        </div>
        <div class="p-3 bg-white border-b flex gap-2">
            <button onclick="switchAdminTab('products')" id="tab-products" class="flex-1 py-2.5 rounded-lg font-bold bg-blue-600 text-white">ğŸ“¦ HÃ ng hÃ³a</button>
            <button onclick="switchAdminTab('revenue')" id="tab-revenue" class="flex-1 py-2.5 rounded-lg font-bold bg-white text-gray-500 border">ğŸ’° Doanh thu</button>
			<button onclick="switchAdminTab('users')" id="tab-users" class="flex-1 py-2.5 rounded-lg font-bold bg-white text-gray-500 border">ğŸ‘¥ NhÃ¢n viÃªn</button>
			<button onclick="switchAdminTab('system')" id="tab-system" class="flex-1 py-2.5 rounded-lg font-bold bg-white text-gray-500 border">ğŸ”§ Há»‡ thá»‘ng</button>
        </div>
        
        <div id="admin-products" class="flex-1 flex flex-col overflow-hidden">
            <div class="p-3 bg-white flex flex-col gap-2 border-b">
                <div class="flex gap-2">
                    <input type="text" placeholder="TÃ¬m tÃªn, mÃ£..." class="flex-1 bg-gray-100 p-2.5 rounded-lg outline-none" oninput="renderProductList(this.value)">
                    <button onclick="openProductModal()" class="bg-green-600 text-white px-4 rounded-lg font-bold">+</button>
                </div>
                <div class="flex gap-2 justify-end">
					<button onclick="deleteAllProducts()" class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold border border-red-200 hover:bg-red-200 mr-auto">ğŸ—‘ï¸ XÃ³a táº¥t cáº£</button>
                    <button onclick="downloadTemplate()" class="text-xs text-blue-600 underline">â¬‡ï¸ Táº£i máº«u Excel</button>
                    <label class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold cursor-pointer border border-green-200 hover:bg-green-200 flex items-center gap-1">
                        <span>ğŸ“¥ Nháº­p Excel</span>
                        <input type="file" id="excel-upload" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(event)">
                    </label>
                </div>
            </div>
            <div id="admin-product-list" class="flex-1 overflow-y-auto p-3 space-y-2 pb-20"></div>
        </div>

        <div id="admin-revenue" class="hidden flex-1 flex flex-col overflow-hidden bg-gray-50 h-full">
    
			<div id="revenue-classic-ui" class="flex flex-col h-full">
				<div class="p-4 grid grid-cols-2 gap-3 shrink-0">
					<div class="bg-white p-4 rounded-2xl shadow-sm border border-indigo-50">
						<p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">HÃ´m nay</p>
						<p class="text-xl font-bold text-indigo-700 mt-1 font-display truncate" id="rev-today">0Ä‘</p>
						<p id="order-count-today" class="text-[10px] text-indigo-400 mt-1 font-medium">0 Ä‘Æ¡n</p>
					</div>
					<div class="bg-white p-4 rounded-2xl shadow-sm border border-purple-50">
						<p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">ThÃ¡ng nÃ y</p>
						<p class="text-xl font-bold text-purple-700 mt-1 font-display truncate" id="rev-month">0Ä‘</p>
						<p id="order-count-month" class="text-[10px] text-purple-400 mt-1 font-medium">0 Ä‘Æ¡n</p>
					</div>
				</div>

				<div class="flex-1 bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] flex flex-col overflow-hidden border-t border-gray-100 mx-2">
					<div class="p-4 border-b border-gray-100 z-10 bg-white">
						<div class="flex items-center justify-between mb-3">
							<h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">ğŸ“Š Chi tiáº¿t doanh sá»‘</h3>
							<button onclick="loadRevenue(); viewRevenueDetail();" class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 hover:bg-gray-200">ğŸ”„ LÃ m má»›i</button>
						</div>
						
						<div class="flex gap-2 mb-3">
							<div class="flex-1">
								<label class="text-[9px] font-bold text-gray-400 block mb-1 uppercase">Tá»« ngÃ y</label>
								<input type="date" id="filter-start" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs font-bold text-gray-700 outline-none focus:ring-1 focus:ring-indigo-500">
							</div>
							<div class="flex-1">
								<label class="text-[9px] font-bold text-gray-400 block mb-1 uppercase">Äáº¿n ngÃ y</label>
								<input type="date" id="filter-end" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs font-bold text-gray-700 outline-none focus:ring-1 focus:ring-indigo-500">
							</div>
							<div class="flex items-end">
								<button onclick="viewRevenueDetail()" class="bg-indigo-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-md active:bg-indigo-700 transition-transform">ğŸ”</button>
							</div>
						</div>

						<div class="flex justify-between items-center bg-indigo-50 p-2.5 rounded-xl border border-indigo-100">
							<span class="text-xs text-indigo-600 font-bold" id="filter-count">0 Ä‘Æ¡n hÃ ng</span>
							<span class="text-base font-bold text-indigo-700 font-display" id="filter-sum">0Ä‘</span>
						</div>
						
						<button onclick="exportRevenueReport()" class="w-full mt-2 text-[10px] text-emerald-600 font-bold border border-emerald-200 bg-emerald-50 py-2 rounded-lg hover:bg-emerald-100">ğŸ“¥ Xuáº¥t Excel</button>
					</div>

					<div id="revenue-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50 pb-20"></div>
				</div>
			</div> 
			<div id="revenue-chart-ui" class="flex flex-col h-full hidden overflow-y-auto p-4 space-y-4 pb-20">
				<div class="flex justify-between items-center">
					<h3 class="font-bold text-gray-800 text-lg">Tá»•ng Quan ğŸ“Š</h3>
					<button onclick="renderCharts()" class="text-xs bg-white border px-3 py-1.5 rounded-lg shadow-sm font-bold text-indigo-600">ğŸ”„ LÃ m má»›i</button>
				</div>

				<div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
					<h4 class="text-xs font-bold text-gray-400 uppercase mb-4">Doanh thu 7 ngÃ y qua</h4>
					<div class="h-48 relative w-full">
						<canvas id="chart-revenue-7days"></canvas>
					</div>
				</div>

				<div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
					<h4 class="text-xs font-bold text-gray-400 uppercase mb-4">Top 5 Sáº£n pháº©m bÃ¡n cháº¡y</h4>
					<div class="h-48 relative w-full flex justify-center">
						<canvas id="chart-top-products"></canvas>
					</div>
				</div>
				
				<button onclick="forceSwitchToClassic()" class="w-full bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold border border-indigo-100 text-sm">
					ğŸ“„ Xem danh sÃ¡ch chi tiáº¿t
				</button>
			</div>
		</div>
		
		<div id="admin-users" class="hidden flex-1 flex flex-col overflow-hidden bg-gray-50 h-full">
			<div class="p-3 bg-white border-b shadow-sm">
				<h3 class="font-bold text-gray-700">Danh sÃ¡ch tÃ i khoáº£n</h3>
				<p class="text-[10px] text-gray-400">Tráº¡ng thÃ¡i cáº­p nháº­t má»—i 30 giÃ¢y</p>
			</div>
			<div id="user-list" class="flex-1 overflow-y-auto p-3 space-y-2 pb-20">
				</div>
		</div>
		
		<div id="admin-system" class="hidden flex-1 flex flex-col bg-gray-50 h-full p-4 space-y-4 overflow-y-auto pb-20">
			<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
				<div class="flex justify-between items-center mb-4">
					<div>
						<h3 class="font-bold text-gray-800 text-lg">Giao diá»‡n Biá»ƒu Ä‘á»“ ğŸ“Š</h3>
						<p class="text-xs text-gray-500">Báº­t: Hiá»‡n biá»ƒu Ä‘á»“. Táº¯t: Hiá»‡n sá»‘ liá»‡u cÅ©.</p>
					</div>
					<label class="relative inline-flex items-center cursor-pointer">
						<input type="checkbox" id="sys-chart-toggle" class="sr-only peer">
						<div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
					</label>
				</div>
			
				<div class="flex justify-between items-center mb-4">
					<div>
						<h3 class="font-bold text-gray-800 text-lg">Cháº¿ Ä‘á»™ Báº£o trÃ¬ ğŸš§</h3>
						<p class="text-xs text-gray-500">Khi báº­t, chá»‰ Admin má»›i cÃ³ thá»ƒ Ä‘Äƒng nháº­p.</p>
					</div>
					<label class="relative inline-flex items-center cursor-pointer">
						<input type="checkbox" id="sys-maintenance-toggle" class="sr-only peer">
						<div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
					</label>
				</div>

				<div class="space-y-2 mb-4">
					<label class="text-xs font-bold text-gray-500 uppercase">ThÃ´ng bÃ¡o báº£o trÃ¬</label>
					<textarea id="sys-message" rows="2" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Nháº­p lá»i nháº¯n cho nhÃ¢n viÃªn..."></textarea>
				</div>

				<div class="flex justify-between items-center mb-4">
					<div>
						<h3 class="font-bold text-gray-800 text-lg">Cho phÃ©p In hÃ³a Ä‘Æ¡n ğŸ–¨ï¸</h3>
						<p class="text-xs text-gray-500">Há»i "In hÃ³a Ä‘Æ¡n?" sau khi thanh toÃ¡n.</p>
					</div>
					<label class="relative inline-flex items-center cursor-pointer">
						<input type="checkbox" id="sys-print-toggle" class="sr-only peer">
						<div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
					</label>
				</div>

				<div class="border-t my-4 pt-4">
					<h3 class="font-bold text-gray-800 text-lg mb-3">ThÃ´ng tin trÃªn HÃ³a Ä‘Æ¡n ğŸ§¾</h3>
					
					<div class="space-y-3">
						<div>
							<label class="text-xs font-bold text-gray-500 uppercase">TÃªn Cá»­a HÃ ng</label>
							<input type="text" id="sys-store-name" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none font-bold" placeholder="VD: Táº¡p HÃ³a CÃ´ Ba">
						</div>
						
						<div>
							<label class="text-xs font-bold text-gray-500 uppercase">Äá»‹a chá»‰</label>
							<input type="text" id="sys-store-address" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="VD: 123 ÄÆ°á»ng ABC, Quáº­n 1">
						</div>

						<div class="mt-3">
							<label class="text-xs font-bold text-gray-500 uppercase">Hotline / SÄT</label>
							<input type="text" id="sys-store-hotline" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none font-bold" placeholder="VD: Hotline: 0909.999.888">
						</div>

						<div class="grid grid-cols-2 gap-3">
							<div>
								<label class="text-xs font-bold text-gray-500 uppercase">Lá»i chÃ o cuá»‘i</label>
								<input type="text" id="sys-footer" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Cáº£m Æ¡n & Háº¹n gáº·p láº¡i!">
							</div>
							<div>
								<label class="text-xs font-bold text-gray-500 uppercase">ThÃ´ng tin Wifi</label>
								<input type="text" id="sys-wifi" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Wifi: ... / Pass: ...">
							</div>
						</div>
					</div>
				</div>

				<button onclick="saveSystemSettings()" class="mt-4 w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">LÆ¯U CÃ€I Äáº¶T</button>
			</div>
		</div>
    </div>

    <div id="payment-screen" class="hidden h-dvh w-full flex flex-col bg-gray-50 absolute inset-0 z-50">
        <div class="bg-white p-4 shadow-sm flex items-center gap-3 sticky top-0 z-20">
            <button onclick="backToScan()" class="group w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 shadow-sm text-gray-500 hover:text-blue-600 hover:border-blue-200 active:scale-95 transition-all -ml-1 mr-2">
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:-translate-x-0.5 transition-transform">
					<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
				</svg>
			</button>
            <h2 class="font-bold text-lg">Thanh toÃ¡n</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3 pb-40" id="cart-list"></div>
        <div class="sticky bottom-0 z-30 bg-white p-5 border-t rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] pb-[env(safe-area-inset-bottom)]">
			<div class="flex flex-col items-center justify-center mb-6 border-b border-dashed pb-6">
				<span class="text-gray-400 font-bold text-xs uppercase tracking-widest mb-1">Tá»•ng tiá»n cáº§n thu</span>
				<span id="final-total" class="text-5xl font-bold text-blue-600 tracking-tight">0Ä‘</span>
			</div>
			<div class="mb-4">
				<div class="flex justify-between mb-1">
					<label class="text-xs font-bold text-gray-400 uppercase">KhÃ¡ch Ä‘Æ°a</label>
					<button onclick="setExactMoney()" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">Nháº­p Ä‘Ãºng sá»‘ tiá»n</button>
				</div>
				<div class="relative">
					<input 
						type="number" 
						id="money-received" 
						placeholder="0" 
						class="w-full bg-gray-100 p-3 pr-12 rounded-xl text-xl font-bold text-gray-800 outline-none focus:ring-2 focus:ring-blue-500 transition-all" 
						oninput="calculateChange()"
					>
					
					<button 
						id="btn-clear-money"
						onclick="clearMoneyInput()" 
						class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-200 transition-colors"
						tabindex="-1"
					>
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
							<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
						</svg>
					</button>
				</div>
				<div class="flex gap-2 mt-2 overflow-x-auto pb-1 no-scrollbar">
					<button onclick="addMoney(500000)" class="bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap active:bg-green-100">+500k</button>
					<button onclick="addMoney(200000)" class="bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap active:bg-green-100">+200k</button>
					<button onclick="addMoney(100000)" class="bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap active:bg-green-100">+100k</button>
					<button onclick="addMoney(50000)" class="bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap active:bg-green-100">+50k</button>
				</div>
			</div>
			<div class="flex justify-between items-center bg-orange-50 p-3 rounded-xl border border-orange-100 mb-4">
				<span class="text-orange-800 font-bold text-sm">Tiá»n thá»«a:</span>
				<span id="change-amount" class="text-2xl font-bold text-orange-600">0Ä‘</span>
			</div>
			
			<button onclick="processPayment()" 
				id="btn-confirm-pay" 
				class="w-full bg-gray-200 text-gray-400 p-4 rounded-xl font-bold text-lg shadow-none transition-all duration-300 flex justify-center items-center gap-2 group">
				XÃC NHáº¬N THANH TOÃN
			</button>
		</div>
    </div>

    <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
		<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg h-[85vh] flex flex-col overflow-hidden">
			<div class="p-4 border-b flex justify-between items-center bg-gray-50">
				<h3 class="font-bold text-gray-800">Lá»‹ch sá»­ giao dá»‹ch</h3>
				<button onclick="document.getElementById('history-modal').classList.add('hidden'); document.getElementById('history-detail-panel').classList.add('hidden')" class="text-2xl text-gray-400">Ã—</button>
			</div>
			<div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-100"></div>
		</div>
	</div>

	<div id="history-detail-panel" class="hidden fixed bottom-0 left-0 w-full h-[70vh] bg-white rounded-t-2xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] flex flex-col z-[60] transition-transform duration-300">
		<div class="p-4 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-2xl">
			<div>
				<h4 class="font-bold text-lg" id="hist-detail-id">#Order</h4>
				<p class="text-xs opacity-80" id="hist-detail-time">...</p>
			</div>
			<button onclick="document.getElementById('history-detail-panel').classList.add('hidden')" class="bg-white/20 hover:bg-white/30 p-2 rounded-full">â–¼</button>
		</div>
		
		<div class="flex-1 overflow-y-auto p-0">
			<table class="w-full history-table table-fixed"> <thead>
					<tr class="text-gray-500 border-b">
						<th class="w-[45%] text-left py-2 font-bold">TÃªn SP / MÃ£</th>
						
						<th class="w-[10%] text-right py-2 font-bold">SL</th>
						
						<th class="w-[20%] text-right py-2 font-bold">GiÃ¡</th>
						
						<th class="w-[25%] text-right py-2 font-bold">Tá»•ng</th>
					</tr>
				</thead>
				<tbody id="hist-detail-items"></tbody>
			</table>
		</div>
		
		<div id="hist-detail-footer" class="p-4 bg-gray-50 border-t space-y-2"></div>
    </div>

    <div id="recall-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-orange-50 rounded-t-xl"><h3 class="font-bold text-orange-800">Giao dá»‹ch chá»</h3><button onclick="document.getElementById('recall-modal').classList.add('hidden')" class="text-2xl text-gray-400">Ã—</button></div>
            <div id="parked-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        </div>
    </div>

    <div id="product-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col max-h-[90vh]">
            <div class="p-4 border-b font-bold text-lg">ThÃ´ng tin sáº£n pháº©m</div>
            <div class="p-4 overflow-y-auto space-y-3">
				<input type="hidden" id="prod-id">
				
				<div>
					<label class="text-xs font-bold text-gray-500">TÃªn SP *</label>
					<input type="text" id="prod-name" class="w-full border p-2 rounded focus:ring-1 focus:ring-blue-500">
				</div>

				<div class="grid grid-cols-2 gap-2">
					<div><label class="text-xs font-bold text-gray-500">MÃ£ váº¡ch</label><input type="text" id="prod-barcode" class="w-full border p-2 rounded"></div>
					<div><label class="text-xs font-bold text-blue-600">MÃ£ Item</label><input type="text" id="prod-itemcode" class="w-full border p-2 rounded border-blue-200 bg-blue-50"></div>
				</div>

				<div class="grid grid-cols-2 gap-2">
					<div><label class="text-xs font-bold text-gray-500">ÄÆ¡n vá»‹ tÃ­nh</label><input type="text" id="prod-unit" class="w-full border p-2 rounded"></div>
					<div>
						<label class="text-xs font-bold text-purple-600">Tá»“n kho ğŸ“¦</label>
						<input type="number" id="prod-quantity" class="w-full border-2 border-purple-200 bg-purple-50 p-2 rounded font-bold text-purple-700">
					</div>
				</div>

				<div class="grid grid-cols-2 gap-2">
					<div><label class="text-xs font-bold text-gray-500">GiÃ¡ bÃ¡n *</label><input type="number" id="prod-price" class="w-full border p-2 rounded"></div>
					<div><label class="text-xs font-bold text-red-500">GiÃ¡ KM</label><input type="number" id="prod-sale" class="w-full border p-2 rounded bg-red-50"></div>
				</div>
				
				<div><label class="text-xs font-bold text-gray-500">Link áº¢nh</label><input type="text" id="prod-image" class="w-full border p-2 rounded"></div>
			</div>
            <div class="p-4 border-t grid grid-cols-2 gap-3"><button onclick="document.getElementById('product-modal').classList.add('hidden')" class="bg-gray-100 text-gray-600 py-2 rounded font-bold">Há»§y</button><button onclick="saveProduct()" class="bg-blue-600 text-white py-2 rounded font-bold">LÆ°u</button></div>
        </div>
    </div>
	
	<div id="custom-alert" class="hidden fixed inset-0 flex items-center justify-center modal-overlay p-4">
		<div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-enter flex flex-col">
			<div id="alert-header" class="p-6 pb-2 text-center">
				<div id="alert-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl bg-blue-50 text-blue-600">â„¹ï¸</div>
				<h3 id="alert-title" class="text-xl font-bold text-gray-800">ThÃ´ng bÃ¡o</h3>
			</div>
			<div class="px-6 pb-6 text-center"><p id="alert-msg" class="text-gray-500">Ná»™i dung...</p></div>
			<div class="grid grid-cols-2 gap-0 border-t bg-gray-50" id="alert-actions"></div>
		</div>
	</div>

	<div id="qr-modal" class="hidden fixed inset-0 z-[70] bg-black bg-opacity-60 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
		<div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm flex flex-col items-center relative animate-popIn">
			
			<button onclick="closeQRModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center transition">
				âœ•
			</button>

			<h3 class="font-bold text-xl text-gray-800 mb-1">Tháº» NhÃ¢n ViÃªn</h3>
			<p class="text-xs text-gray-400 mb-6">DÃ¹ng Ä‘á»ƒ Ä‘Äƒng nháº­p nhanh</p>

			<div class="bg-white p-3 border-2 border-dashed border-gray-300 rounded-xl mb-4">
				<div id="qr-code-container"></div>
			</div>

			<div class="text-center mb-6">
				<p class="text-xs font-bold text-gray-500 uppercase tracking-wider">TÃ i khoáº£n</p>
				<p id="qr-user-email" class="font-bold text-blue-600 text-lg"></p>
			</div>

			<div class="flex gap-2 w-full">
				<button onclick="downloadQR()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-1">
					â¬‡ï¸ LÆ°u
				</button>

				<button onclick="printQR()" class="flex-1 bg-gray-800 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-1">
					ğŸ–¨ï¸ In
				</button>
				
				<button onclick="closeQRModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold active:scale-95 transition-transform">
					ÄÃ³ng
				</button>
			</div>
		</div>
	</div>

	<div id="password-input-modal" class="hidden fixed inset-0 z-[9999] bg-black bg-opacity-60 flex items-center justify-center p-4 backdrop-blur-sm">
		<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm animate-popIn relative z-[10000]" onclick="event.stopPropagation()">
			<h3 class="font-bold text-lg text-gray-800 mb-2">ğŸ”’ XÃ¡c thá»±c Admin</h3>
			<p class="text-sm text-gray-500 mb-4">Vui lÃ²ng nháº­p máº­t kháº©u cá»§a nhÃ¢n viÃªn Ä‘á»ƒ táº¡o mÃ£ QR Ä‘Äƒng nháº­p.</p>
			
			<!--<input type="password" id="qr-password-input" 
				   class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none mb-4 select-text text-gray-900 bg-white" 
				   placeholder="Nháº­p máº­t kháº©u..." autocomplete="off">-->
			<input 
				type="password" 
				id="qr-password-input" 
				class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none mb-4 select-text text-gray-900 bg-white" 
				placeholder="Nháº­p máº­t kháº©u..." 
				autocomplete="off"
				enterkeyhint="go" 
			>
			<div class="flex gap-3 justify-end">
				<button onclick="closePassModal()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200">Há»§y</button>
				<button onclick="submitQRPassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700">Táº¡o MÃ£</button>
			</div>
		</div>
	</div>

	<div id="scan-settings-modal" class="hidden fixed inset-0 z-[80] bg-black bg-opacity-60 flex items-center justify-center p-4 backdrop-blur-sm">
		<div class="bg-white rounded-2xl shadow-2xl p-5 w-full max-w-sm animate-popIn">
			<div class="flex justify-between items-center mb-4 border-b pb-2">
				<h3 class="font-bold text-lg text-gray-800">âš™ï¸ CÃ i Ä‘áº·t NÃºt QuÃ©t</h3>
				<button onclick="document.getElementById('scan-settings-modal').classList.add('hidden')" class="text-gray-400 text-xl">âœ•</button>
			</div>

			<div class="space-y-3">
				
				<label class="flex items-center justify-between p-3 border rounded-xl cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
					<div class="flex items-center gap-3">
						<span class="text-xl">ğŸ”³</span>
						<div>
							<div class="font-bold text-gray-800 text-sm">NÃºt to giá»¯a mÃ n hÃ¬nh</div>
							<div class="text-[10px] text-gray-500">Giao diá»‡n gá»‘c (KhÃ´ng cÃ³ nÃºt nhá»)</div>
						</div>
					</div>
					<input type="radio" name="scan_mode" value="default" class="w-5 h-5 text-blue-600" onchange="saveScanMode('default')">
				</label>

				<label class="flex items-center justify-between p-3 border rounded-xl cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
					<div class="flex items-center gap-3">
						<span class="text-blue-600">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
							  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z" />
							  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75zM6.75 16.5h.75v.75h-.75v-.75zM16.5 6.75h.75v.75h-.75v-.75zM13.5 13.5h.75v.75h-.75v-.75zM13.5 19.5h.75v.75h-.75v-.75zM19.5 13.5h.75v.75h-.75v-.75zM16.5 16.5h.75v.75h-.75v-.75zM16.5 19.5h.75v.75h-.75v-.75z" />
							</svg>
						</span>
						
						<div>
							<div class="font-bold text-gray-800 text-sm">NÃºt nhá»: Táº¯t / Má»Ÿ</div>
							<div class="text-[10px] text-gray-500">NÃºt nhá» cáº¡nh Ã´ nháº­p. áº¨n nÃºt to.</div>
						</div>
					</div>
					<input type="radio" name="scan_mode" value="toggle" class="w-5 h-5 text-blue-600" onchange="saveScanMode('toggle')">
				</label>

				<label class="flex items-center justify-between p-3 border rounded-xl cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
					<div class="flex items-center gap-3">
						<span class="text-xl">ğŸ‘†</span>
						<div>
							<div class="font-bold text-gray-800 text-sm">NÃºt nhá»: Giá»¯ Ä‘á»ƒ quÃ©t</div>
							<div class="text-[10px] text-gray-500">Giá»¯ tay camera báº­t. áº¨n nÃºt to.</div>
						</div>
					</div>
					<input type="radio" name="scan_mode" value="hold" class="w-5 h-5 text-blue-600" onchange="saveScanMode('hold')">
				</label>
			</div>

			<div class="mt-6">
				<button onclick="document.getElementById('scan-settings-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">ÄÃ³ng</button>
			</div>
		</div>
	</div>

	<div id="return-modal" class="hidden fixed inset-0 z-[80] bg-black bg-opacity-60 flex items-center justify-center p-4 backdrop-blur-sm">
		<div class="bg-white rounded-xl shadow-2xl p-5 w-full max-w-xs animate-popIn">
			<h3 class="font-bold text-lg text-red-600 mb-2">ğŸ”„ Tráº£ HÃ ng & HoÃ n Tiá»n</h3>
			<p class="text-sm text-gray-500 mb-4" id="return-item-name">TÃªn sáº£n pháº©m...</p>
			
			<div class="mb-4">
				<label class="text-xs font-bold text-gray-400 uppercase">Sá»‘ lÆ°á»£ng tráº£</label>
				<div class="flex items-center gap-2 mt-1">
					<button onclick="adjustReturnQty(-1)" class="w-10 h-10 bg-gray-100 rounded-lg font-bold text-xl text-gray-600">-</button>
					<input type="number" id="return-qty-input" class="flex-1 bg-gray-50 border border-gray-200 h-10 rounded-lg text-center font-bold text-lg outline-none focus:border-red-500" value="1">
					<button onclick="adjustReturnQty(1)" class="w-10 h-10 bg-gray-100 rounded-lg font-bold text-xl text-gray-600">+</button>
				</div>
				<p class="text-[10px] text-gray-400 mt-1 text-right">ÄÃ£ mua: <span id="return-max-qty">0</span></p>
			</div>

			<div class="bg-orange-50 p-3 rounded-lg border border-orange-100 mb-4 text-center">
				<span class="text-xs text-orange-600 font-bold block">Sá»‘ tiá»n cáº§n hoÃ n láº¡i khÃ¡ch:</span>
				<span id="return-refund-amt" class="text-xl font-bold text-orange-700">0Ä‘</span>
			</div>

			<div class="grid grid-cols-2 gap-3">
				<button onclick="closeReturnModal()" class="py-2 bg-gray-100 text-gray-600 rounded-lg font-bold">Há»§y</button>
				<button onclick="confirmReturn()" class="py-2 bg-red-600 text-white rounded-lg font-bold shadow-md hover:bg-red-700">XÃ¡c Nháº­n</button>
			</div>
		</div>
	</div>
	
	<div id="receipt-print-area" class="hidden print:block bg-white text-black p-1 text-xs font-mono leading-tight">
		<div class="text-center mb-2">
			<h2 class="text-xl font-bold uppercase" id="rec-store-name">MINI POS</h2>
			<p id="rec-address">123 ÄÆ°á»ng ABC, Quáº­n XYZ</p>
			<p id="rec-hotline">Hotline: 0909.123.456</p>
			<p id="rec-is-copy" class="hidden font-bold text-[10px] mt-0.5">(Báº¢N SAO)</p>
		</div>

		<div class="border-b border-black border-dashed pb-1 mb-1">
			<div class="flex justify-between"><span>ÄÆ¡n:</span> <span id="rec-id" class="font-bold">#---</span></div>
			<div class="flex justify-between"><span>NgÃ y:</span> <span id="rec-time">--/--/--</span></div>
			<div class="flex justify-between"><span>NV:</span> <span id="rec-staff">---</span></div>
		</div>

		<div class="border-b border-black border-dashed pb-1 mb-1">
			<table class="w-full text-left">
				<thead>
					<tr>
						<th class="w-[45%]">TÃªn sáº£n pháº©m</th>
						<th class="w-[15%] text-center">SL</th>
						<th class="w-[20%] text-right">GiÃ¡</th>
						<th class="w-[20%] text-right">ThÃ nh tiá»n</th>
					</tr>
				</thead>
				<tbody id="rec-items-list">
					</tbody>
			</table>
		</div>

		<div class="flex justify-between font-bold text-sm mt-1">
			<span>Tá»”NG Cá»˜NG:</span>
			<span id="rec-total">0Ä‘</span>
		</div>
		
		<div class="flex justify-between mt-1 text-[10px]">
			<span>KhÃ¡ch Ä‘Æ°a:</span>
			<span id="rec-cash">0Ä‘</span>
		</div>
		
		<div class="flex justify-between mb-2 text-[10px]">
			<span>Tiá»n thá»«a:</span>
			<span id="rec-change">0Ä‘</span>
		</div>

		<div class="text-center border-t border-black border-dashed pt-2">
			<p class="italic" id="rec-footer-1">Cáº£m Æ¡n & Háº¹n gáº·p láº¡i!</p>
			
			<p class="text-[10px] mt-1" id="rec-footer-2">Wifi: MiniPOS / Pass: 12345678</p>
		</div>
	</div>
    <script>
        const SUPABASE_URL = 'https://renqusdcczlhrglbclhe.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlbnF1c2RjY3psaHJnbGJjbGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTIyMzUsImV4cCI6MjA4MDU4ODIzNX0.kF960FS-VvAM2rkNo9kVHfmGAkpwrmlZ5Vf9-QFiC2E';
        
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
			auth: {
				storage: sessionStorage,
				autoRefreshToken: true,
				persistSession: true,
				detectSessionInUrl: true
			}
		});
        const PLACEHOLDER_IMG = "data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2250%22%20height%3D%2250%22%20viewBox%3D%220%200%2050%2050%22%3E%3Crect%20width%3D%2250%22%20height%3D%2250%22%20fill%3D%22%23e5e7eb%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22sans-serif%22%20font-size%3D%2212%22%20fill%3D%22%239ca3af%22%3EIMG%3C%2Ftext%3E%3C%2Fsvg%3E";

        let productsDB = [];

		let cart = JSON.parse(localStorage.getItem('pos_current_cart')) || []; 
		let parkedOrders = JSON.parse(localStorage.getItem('pos_parked_orders')) || [];
		
        let html5QrcodeScanner = null, currentUserEmail = "", currentMultiplier = 1, currentUserRole = "staff";
		
		let lastScannedCode = null;
		let lastScanTime = 0;
		const SCAN_DELAY = 2000;
		let globalSettings = { 
			allow_print: true, 
			enable_charts: true,
			// GiÃ¡ trá»‹ máº·c Ä‘á»‹nh phÃ²ng khi chÆ°a táº£i Ä‘Æ°á»£c
			store_name: "Cá»¬A HÃ€NG MINI POS",
			store_address: "Há»“ ChÃ­ Minh, Viá»‡t Nam",
			receipt_footer: "Cáº£m Æ¡n & Háº¹n gáº·p láº¡i!",
			wifi_info: "Wifi: MiniPOS / Pass: 12345678",
			store_hotline: "Hotline: 0909.123.456"
		};
		let myChart1 = null; 
		let myChart2 = null;

		// --- LOGIC KIá»‚M TRA GIÃ Má»šI ---
		let isCheckPriceMode = false;

		function toggleCheckPriceMode() {
			isCheckPriceMode = !isCheckPriceMode;
			
			const salesPanel = document.getElementById('sales-panel');
			const checkPanel = document.getElementById('check-price-panel');
			const scanFrame = document.querySelector('.border-green-400'); // Khung quÃ©t (náº¿u cÃ³)
			
			if (isCheckPriceMode) {
				// Báº­t cháº¿ Ä‘á»™ xem giÃ¡
				salesPanel.classList.add('hidden');
				checkPanel.classList.remove('hidden');
				document.getElementById('check-price-input').focus();
				
				// Äá»•i mÃ u khung quÃ©t sang mÃ u Teal cho dá»… nháº­n biáº¿t (náº¿u muá»‘n)
				showAlert("ÄÃ£ báº­t cháº¿ Ä‘á»™ xem giÃ¡", "Má»i mÃ£ quÃ©t lÃºc nÃ y sáº½ chá»‰ hiá»‡n giÃ¡.", "info");
			} else {
				// Táº¯t cháº¿ Ä‘á»™, quay vá» bÃ¡n hÃ ng
				salesPanel.classList.remove('hidden');
				checkPanel.classList.add('hidden');
				
				// Reset káº¿t quáº£
				document.getElementById('check-result-container').innerHTML = `
					<div class="opacity-50 grayscale">
						<div class="text-5xl mb-2">ğŸ·ï¸</div>
						<p class="text-gray-400 text-sm">Má»i quÃ©t sáº£n pháº©m...</p>
					</div>`;
			}
		}

		// HÃ m xá»­ lÃ½ nháº­p tay á»Ÿ cháº¿ Ä‘á»™ xem giÃ¡
		function handleCheckPriceManual(e) {
			if (e.key === 'Enter') {
				const val = e.target.value.trim();
				if (val) processCheckPrice(val);
				e.target.value = '';
				e.target.blur();
			}
		}

		// HÃ m hiá»ƒn thá»‹ káº¿t quáº£ (Render vÃ o khung bÃªn dÆ°á»›i)
		function processCheckPrice(key) {
			const k = key.trim().toLowerCase();
			const p = productsDB.find(x => (x.barcode == k || (x.item_code && x.item_code.toLowerCase() == k))) || productsDB.find(x => x.name.toLowerCase().includes(k));
			
			const el = document.getElementById('check-result-container');
			
			if (!p) {
				el.innerHTML = `<div class="text-5xl mb-2">ğŸ¤·â€â™‚ï¸</div><h3 class="text-red-500 font-bold text-xl">KhÃ´ng tÃ¬m tháº¥y!</h3><p class="text-xs text-gray-400">MÃ£: ${key}</p>`;
				// PhÃ¡t Ã¢m thanh lá»—i náº¿u cáº§n
				if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
				return;
			}

			// Náº¿u tÃ¬m tháº¥y -> Hiá»ƒn thá»‹ Ä‘áº¹p
			let priceHtml = '';
			if (p.sale_price && p.sale_price < p.price) {
				priceHtml = `
					<div class="flex items-end gap-2 justify-center mt-1">
						<span class="text-gray-400 line-through text-lg font-medium">${formatMoney(p.price)}</span>
						<span class="text-red-600 font-bold text-4xl font-display">${formatMoney(p.sale_price)}</span>
					</div>
					<span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold mt-2 inline-block animate-pulse">ğŸ”¥ Äang giáº£m giÃ¡</span>`;
			} else {
				priceHtml = `<div class="text-teal-600 font-bold text-4xl mt-2 font-display">${formatMoney(p.price)}</div>`;
			}

			el.innerHTML = `
				<div class="flex gap-4 items-center w-full text-left">
					<img src="${p.image || PLACEHOLDER_IMG}" class="w-24 h-24 object-cover rounded-xl shadow-sm border border-gray-100 bg-white">
					<div class="flex-1">
						<h3 class="font-bold text-gray-800 text-lg leading-tight line-clamp-2">${p.name}</h3>
						<div class="flex gap-2 mt-1">
							<span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold border">MÃ£: ${p.barcode || '---'}</span>
							<span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold border">ÄVT: ${p.unit || 'CÃ¡i'}</span>
						</div>
					</div>
				</div>
				<div class="mt-2 w-full border-t border-dashed border-teal-100 pt-2 text-center">
					${priceHtml}
					${p.is_locked ? '<div class="mt-2 text-red-500 font-bold text-xs bg-red-50 p-2 rounded border border-red-100">ğŸ”’ Sáº¢N PHáº¨M ÄANG KHÃ“A</div>' : ''}
				</div>
			`;
			
			if(navigator.vibrate) navigator.vibrate(50);
		}

        // === SYSTEM FUNCTIONS ===
        async function checkSession() {
			try {
				const { data: { session }, error } = await client.auth.getSession();
				if (error) throw error;
				
				if (session) {
					currentUserEmail = session.user.email;
					
					// 1. Láº¥y Role trÆ°á»›c
					await fetchUserRole(currentUserEmail); 

					// 2. --- KIá»‚M TRA Báº¢O TRÃŒ NGAY SAU KHI CÃ“ ROLE ---
					const { data: settings } = await client.from('app_settings').select('*').eq('id', 1).single();
					
					if (settings && settings.maintenance_mode && currentUserRole !== 'admin') {
						showAlert("Báº¢O TRÃŒ", settings.maintenance_message || "Há»‡ thá»‘ng Ä‘ang báº£o trÃ¬.", 'error', () => {
							forceLogout();
						});
						return; // Dá»«ng láº¡i, khÃ´ng cho vÃ o App
					}
					// ------------------------------------------------

					// Náº¿u qua Ä‘Æ°á»£c cá»­a áº£i trÃªn thÃ¬ má»›i vÃ o App
					document.getElementById('user-email').innerText = currentUserEmail.split('@')[0];
					document.getElementById('login-screen').classList.add('hidden'); 
					document.getElementById('scan-screen').classList.remove('hidden');
					
					fetchProducts();
					fetchSystemSettings();
					updateParkedBadge();
					updateCartUI();
					startHeartbeat();
				}
			} catch (err) { console.log(err); forceLogout(); }
		}
        async function handleLogin() {
			// 1. Láº¥y giÃ¡ trá»‹ vÃ  TRIM (xÃ³a khoáº£ng tráº¯ng thá»«a Ä‘áº§u Ä‘uÃ´i)
			const email = document.getElementById('email').value.trim();
			const password = document.getElementById('password').value.trim();

			// 2. Kiá»ƒm tra náº¿u Ä‘á»ƒ trá»‘ng thÃ¬ bÃ¡o lá»—i ngay, khÃ´ng gá»­i lÃªn server
			if (!email || !password) {
				document.getElementById('login-msg').innerText = "âš ï¸ Vui lÃ²ng nháº­p Ä‘á»§ Email vÃ  Máº­t kháº©u!";
				return;
			}

			// 3. Gá»­i yÃªu cáº§u Ä‘Äƒng nháº­p
			const { error } = await client.auth.signInWithPassword({ email, password });

			if (error) {
				console.error("Lá»—i Ä‘Äƒng nháº­p:", error); // Xem lá»—i chi tiáº¿t trong Console (F12)
				
				// Dá»‹ch má»™t sá»‘ lá»—i phá»• biáº¿n sang tiáº¿ng Viá»‡t
				if (error.message.includes("Invalid login credentials")) {
					document.getElementById('login-msg').innerText = "âŒ Sai Email hoáº·c Máº­t kháº©u!";
				} else if (error.message.includes("Email not confirmed")) {
					document.getElementById('login-msg').innerText = "ğŸ“§ Email chÆ°a Ä‘Æ°á»£c xÃ¡c thá»±c (Vui lÃ²ng táº¯t Confirm Email trong Supabase)";
				} else {
					document.getElementById('login-msg').innerText = "âŒ Lá»—i: " + error.message;
				}
			} else {
				checkSession();
			}
		}
        async function forceLogout() { await client.auth.signOut(); localStorage.clear(); window.location.reload(); }
        
        async function fetchUserRole(email) {
			try {
				const { data } = await client
					.from('app_users') 
					.select('role')
					.eq('email', email)
					.maybeSingle(); // DÃ¹ng maybeSingle cho an toÃ n

				currentUserRole = data ? data.role : 'staff';
				
				// Cáº­p nháº­t giao diá»‡n ngay láº­p tá»©c
				if(currentUserRole === 'admin') {
					document.getElementById('btn-open-admin').classList.remove('hidden');
				} else {
					document.getElementById('btn-open-admin').classList.add('hidden');
				}
			} catch (e) { console.log(e); }
		}

        // ======================= CUSTOM MODAL LOGIC (TRÃI TIM UI Má»šI) =======================
        let modalCallback = null;

        function showAlert(title, msg, type = 'info', callback = null) {
            const modal = document.getElementById('custom-alert');
            const iconEl = document.getElementById('alert-icon');
            const actionsEl = document.getElementById('alert-actions');
            
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerHTML = msg;
            modalCallback = callback;

            // Cáº¥u hÃ¬nh giao diá»‡n theo loáº¡i thÃ´ng bÃ¡o
            let iconHtml = 'â„¹ï¸', colorClass = 'bg-blue-50 text-blue-600', btnsHtml = '';

            if (type === 'success') {
                iconHtml = 'âœ…'; colorClass = 'bg-green-50 text-green-600';
                btnsHtml = `<button onclick="closeAlert()" class="col-span-2 py-4 text-green-600 font-bold hover:bg-green-50">ÄÃ³ng</button>`;
            } else if (type === 'error') {
                iconHtml = 'âš ï¸'; colorClass = 'bg-red-50 text-red-600';
                btnsHtml = `<button onclick="closeAlert()" class="col-span-2 py-4 text-red-600 font-bold hover:bg-red-50">ÄÃ³ng</button>`;
            } else if (type === 'confirm') {
                iconHtml = 'â“'; colorClass = 'bg-orange-50 text-orange-600';
                btnsHtml = `
                    <button onclick="closeAlert()" class="py-4 text-gray-500 font-semibold hover:bg-gray-100 border-r">Há»§y</button>
                    <button onclick="confirmAction()" class="py-4 text-blue-600 font-bold hover:bg-blue-50">Äá»“ng Ã½</button>`;
            } else {
                btnsHtml = `<button onclick="closeAlert()" class="col-span-2 py-4 text-blue-600 font-bold hover:bg-blue-50">OK</button>`;
            }

            iconEl.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl ${colorClass}`;
            iconEl.innerHTML = iconHtml;
            actionsEl.innerHTML = btnsHtml;
            modal.classList.remove('hidden');
        }

        function closeAlert() {
            document.getElementById('custom-alert').classList.add('hidden');
            modalCallback = null;
        }

        function confirmAction() {
            if (modalCallback) modalCallback();
            closeAlert();
        }

        // ======================= APP LOGIC =======================

        async function fetchProducts() {
            let { data, error } = await client.from('products').select('*').order('created_at', { ascending: false });
            if (error) { const res = await client.from('products').select('*'); data = res.data; }
            if (data) { productsDB = data; renderProductList(); }
        }

        // --- SCANNER Má»šI (NATIVE + WASM) ---
        let isScanning = false;
        let barcodeDetector = null;
        let scanStream = null;

        // HÃ m khá»Ÿi táº¡o bá»™ giáº£i mÃ£ (Cháº¡y 1 láº§n duy nháº¥t)
        async function initBarcodeDetector() {
            if (barcodeDetector) return barcodeDetector;

            const formats = ['qr_code', 'ean_13', 'code_128', 'code_39', 'upc_a', 'upc_e'];
            
            // Æ¯u tiÃªn dÃ¹ng Native (Chrome Android/macOS)
            if ('BarcodeDetector' in window) {
                try {
                    const nativeDetector = new window.BarcodeDetector({ formats });
                    // Kiá»ƒm tra xem native cÃ³ há»— trá»£ Ä‘á»‹nh dáº¡ng cÆ¡ báº£n khÃ´ng
                    const supported = await window.BarcodeDetector.getSupportedFormats();
                    if (supported.includes('qr_code')) {
                        console.log('Using Native Barcode Detector âš¡');
                        barcodeDetector = nativeDetector;
                        return barcodeDetector;
                    }
                } catch (e) { console.log('Native detector failed, switching to polyfill...'); }
            }

            // Fallback sang Polyfill (Wasm) náº¿u Native khÃ´ng cÃ³
            if (window.BarcodeDetectorPolyfill) {
                console.log('Using Wasm Barcode Detector ğŸ“¦');
                barcodeDetector = new window.BarcodeDetectorPolyfill({ formats });
            }
            return barcodeDetector;
        }

        async function startScanner() {
            // 1. Cháº·n náº¿u Ä‘ang quÃ©t
            if (isScanning) return;
            
            // 2. áº¨n giao diá»‡n chá»
            document.getElementById('camera-placeholder').classList.add('hidden');
            const btnStop = document.getElementById('btn-stop-cam');
            if(btnStop) btnStop.classList.remove('hidden');

            const videoEl = document.getElementById('scan-video');
            const canvasEl = document.getElementById('scan-canvas');
            const ctx = canvasEl.getContext('2d', { willReadFrequently: true });

            try {
                // 3. Khá»Ÿi táº¡o Detector
                const detector = await initBarcodeDetector();
                if (!detector) throw new Error("KhÃ´ng thá»ƒ khá»Ÿi táº¡o bá»™ quÃ©t mÃ£.");

                // 4. Má»Ÿ Camera (Full HD Ä‘á»ƒ báº¯t mÃ£ váº¡ch tá»‘t hÆ¡n)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 }, 
                        height: { ideal: 1080 },
                        focusMode: "continuous" // Há»— trá»£ Android láº¥y nÃ©t
                    }
                });
                
                scanStream = stream;
                videoEl.srcObject = stream;
                await videoEl.play();
                isScanning = true;

                // 5. VÃ²ng láº·p quÃ©t (Loop)
                const renderLoop = async () => {
                    if (!isScanning || videoEl.paused || videoEl.ended) return;

                    // Váº½ láº¡i canvas Ä‘á»ƒ khá»›p kÃ­ch thÆ°á»›c video
                    if (canvasEl.width !== videoEl.videoWidth) {
                        canvasEl.width = videoEl.videoWidth;
                        canvasEl.height = videoEl.videoHeight;
                    }

                    try {
                        const codes = await detector.detect(videoEl);
                        
                        // XÃ³a khung váº½ cÅ©
                        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);

                        if (codes.length > 0) {
                            const code = codes[0]; // Láº¥y mÃ£ Ä‘áº§u tiÃªn
                            
                            // Váº½ khung Ä‘á» bao quanh mÃ£
                            const { x, y, width, height } = code.boundingBox;
                            ctx.strokeStyle = "#00ff00"; // MÃ u xanh lÃ¡
                            ctx.lineWidth = 4;
                            ctx.strokeRect(x, y, width, height);

                            // --- LOGIC Xá»¬ LÃ Káº¾T QUáº¢ (Báº¢N Sá»¬A Lá»–I) ---
                            const currentTime = Date.now();
                            
                            // Chá»‘ng quÃ©t láº·p láº¡i (Debounce 1.5 giÃ¢y)
                            if (code.rawValue !== lastScannedCode || (currentTime - lastScanTime > 1500)) {
                                lastScannedCode = code.rawValue;
                                lastScanTime = currentTime;
                                
                                playBeepSound();

                                // 1. XÃ¡c Ä‘á»‹nh Ã´ Input Ä‘ang hoáº¡t Ä‘á»™ng (BÃ¡n hÃ ng hoáº·c Check giÃ¡)
                                let activeInput = null;
                                if (typeof isCheckPriceMode !== 'undefined' && isCheckPriceMode) {
                                    activeInput = document.getElementById('check-price-input');
                                } else {
                                    activeInput = document.getElementById('manual-input');
                                }

                                // 2. Náº¿u tÃ¬m tháº¥y Ã´ Input -> Äiá»n dá»¯ liá»‡u vÃ  táº¡o hiá»‡u á»©ng
                                if (activeInput) {
                                    console.log("ÄÃ£ Ä‘iá»n mÃ£:", code.rawValue); // Kiá»ƒm tra log (F12)
                                    
                                    activeInput.value = code.rawValue;
                                    activeInput.focus(); // Focus vÃ o Ã´ Ä‘á»ƒ tháº¥y con trá»
                                    
                                    // ThÃªm hiá»‡u á»©ng nhÃ¡y vÃ ng Ä‘á»ƒ dá»… nhÃ¬n tháº¥y
                                    const oldBg = activeInput.style.backgroundColor;
                                    activeInput.style.transition = "background-color 0.2s";
                                    activeInput.style.backgroundColor = "#fef08a"; // MÃ u vÃ ng nháº¡t
                                    
                                    // Sau 0.5s thÃ¬ tráº£ láº¡i mÃ u cÅ© (KHÃ”NG XÃ“A TEXT)
                                    setTimeout(() => {
                                        activeInput.style.backgroundColor = oldBg || "";
                                        // LÆ°u Ã½: MÃ¬nh Ä‘Ã£ bá» dÃ²ng activeInput.value = '' Ä‘á»ƒ báº¡n nhÃ¬n tháº¥y mÃ£
                                    }, 500);
                                } else {
                                    console.error("KhÃ´ng tÃ¬m tháº¥y Ã´ nháº­p liá»‡u (Input)!");
                                }

                                // 3. Gá»­i dá»¯ liá»‡u Ä‘i xá»­ lÃ½ (ThÃªm vÃ o giá» hÃ ng)
                                try {
                                    addToCart(code.rawValue);
                                } catch (err) {
                                    console.error("Lá»—i thÃªm giá» hÃ ng:", err);
                                    showAlert("Lá»—i", "MÃ£ Ä‘á»c Ä‘Æ°á»£c nhÆ°ng khÃ´ng thÃªm Ä‘Æ°á»£c: " + err.message, "error");
                                }
                            }
                        }
                    } catch (err) {
                        // Lá»—i detect thÆ°á»ng do camera chÆ°a load xong frame, cÃ³ thá»ƒ bá» qua
                    }

                    requestAnimationFrame(renderLoop);
                };

                renderLoop();

            } catch (err) {
                console.error("Lá»—i Camera:", err);
                showAlert("Lá»—i Camera", "KhÃ´ng thá»ƒ truy cáº­p camera. Vui lÃ²ng cáº¥p quyá»n hoáº·c thá»­ láº¡i.", 'error');
                stopScanner();
            }
        }

        async function stopScanner() {
            isScanning = false;
            
            // Dá»«ng camera
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }

            const videoEl = document.getElementById('scan-video');
            if (videoEl) videoEl.srcObject = null;

            // XÃ³a khung váº½
            const canvasEl = document.getElementById('scan-canvas');
            if (canvasEl) {
                const ctx = canvasEl.getContext('2d');
                ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
            }

            // Cáº­p nháº­t UI
            if (currentScanMode === 'default') {
                document.getElementById('camera-placeholder').classList.remove('hidden'); 
            } else {
                document.getElementById('camera-placeholder').classList.add('hidden');
            }
            document.getElementById('btn-stop-cam').classList.add('hidden');
        }

        // --- CART ---
        function addToCart(key) {
			// 1. Cháº¿ Ä‘á»™ xem giÃ¡
			if (isCheckPriceMode) {
				processCheckPrice(key);
				return; 
			}

			const k = key.trim().toLowerCase(); if(!k) return;
			
			// 2. TÃ¬m sáº£n pháº©m
			const p = productsDB.find(x => (x.barcode==k || (x.item_code && x.item_code.toLowerCase()==k))) || productsDB.find(x => x.name.toLowerCase().includes(k));
			
			if(!p) return showAlert("KhÃ´ng tÃ¬m tháº¥y", `KhÃ´ng cÃ³ sáº£n pháº©m nÃ o khá»›p vá»›i mÃ£ "${key}"`, 'error');
			
			// 3. Kiá»ƒm tra khÃ³a sáº£n pháº©m
			if(p.is_locked) return showAlert("Sáº£n pháº©m khÃ³a", "Sáº£n pháº©m nÃ y Ä‘ang táº¡m ngÆ°ng kinh doanh.", 'error');

			// 4. KIá»‚M TRA Tá»’N KHO
			if ((p.quantity || 0) <= 0) {
				return showAlert("Háº¿t hÃ ng", `Sáº£n pháº©m "${p.name}" Ä‘Ã£ háº¿t hÃ ng trong kho!`, 'error');
			}
			
			// TÃ¬m xem mÃ³n nÃ y Ä‘Ã£ cÃ³ trong giá» chÆ°a
			// (Láº§n khai bÃ¡o Ä‘áº§u tiÃªn - Giá»¯ nguyÃªn)
			const exist = cart.find(x => x.id === p.id);
			
			// Logic kiá»ƒm tra sá»‘ lÆ°á»£ng tá»“n kho so vá»›i giá» hÃ ng
			const currentQtyInCart = exist ? exist.quantity : 0;
			if (currentQtyInCart + currentMultiplier > p.quantity) {
					return showAlert("KhÃ´ng Ä‘á»§ hÃ ng", `Trong kho chá»‰ cÃ²n ${p.quantity}, báº¡n Ä‘ang mua quÃ¡ sá»‘ lÆ°á»£ng!`, 'error');
			}
			
			// 5. ThÃªm vÃ o giá»
			const qty = currentMultiplier;
			const price = (p.sale_price && p.sale_price < p.price) ? p.sale_price : p.price;
			
			if(exist) {
				// --- ÄÃƒ Sá»¬A: á» Ä‘Ã¢y khÃ´ng dÃ¹ng 'const exist =' ná»¯a mÃ  dÃ¹ng trá»±c tiáº¿p biáº¿n exist Ä‘Ã£ tÃ¬m tháº¥y á»Ÿ trÃªn ---
				exist.quantity += qty; 
			} else {
				cart.push({...p, quantity: qty, finalPrice: price});
			}
			
			// 6. Cáº­p nháº­t giao diá»‡n & Hiá»‡u á»©ng
			updateCartUI();
			
			document.getElementById('last-item-name').innerText = p.name;
			document.getElementById('last-item-info').innerText = `MÃ£: ${p.barcode || '---'} | ÄVT: ${p.unit || '---'}`;
			const priceEl = document.getElementById('last-item-price-container');
			if(p.sale_price && p.sale_price < p.price) { 
				priceEl.innerHTML = `<span class="line-through text-gray-400 text-xs mr-2">${formatMoney(p.price)}</span><span class="text-red-600 font-bold text-sm">${formatMoney(p.sale_price)}</span>`; 
			} else { 
				priceEl.innerHTML = `<span class="font-bold text-blue-600 text-sm">${formatMoney(p.price)}</span>`; 
			}
			document.getElementById('last-item-qty').innerText = "+" + qty;
			
			document.getElementById('last-scanned-card').classList.remove('hidden', 'scan-success'); 
			void document.getElementById('last-scanned-card').offsetWidth; 
			document.getElementById('last-scanned-card').classList.add('scan-success');
			
			if(currentMultiplier > 1) { currentMultiplier = 1; document.getElementById('multiplier-badge').classList.add('hidden'); }
			if(navigator.vibrate) navigator.vibrate(100);
		}

        function updateCartUI() {
			// 1. TÃ­nh toÃ¡n
			const totalQty = cart.reduce((s, i) => s + i.quantity, 0);
			const totalMoney = cart.reduce((s, i) => s + (i.quantity * i.finalPrice), 0);

			// 2. Láº¥y cÃ¡c pháº§n tá»­
			const btn = document.getElementById('btn-cart-payment');
			const badge = document.getElementById('quick-count');
			const totalText = document.getElementById('quick-total');

			// 3. Cáº­p nháº­t Text
			// Logic náº£y sá»‘: XÃ³a class cÅ© -> Äá»£i xÃ­u -> ThÃªm láº¡i class Ä‘á»ƒ nÃ³ cháº¡y láº¡i animation
			badge.classList.remove('badge-pop');
			void badge.offsetWidth; // Hack: Ã‰p trÃ¬nh duyá»‡t render láº¡i Ä‘á»ƒ reset animation
			badge.classList.add('badge-pop');
			
			badge.innerText = totalQty;
			totalText.innerText = formatMoney(totalMoney) + " âœ";
			
			localStorage.setItem('pos_current_cart', JSON.stringify(cart));

			// 4. --- LOGIC GIAO DIá»†N CAO Cáº¤P ---
			if (btn && badge) {
				if (totalQty > 0) {
					// === CÃ“ HÃ€NG: MÃ€U GRADIENT & PHÃT SÃNG ===
					
					// XÃ³a style xÃ¡m
					btn.classList.remove('bg-gray-200', 'text-gray-400', 'shadow-none', 'pointer-events-none');
					
					// ThÃªm Gradient + BÃ³ng + Hiá»‡u á»©ng nhá»‹p Ä‘áº­p (pulse)
					// bg-gradient-to-r from-blue-600 to-blue-500: Táº¡o mÃ u chuyá»ƒn sáº¯c
					btn.classList.add(
						'bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', // MÃ u chuyá»ƒn sáº¯c
						'text-white', 
						'shadow-lg', 'shadow-blue-500/50', // BÃ³ng Ä‘á»• mÃ u xanh má»
						'cursor-pointer',
						'cart-active-pulse' // Class tá»± táº¡o á»Ÿ BÆ°á»›c 1
					);
					
					// Badge mÃ u tráº¯ng má» sang trá»ng
					badge.className = "bg-white/20 px-3 py-1 rounded-lg text-sm font-bold backdrop-blur-md border border-white/20 badge-pop";

				} else {
					// === GIá» TRá»NG: XÃM CHÃŒM ===
					
					// Reset toÃ n bá»™ class xá»‹n
					btn.className = "w-full bg-gray-100 text-gray-400 p-4 rounded-2xl font-bold text-xl shadow-inner flex justify-between items-center transition-all duration-300 pointer-events-none border border-gray-200";
					
					// Badge mÃ u tá»‘i
					badge.className = "bg-gray-200 px-3 py-1 rounded-lg text-sm text-gray-400";
				}
			}
		}

        // --- PAYMENT ---
        function goToPayment() {
            if(cart.length==0) return showAlert("Giá» hÃ ng trá»‘ng", "Vui lÃ²ng quÃ©t thÃªm sáº£n pháº©m trÆ°á»›c khi thanh toÃ¡n.", 'info');
			
			history.pushState({view: 'payment'}, "Thanh toÃ¡n", "#payment");
			
            if(html5QrcodeScanner) html5QrcodeScanner.pause();
            document.getElementById('scan-screen').classList.add('hidden'); document.getElementById('payment-screen').classList.remove('hidden');
            renderPaymentList();
        }
        function backToScan() {
            document.getElementById('payment-screen').classList.add('hidden'); document.getElementById('scan-screen').classList.remove('hidden');
            if(html5QrcodeScanner) html5QrcodeScanner.resume();
			
			history.back();
        }
        function renderPaymentList() {
            document.getElementById('cart-list').innerHTML = cart.map((i, idx) => `
                <div class="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm">
                    <div class="flex-1">
                        <div class="font-bold text-gray-800">${i.name}</div>
                        <div class="text-[11px] text-gray-500 font-semibold mb-1">MÃ£: ${i.barcode || '---'} | ÄVT: ${i.unit || '---'}</div>
                        <div class="text-sm text-blue-600 font-bold">${formatMoney(i.finalPrice)} x ${i.quantity} = ${formatMoney(i.finalPrice * i.quantity)}</div>
                    </div>
                    <div class="flex items-center gap-3 ml-2">
                        <button onclick="changeQty(${idx}, -1)" class="w-9 h-9 bg-gray-100 rounded-lg font-bold text-gray-600 active:bg-gray-200">-</button>
                        <span class="font-bold w-6 text-center text-lg">${i.quantity}</span>
                        <button onclick="changeQty(${idx}, 1)" class="w-9 h-9 bg-blue-100 text-blue-600 rounded-lg font-bold active:bg-blue-200">+</button>
                    </div>
                </div>`).join('');
            const total = cart.reduce((s,i) => s + (i.quantity * i.finalPrice), 0);
            document.getElementById('final-total').innerText = formatMoney(total);
            calculateChange();
        }
        
        function changeQty(idx, d) { 
            const newQty = cart[idx].quantity + d;
            if (newQty <= 0) {
                showAlert("XÃ³a sáº£n pháº©m", `Báº¡n muá»‘n xÃ³a "${cart[idx].name}" khá»i giá»?`, 'confirm', () => {
                    cart.splice(idx, 1);
                    finalizeChangeQty();
                });
            } else {
                cart[idx].quantity = newQty;
                finalizeChangeQty();
            }
        }
        function finalizeChangeQty() {
            updateCartUI();
            if (cart.length === 0) backToScan(); else renderPaymentList();
            const feedbackCard = document.getElementById('last-scanned-card');
            if(feedbackCard) feedbackCard.classList.add('hidden');
        }

		// --- HÃ€M XÃ“A Táº¤T Cáº¢ Sáº¢N PHáº¨M ---
		async function deleteAllProducts() {
			showAlert(
				"Cáº¢NH BÃO", 
				"Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n XÃ“A Sáº CH toÃ n bá»™ danh sÃ¡ch hÃ ng hÃ³a? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ khÃ´i phá»¥c!", 
				'confirm', 
				async () => {
					// XÃ³a táº¥t cáº£ dÃ²ng cÃ³ ID khÃ¡c 0 (nghÄ©a lÃ  xÃ³a háº¿t)
					const { error } = await client.from('products').delete().neq('id', 0);
					
					if (error) {
						showAlert("Lá»—i", "KhÃ´ng thá»ƒ xÃ³a: " + error.message, 'error');
					} else {
						showAlert("ÄÃ£ xÃ³a", "Dá»¯ liá»‡u hÃ ng hÃ³a Ä‘Ã£ Ä‘Æ°á»£c dá»n sáº¡ch.", 'success');
						fetchProducts(); // Táº£i láº¡i danh sÃ¡ch trá»‘ng
					}
				}
			);
		}

        function calculateChange() {
			// 1. TÃ­nh toÃ¡n
			const total = cart.reduce((s, i) => s + (i.quantity * i.finalPrice), 0);
			const inputVal = document.getElementById('money-received').value;
			const received = parseInt(inputVal) || 0;
			const change = received - total;

			// --- LOGIC Má»šI: áº¨N/HIá»†N NÃšT X ---
			const btnClear = document.getElementById('btn-clear-money');
			if (btnClear) {
				// Náº¿u cÃ³ giÃ¡ trá»‹ vÃ  giÃ¡ trá»‹ khÃ¡c 0 thÃ¬ hiá»‡n, ngÆ°á»£c láº¡i thÃ¬ áº©n
				if (inputVal && received !== 0) {
					btnClear.classList.remove('hidden');
				} else {
					btnClear.classList.add('hidden');
				}
			}
			// --------------------------------

			// 2. Hiá»ƒn thá»‹ text tiá»n thá»«a/thiáº¿u
			const el = document.getElementById('change-amount');
			el.innerText = change < 0 ? "Thiáº¿u " + formatMoney(Math.abs(change)) : formatMoney(change);
			el.className = change < 0 ? "text-2xl font-bold text-red-600" : "text-2xl font-bold text-green-600";

			// 3. Logic Ä‘á»•i mÃ u nÃºt xÃ¡c nháº­n
			const btn = document.getElementById('btn-confirm-pay');
			if (btn) {
				if (change >= 0) {
					btn.classList.remove('bg-gray-200', 'text-gray-400', 'shadow-none', 'bg-red-50', 'text-red-500');
					btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'shadow-blue-500/50', 'active:scale-[0.98]', 'cart-active-pulse');
					btn.innerHTML = `<span>XÃC NHáº¬N THANH TOÃN</span>`;
				} else {
					btn.className = "w-full p-4 rounded-xl font-bold text-lg transition-all duration-300 flex justify-center items-center gap-2 group";
					btn.classList.add('bg-red-50', 'text-red-400', 'shadow-inner', 'border', 'border-red-100');
					btn.innerHTML = `<span>CÃ’N THIáº¾U: ${formatMoney(Math.abs(change))}</span> <span class="animate-bounce"></span>`;
				}
			}
		}

		// HÃ m báº¥m nÃºt X
		function clearMoneyInput() {
			const input = document.getElementById('money-received');
			input.value = '';       
			input.focus();          
			calculateChange(); // Gá»i láº¡i hÃ m trÃªn Ä‘á»ƒ tÃ­nh láº¡i tiá»n vÃ  áº©n nÃºt X Ä‘i
		}
		
        function addMoney(n) { 
			const el=document.getElementById('money-received'); 
			el.value=(parseInt(el.value)||0)+n; 
			calculateChange(); 
		}
		
        function setExactMoney() { 
			document.getElementById('money-received').value = cart.reduce((s,i)=>s+(i.quantity*i.finalPrice),0); 
			calculateChange(); 
		}
        
        async function processPayment() {
			// 1. TÃ­nh toÃ¡n sá»‘ liá»‡u
			const t = cart.reduce((s, i) => s + (i.quantity * i.finalPrice), 0);
			const inputVal = document.getElementById('money-received').value;
			const r = parseInt(inputVal) || 0;

			// Kiá»ƒm tra tiá»n thiáº¿u
			if (r < t) {
				const missing = t - r;
				return showAlert("Thiáº¿u tiá»n", `KhÃ¡ch Ä‘Æ°a thiáº¿u ${formatMoney(missing)}. Vui lÃ²ng thu Ä‘á»§ tiá»n!`, 'error');
			}

			// 2. XÃ¡c nháº­n thanh toÃ¡n
			showAlert("Thanh toÃ¡n", "XÃ¡c nháº­n thanh toÃ¡n Ä‘Æ¡n hÃ ng nÃ y?", 'confirm', async () => {
				
				// --- Báº®T Äáº¦U Xá»¬ LÃ LÆ¯U DB ---
				const extra = { received_money: r, change_money: r - t };
				
				// A. Táº¡o Ä‘Æ¡n hÃ ng
				const { data: order, error } = await client.from('orders').insert({ 
					staff_email: currentUserEmail, 
					total_amount: t, 
					note: JSON.stringify(extra),
					returned_amount: 0 
				}).select().single();

				if (order) {
					// B. LÆ°u chi tiáº¿t mÃ³n
					const items = cart.map(i => ({ 
						order_id: order.id, 
						product_id: i.id, // LÆ°u ID Ä‘á»ƒ sau nÃ y tráº£ hÃ ng cho chuáº©n
						product_name: i.name, 
						quantity: i.quantity, 
						price: i.finalPrice, 
						total: i.quantity * i.finalPrice,
						returned_quantity: 0
					}));
					await client.from('order_items').insert(items);

					// C. Trá»« tá»“n kho
					const updatePromises = cart.map(item => {
						const originalProd = productsDB.find(p => p.id === item.id);
						if (!originalProd) return null;
						const newQty = Math.max(0, (originalProd.quantity || 0) - item.quantity);
						return client.from('products').update({ quantity: newQty }).eq('id', item.id);
					});
					await Promise.all(updatePromises);

					// --- QUAN TRá»ŒNG: CHUáº¨N Bá»Š Dá»® LIá»†U IN TRÆ¯á»šC KHI XÃ“A GIá» ---
					// Copy giá» hÃ ng hiá»‡n táº¡i ra má»™t biáº¿n riÃªng Ä‘á»ƒ in
					const printData = {
						id: order.id,
						time: new Date(),
						staff: currentUserEmail,
						items: [...cart], // Copy láº¡i danh sÃ¡ch mÃ³n
						total: t,
						received: r,
						change: r - t
					};

					// D. Xá»­ lÃ½ In & Dá»n dáº¹p
					// Kiá»ƒm tra cáº¥u hÃ¬nh: CÃ³ cho phÃ©p in khÃ´ng?
					if (globalSettings.allow_print) {
						showAlert(
							"Thanh toÃ¡n thÃ nh cÃ´ng âœ…", 
							`ÄÆ¡n hÃ ng #${order.id} Ä‘Ã£ Ä‘Æ°á»£c lÆ°u.<br>Báº¡n cÃ³ muá»‘n in hÃ³a Ä‘Æ¡n khÃ´ng?`, 
							'confirm', 
							() => {
								// Náº¿u báº¥m Äá»“ng Ã½ -> In hÃ³a Ä‘Æ¡n
								printReceipt(
									printData.id, 
									printData.time, 
									printData.staff, 
									printData.items, 
									printData.total, 
									printData.received, 
									printData.change
								);
								// In xong má»›i dá»n dáº¹p
								finishOrder();
							},
							// Náº¿u báº¥m Há»§y (KhÃ´ng in) -> CÅ©ng pháº£i dá»n dáº¹p Ä‘á»ƒ bÃ¡n Ä‘Æ¡n má»›i
							() => {
								finishOrder();
							}
						);
					} else {
						// Náº¿u táº¯t cháº¿ Ä‘á»™ in -> Dá»n dáº¹p luÃ´n
						showAlert("ThÃ nh cÃ´ng", "ÄÆ¡n hÃ ng Ä‘Ã£ lÆ°u & ÄÃ£ trá»« kho!", 'success');
						finishOrder();
					}
				}
			});
		}

		// HÃ m dá»n dáº¹p (tÃ¡ch ra Ä‘á»ƒ dÃ¹ng chung)
		function finishOrder() {
			cart = []; // XÃ³a giá» hÃ ng
			updateCartUI(); 
			document.getElementById('last-scanned-card').classList.add('hidden');
			document.getElementById('money-received').value = ''; // XÃ³a Ã´ tiá»n khÃ¡ch Ä‘Æ°a
			calculateChange(); // Reset tiá»n thá»«a vá» 0
			fetchProducts(); // Cáº­p nháº­t láº¡i tá»“n kho má»›i nháº¥t tá»« server
			backToScan(); // Quay vá» mÃ n hÃ¬nh bÃ¡n
		}

		// --- HÃ€M Xá»¬ LÃ PHÃM ENTER KHI ÄÄ‚NG NHáº¬P ---
		function handleLoginKey(e) {
			if (e.key === 'Enter') {
				handleLogin();
			}
		}

        // --- EXCEL & ADMIN ---
        function openAdminScreen() { 
			if(currentUserRole!=='admin') return showAlert("Tá»« chá»‘i", "Chá»‰ Admin má»›i cÃ³ quyá»n truy cáº­p!", 'error');

			history.pushState({view: 'admin'}, "Quáº£n lÃ½", "#admin");
			
			if(html5QrcodeScanner) html5QrcodeScanner.pause(); 
			document.getElementById('scan-screen').classList.add('hidden'); 
			document.getElementById('admin-screen').classList.remove('hidden'); 
			renderProductList(); 
		}
        function closeAdminScreen() { 
			document.getElementById('admin-screen').classList.add('hidden'); 
			document.getElementById('scan-screen').classList.remove('hidden'); 
			if(html5QrcodeScanner) html5QrcodeScanner.resume();

			history.back();
		}
        function switchAdminTab(t) {
			// --- PHáº¦N 1: Xá»¬ LÃ GIAO DIá»†N (UI) ---
			
			// 1. áº¨n ná»™i dung cá»§a Táº¤T Cáº¢ cÃ¡c tab
			document.getElementById('admin-products').classList.add('hidden');
			document.getElementById('admin-revenue').classList.add('hidden');
			document.getElementById('admin-users').classList.add('hidden'); // Äáº£m báº£o ID nÃ y tá»“n táº¡i bÃªn HTML
			
			// 2. Reset mÃ u nÃºt báº¥m vá» máº·c Ä‘á»‹nh (XÃ¡m/Tráº¯ng) cho Táº¤T Cáº¢ cÃ¡c nÃºt
			['products', 'revenue', 'users', 'system'].forEach(k => {
				document.getElementById('admin-'+k).classList.add('hidden');
				document.getElementById('tab-'+k).className = "flex-1 py-2.5 rounded-lg font-bold bg-white text-gray-500 border hover:bg-gray-50";
			});

			document.getElementById('admin-'+t).classList.remove('hidden');
			document.getElementById('tab-'+t).className = "flex-1 py-2.5 rounded-lg font-bold bg-blue-600 text-white shadow-sm";

			// 3. Hiá»‡n ná»™i dung tab Ä‘ang chá»n
			const targetContent = document.getElementById('admin-'+t);
			if(targetContent) targetContent.classList.remove('hidden');

			// 4. TÃ´ mÃ u xanh cho nÃºt Ä‘ang chá»n
			const targetBtn = document.getElementById('tab-'+t);
			if(targetBtn) targetBtn.className = "flex-1 py-2.5 rounded-lg font-bold bg-blue-600 text-white shadow-sm";


			// --- PHáº¦N 2: Xá»¬ LÃ Dá»® LIá»†U (DATA) ---

			// Logic riÃªng cho Tab NhÃ¢n viÃªn
			if (t === 'users') {
				fetchUserList();
			}
			
			// Logic riÃªng cho Tab Doanh thu
			else if (t === 'revenue') {
				// 1. Táº£i sá»‘ liá»‡u tá»•ng quan (Cards trÃªn cÃ¹ng)
				loadRevenue(); 

				// 2. [QUAN TRá»ŒNG] Khai bÃ¡o 2 biáº¿n giao diá»‡n (Báº N ÄANG THIáº¾U ÄOáº N NÃ€Y)
				const classicUI = document.getElementById('revenue-classic-ui');
				const chartUI = document.getElementById('revenue-chart-ui');

				// 3. Tá»± Ä‘á»™ng chá»n ngÃ y hÃ´m nay (Giá»¯ nguyÃªn code cá»§a báº¡n)
				const dateInput = document.getElementById('filter-start');
				if (dateInput && !dateInput.value) {
					const today = new Date().toISOString().split('T')[0];
					document.getElementById('filter-start').value = today;
					document.getElementById('filter-end').value = today;
					
					if(document.getElementById('report-start')) {
						 document.getElementById('report-start').value = today;
						 document.getElementById('report-end').value = today;
					}
				}

				// 4. Kiá»ƒm tra cÃ i Ä‘áº·t Ä‘á»ƒ chuyá»ƒn Ä‘á»•i giao diá»‡n
				// (ThÃªm kiá»ƒm tra 'classicUI' vÃ  'chartUI' tá»“n táº¡i Ä‘á»ƒ trÃ¡nh lá»—i null)
				if (globalSettings.enable_charts && classicUI && chartUI) {
					// == CHáº¾ Äá»˜ BIá»‚U Äá»’ ==
					classicUI.classList.add('hidden');
					chartUI.classList.remove('hidden');
					
					// Gá»i hÃ m váº½ biá»ƒu Ä‘á»“
					// (Kiá»ƒm tra hÃ m tá»“n táº¡i trÆ°á»›c khi gá»i Ä‘á»ƒ trÃ¡nh crash náº¿u chÆ°a copy hÃ m renderCharts)
					if (typeof renderCharts === 'function') renderCharts(); 
				} else {
					// == CHáº¾ Äá»˜ CÅ¨ (HOáº¶C FALLBACK) ==
					if(chartUI) chartUI.classList.add('hidden');
					if(classicUI) classicUI.classList.remove('hidden');
					
					// loadRevenue(); <--- XÃ“A DÃ’NG NÃ€Y (VÃ¬ Ä‘Ã£ gá»i á»Ÿ dÃ²ng Ä‘áº§u tiÃªn rá»“i, gá»i láº¡i bá»‹ thá»«a)
					viewRevenueDetail(); 
				}
			}
			
			else if (t === 'system') {
				fetchSystemSettings();
			}
			
			// Logic riÃªng cho Tab HÃ ng hÃ³a (Náº¿u cáº§n reload khi chuyá»ƒn tab)
			else if (t === 'products') {
				// fetchProducts(); // Báº­t dÃ²ng nÃ y náº¿u muá»‘n má»—i láº§n báº¥m vÃ o tab HÃ ng hÃ³a lÃ  táº£i láº¡i danh sÃ¡ch
			}
		}
		
		// 2. THÃŠM HÃ€M Má»šI: Váº¼ BIá»‚U Äá»’
		async function renderCharts() {
			// Há»§y biá»ƒu Ä‘á»“ cÅ© náº¿u cÃ³
			if (myChart1) { myChart1.destroy(); myChart1 = null; }
			if (myChart2) { myChart2.destroy(); myChart2 = null; }

			const end = new Date();
			const start = new Date();
			start.setDate(end.getDate() - 6); // LÃ¹i láº¡i 6 ngÃ y

			// --- Sá»¬A Lá»–I: Láº¥y cáº£ biáº¿n 'error' Ä‘á»ƒ kiá»ƒm tra ---
			const { data: orders, error } = await client
				.from('orders')
				.select('created_at, total_amount, returned_amount, order_items(product_name, quantity)')
				.gte('created_at', start.toISOString())
				.order('created_at', { ascending: true });

			// 1. Náº¾U CÃ“ Lá»–I Tá»ª SUPABASE -> BÃO NGAY
			if (error) {
				console.error("Lá»—i táº£i biá»ƒu Ä‘á»“:", error);
				// Náº¿u lá»—i lÃ  do chÆ°a liÃªn káº¿t báº£ng
				if (error.message.includes("Could not find a relationship")) {
					 showAlert("Lá»—i Cáº¥u TrÃºc", "Thiáº¿u liÃªn káº¿t khÃ³a ngoáº¡i giá»¯a báº£ng 'orders' vÃ  'order_items'.<br>Vui lÃ²ng cháº¡y láº¡i lá»‡nh SQL táº¡o khÃ³a ngoáº¡i.", 'error');
				} else {
					 showAlert("Lá»—i Dá»¯ Liá»‡u", "KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u biá»ƒu Ä‘á»“: " + error.message, 'error');
				}
				return;
			}

			if (!orders || orders.length === 0) {
				// KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng thÃ¬ thÃ´i, khÃ´ng váº½
				return;
			}

			// --- Xá»¬ LÃ Sá» LIá»†U BIá»‚U Äá»’ 1: DOANH THU 7 NGÃ€Y ---
			const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
			let labels = [];
			let dataRevenue = [];

			for (let i = 0; i < 7; i++) {
				let d = new Date(start);
				d.setDate(start.getDate() + i);
				let dayName = days[d.getDay()];
				
				labels.push(`${dayName} (${d.getDate()}/${d.getMonth()+1})`);
				
				let sum = orders
					.filter(o => new Date(o.created_at).toDateString() === d.toDateString())
					.reduce((acc, cur) => acc + (cur.total_amount - (cur.returned_amount || 0)), 0);
				dataRevenue.push(sum);
			}

			// --- Váº¼ BIá»‚U Äá»’ 1 ---
			const canvas1 = document.getElementById('chart-revenue-7days');
			if (canvas1) {
				const ctx1 = canvas1.getContext('2d');
				myChart1 = new Chart(ctx1, {
					type: 'line',
					data: {
						labels: labels,
						datasets: [{
							label: 'Doanh thu',
							data: dataRevenue,
							borderColor: '#4f46e5',
							backgroundColor: 'rgba(79, 70, 229, 0.1)',
							borderWidth: 2,
							tension: 0.3,
							fill: true,
							pointBackgroundColor: '#fff',
							pointBorderColor: '#4f46e5',
							pointRadius: 4
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: { legend: { display: false } },
						scales: { y: { beginAtZero: true } }
					}
				});
			}

			// --- Xá»¬ LÃ Sá» LIá»†U BIá»‚U Äá»’ 2: TOP Sáº¢N PHáº¨M ---
			let productCounts = {};
			orders.forEach(o => {
				// Kiá»ƒm tra ká»¹ o.order_items cÃ³ tá»“n táº¡i khÃ´ng trÆ°á»›c khi láº·p
				if (o.order_items && Array.isArray(o.order_items)) {
					o.order_items.forEach(item => {
						if (item.product_name && !item.product_name.startsWith('[ÄÃ£ tráº£]')) {
							productCounts[item.product_name] = (productCounts[item.product_name] || 0) + item.quantity;
						}
					});
				}
			});

			let sortedProducts = Object.entries(productCounts)
				.sort((a, b) => b[1] - a[1])
				.slice(0, 5);

			// --- Váº¼ BIá»‚U Äá»’ 2 ---
			const canvas2 = document.getElementById('chart-top-products');
			if (canvas2 && sortedProducts.length > 0) {
				const ctx2 = canvas2.getContext('2d');
				myChart2 = new Chart(ctx2, {
					type: 'doughnut',
					data: {
						labels: sortedProducts.map(p => p[0]),
						datasets: [{
							data: sortedProducts.map(p => p[1]),
							backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
							borderWidth: 0
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: { 
							legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } 
						}
					}
				});
			}
		}

		// HÃ m phá»¥ trá»£: NÃºt "Xem danh sÃ¡ch chi tiáº¿t" trong mÃ n hÃ¬nh biá»ƒu Ä‘á»“
		function forceSwitchToClassic() {
			// Táº¡m thá»i áº©n biá»ƒu Ä‘á»“, hiá»‡n danh sÃ¡ch
			document.getElementById('revenue-chart-ui').classList.add('hidden');
			document.getElementById('revenue-classic-ui').classList.remove('hidden');
			
			// Load dá»¯ liá»‡u báº£ng cÅ©
			const today = new Date().toISOString().split('T')[0];
			if(!document.getElementById('filter-start').value) {
				document.getElementById('filter-start').value = today;
				document.getElementById('filter-end').value = today;
			}
			loadRevenue();
			viewRevenueDetail();
		}
		
		// Táº£i danh sÃ¡ch User
		async function fetchUserList() {
			document.getElementById('user-list').innerHTML = '<div class="text-center py-4 text-gray-400">â³ Äang táº£i...</div>';
			
			// Sáº¯p xáº¿p: Admin lÃªn Ä‘áº§u, sau Ä‘Ã³ Ä‘áº¿n ngÆ°á»i má»›i online
			const { data: users, error } = await client
				.from('app_users')
				.select('*')
				.order('role', { ascending: true }) 
				.order('last_seen', { ascending: false });
			
			if (error) return showAlert("Lá»—i", error.message, 'error');

			document.getElementById('user-list').innerHTML = users.map(u => {
				// --- LOGIC TÃNH THá»œI GIAN (TIME AGO) ---
				const now = new Date();
				const lastSeen = new Date(u.last_seen);
				const diffMs = now - lastSeen; // ChÃªnh lá»‡ch tÃ­nh báº±ng Mili-giÃ¢y
				
				const seconds = Math.floor(diffMs / 1000);
				const minutes = Math.floor(seconds / 60);
				const hours   = Math.floor(minutes / 60);
				const days    = Math.floor(hours / 24);
				const months  = Math.floor(days / 30);
				const years   = Math.floor(days / 365);

				// 1. XÃ¡c Ä‘á»‹nh tráº¡ng thÃ¡i Online (Náº¿u < 2 phÃºt thÃ¬ coi lÃ  Online)
				const isOnline = minutes < 2;

				// 2. Táº¡o chuá»—i hiá»ƒn thá»‹ thá»i gian thÃ´ng minh
				let timeText = "";
				if (seconds < 60) {
					timeText = `${Math.max(0, seconds)} giÃ¢y trÆ°á»›c`;
				} else if (minutes < 60) {
					timeText = `${minutes} phÃºt trÆ°á»›c`;
				} else if (hours < 24) {
					timeText = `${hours} giá» trÆ°á»›c`;
				} else if (days < 30) {
					timeText = `${days} ngÃ y trÆ°á»›c`;
				} else if (months < 12) {
					timeText = `${months} thÃ¡ng trÆ°á»›c`;
				} else {
					timeText = `${years} nÄƒm trÆ°á»›c`;
				}

				// --- RENDER GIAO DIá»†N ---
				const statusHtml = isOnline 
					? `<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold border border-green-200 inline-flex items-center gap-1 w-fit">
						<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online
					   </span>`
					: `<span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] font-bold border inline-flex items-center w-fit">
						Offline ${timeText}
					   </span>`;

				// CÃ¡c nÃºt chá»©c nÄƒng
				const lockBtn = u.is_locked 
					? `<button onclick="setUserLock('${u.email}', false)" class="bg-green-100 text-green-600 px-3 py-2 rounded font-bold text-xs border border-green-200">Má»Ÿ</button>`
					: `<button onclick="setUserLock('${u.email}', true)" class="bg-gray-100 text-gray-500 px-3 py-2 rounded font-bold text-xs border border-gray-200">KhÃ³a</button>`;

				let roleBtn = "";
				if (u.role === 'admin') {
					roleBtn = `<button onclick="changeUserRole('${u.email}', 'staff')" class="bg-purple-100 text-purple-600 px-3 py-2 rounded font-bold text-xs border border-purple-200">â¬‡ï¸ Háº¡ cáº¥p</button>`;
				} else {
					roleBtn = `<button onclick="changeUserRole('${u.email}', 'admin')" class="bg-yellow-100 text-yellow-700 px-3 py-2 rounded font-bold text-xs border border-yellow-200">â­ Bá»• nhiá»‡m</button>`;
				}

				const cardBorder = u.role === 'admin' ? "border-purple-300 ring-1 ring-purple-100" : "border-gray-200";
				const bgAvatar = u.role === 'admin' ? "bg-purple-100 text-purple-600" : "bg-blue-50 text-blue-600";

				return `
				<div class="bg-white p-3 rounded-xl border ${cardBorder} shadow-sm flex flex-col gap-3 ${u.is_locked ? 'opacity-60 bg-gray-50' : ''}">
					<div class="flex justify-between items-start">
						<div class="flex items-center gap-3">
							<div class="w-10 h-10 rounded-full ${bgAvatar} flex items-center justify-center font-bold text-lg border">
								${u.email.charAt(0).toUpperCase()}
							</div>
							<div>
								<div class="font-bold text-gray-800 text-sm flex items-center gap-1">
									${u.email}
									${u.role === 'admin' ? '<span class="text-[9px] bg-purple-600 text-white px-1.5 rounded-full">ADMIN</span>' : ''}
								</div>
								<div class="mt-1">${statusHtml}</div>
							</div>
						</div>
					</div>
					
					<div class="flex gap-2 justify-end border-t pt-2 border-dashed">
						<button onclick="showUserQR('${u.email}')" class="bg-gray-800 text-white px-3 py-2 rounded font-bold text-xs border border-gray-600 shadow-sm">ğŸªª QR Login</button>
						${roleBtn}
						${lockBtn}
						<button onclick="kickUser('${u.email}')" class="bg-red-50 text-red-600 px-3 py-2 rounded font-bold text-xs border border-red-100">Kick âš¡</button>
					</div>
				</div>
				`;
			}).join('');
		}

		// Biáº¿n táº¡m Ä‘á»ƒ lÆ°u email Ä‘ang muá»‘n táº¡o QR
		let pendingQREmail = "";

		// 1. HÃ m Ä‘Æ°á»£c gá»i khi báº¥m nÃºt "QR" á»Ÿ danh sÃ¡ch nhÃ¢n viÃªn
		function showUserQR(email) {
			pendingQREmail = email; // LÆ°u láº¡i email
			
			// Reset Ã´ nháº­p vÃ  hiá»‡n Modal
			document.getElementById('qr-password-input').value = "";
			document.getElementById('password-input-modal').classList.remove('hidden');
			
			// Tá»± Ä‘á»™ng focus vÃ o Ã´ nháº­p cho tiá»‡n
			setTimeout(() => document.getElementById('qr-password-input').focus(), 100);
		}

		// 2. HÃ m Ä‘Ã³ng Modal nháº­p máº­t kháº©u
		function closePassModal() {
			document.getElementById('password-input-modal').classList.add('hidden');
			pendingQREmail = ""; // XÃ³a email táº¡m
		}

		// 3. HÃ m xá»­ lÃ½ khi báº¥m "Táº¡o MÃ£" (Logic chÃ­nh náº±m á»Ÿ Ä‘Ã¢y)
		function submitQRPassword() {
			const pass = document.getElementById('qr-password-input').value.trim();
			
			if (!pass) {
				showAlert("Lá»—i", "Vui lÃ²ng nháº­p máº­t kháº©u!", "error");
				return;
			}

			// --- Sá»¬A Lá»–I Táº I ÄÃ‚Y ---
			
			// 1. Láº¥y email ra biáº¿n cá»¥c bá»™ TRÆ¯á»šC
			const email = pendingQREmail;

			// 2. Sau Ä‘Ã³ má»›i Ä‘Ã³ng Modal (LÃºc nÃ y pendingQREmail bá»‹ xÃ³a cÅ©ng khÃ´ng sao)
			closePassModal();

			// -----------------------

			const jsonString = JSON.stringify({ action: "login", email: email, pass: pass });
			
			const modal = document.getElementById('qr-modal');
			const container = document.getElementById('qr-code-container');
			const emailLabel = document.getElementById('qr-user-email');

			if (!modal || !container) return;

			// Hiá»‡n Modal hiá»ƒn thá»‹ QR
			modal.classList.remove('hidden');
			emailLabel.innerText = email;
			container.innerHTML = ""; 

			setTimeout(() => {
				// Cáº¥u hÃ¬nh QR Code
				new QRCode(container, {
					text: jsonString,
					width: 250,
					height: 250,
					colorDark: "#000000",
					colorLight: "#ffffff",
					correctLevel: QRCode.CorrectLevel.H,
					
					// Logo (Base64 hoáº·c link áº£nh)
					logo: "mini_pos.png", 
					logoWidth: 60,
					logoHeight: 60,
					logoBackgroundColor: '#ffffff',
					logoBackgroundTransparent: false
				});
			}, 50);
		}

		function closeQRModal() {
			const modal = document.getElementById('qr-modal');
			if(modal) modal.classList.add('hidden');
		}

		function printQR() {
			const container = document.getElementById('qr-code-container');
			if(!container) return;
			
			const printContent = container.innerHTML;
			const email = document.getElementById('qr-user-email').innerText;
			
			const win = window.open('', '', 'height=600,width=600');
			win.document.write('<html><head><title>In Tháº»</title><style>body{text-align:center; font-family: sans-serif; padding:20px;} img{margin:0 auto; display:block;}</style></head><body>');
			win.document.write(`<h2>THáºº NHÃ‚N VIÃŠN</h2>${printContent}<h3>${email}</h3>`);
			win.document.write('</body></html>');
			win.document.close();
			win.print();
		}

		function downloadQR() {
			const container = document.getElementById('qr-code-container');
			const email = document.getElementById('qr-user-email').innerText || "user";
			
			// TÃ¬m tháº» Canvas (ThÆ° viá»‡n má»›i dÃ¹ng Canvas Ä‘á»ƒ váº½ cáº£ Logo)
			const canvas = container.querySelector('canvas');

			if (canvas) {
				// Chuyá»ƒn Canvas thÃ nh áº£nh
				const imageUrl = canvas.toDataURL("image/png");

				// Táº£i vá»
				const link = document.createElement('a');
				link.href = imageUrl;
				link.download = `QR_${email}.png`;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			} else {
				// Fallback: Náº¿u thÆ° viá»‡n lá»¡ render ra img (tÃ¹y trÃ¬nh duyá»‡t)
				const img = container.querySelector('img');
				if(img) {
					const link = document.createElement('a');
					link.href = img.src;
					link.download = `QR_${email}.png`;
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
				} else {
					showAlert("Lá»—i", 'ChÆ°a cÃ³ mÃ£ QR Ä‘á»ƒ lÆ°u!', "error");
				}
			}
		}

		// --- HÃ€M Bá»” NHIá»†M / Háº  Cáº¤P ---
		async function changeUserRole(email, newRole) {
			// 1. Cháº·n khÃ´ng cho tá»± thay Ä‘á»•i quyá»n cá»§a chÃ­nh mÃ¬nh (trÃ¡nh lá»¡ tay tá»± háº¡ cáº¥p rá»“i máº¥t quyá»n Admin)
			if (email === currentUserEmail) {
				return showAlert("Tá»« chá»‘i", "Báº¡n khÃ´ng thá»ƒ tá»± thay Ä‘á»•i quyá»n cá»§a chÃ­nh mÃ¬nh!", 'error');
			}

			// 2. XÃ¡c Ä‘á»‹nh ná»™i dung thÃ´ng bÃ¡o
			const title = newRole === 'admin' ? "Bá»• nhiá»‡m Quáº£n lÃ½" : "Háº¡ cáº¥p NhÃ¢n viÃªn";
			const msg = newRole === 'admin' 
				? `Báº¡n muá»‘n thÄƒng chá»©c cho ${email} thÃ nh ADMIN? (Há» sáº½ cÃ³ toÃ n quyá»n quáº£n lÃ½).`
				: `Báº¡n muá»‘n háº¡ cáº¥p ${email} xuá»‘ng thÃ nh NHÃ‚N VIÃŠN? (Há» sáº½ máº¥t quyá»n truy cáº­p trang Quáº£n lÃ½).`;

			// 3. Há»i xÃ¡c nháº­n
			showAlert(title, msg, 'confirm', async () => {
				// 4. Cáº­p nháº­t vÃ o Database
				const { error } = await client.from('app_users').update({ role: newRole }).eq('email', email);
				
				if (error) {
					showAlert("Lá»—i", "KhÃ´ng thá»ƒ cáº­p nháº­t: " + error.message, 'error');
				} else {
					showAlert("ThÃ nh cÃ´ng", `ÄÃ£ cáº­p nháº­t quyá»n cho ${email}`, 'success');
					fetchUserList(); // Táº£i láº¡i danh sÃ¡ch Ä‘á»ƒ tháº¥y thay Ä‘á»•i
				}
			});
		}

		// HÃ m KhÃ³a/Má»Ÿ khÃ³a
		async function setUserLock(email, lockStatus) {
			if (email === currentUserEmail) return showAlert("Lá»—i", "KhÃ´ng thá»ƒ tá»± khÃ³a chÃ­nh mÃ¬nh!", 'error');
			
			showAlert(lockStatus ? "KhÃ³a TK" : "Má»Ÿ khÃ³a", `Báº¡n muá»‘n ${lockStatus ? 'KHÃ“A' : 'Má» KHÃ“A'} tÃ i khoáº£n ${email}?`, 'confirm', async () => {
				await client.from('app_users').update({ is_locked: lockStatus }).eq('email', email);
				fetchUserList();
				showAlert("ThÃ nh cÃ´ng", "ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i.", 'success');
			});
		}

		// HÃ m Kick (Buá»™c Ä‘Äƒng xuáº¥t)
		async function kickUser(email) {
			if (email === currentUserEmail) return showAlert("Lá»—i", "KhÃ´ng thá»ƒ tá»± kick chÃ­nh mÃ¬nh!", 'error');

			showAlert("KÃ­ch tÃ i khoáº£n", `Buá»™c tÃ i khoáº£n ${email} Ä‘Äƒng xuáº¥t ngay láº­p tá»©c?`, 'confirm', async () => {
				await client.from('app_users').update({ force_logout: true }).eq('email', email);
				fetchUserList();
				showAlert("ÄÃ£ Kick", "NgÆ°á»i dÃ¹ng sáº½ bá»‹ vÄƒng ra trong vÃ²ng 30 giÃ¢y.", 'success');
			});
		}
		
		// --- HÃ€M XEM CHI TIáº¾T DOANH Sá» (Má»šI) ---
		async function viewRevenueDetail() {
			const startVal = document.getElementById('filter-start').value;
			const endVal = document.getElementById('filter-end').value;

			if (!startVal || !endVal) return showAlert("Thiáº¿u ngÃ y", "Vui lÃ²ng chá»n ngÃ y báº¯t Ä‘áº§u vÃ  káº¿t thÃºc", 'error');

			const d1 = new Date(startVal);
			const d2 = new Date(endVal);
			
			if (d2 < d1) return showAlert("Lá»—i ngÃ y", "NgÃ y káº¿t thÃºc pháº£i lá»›n hÆ¡n hoáº·c báº±ng ngÃ y báº¯t Ä‘áº§u", 'error');
			
			// Giá»›i háº¡n 31 ngÃ y
			const diffTime = Math.abs(d2 - d1);
			const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
			if (diffDays > 31) return showAlert("Giá»›i háº¡n", "Vui lÃ²ng chá»‰ xem tá»‘i Ä‘a 31 ngÃ y Ä‘á»ƒ Ä‘áº£m báº£o tá»‘c Ä‘á»™.", 'error');

			const startISO = new Date(startVal + 'T00:00:00').toISOString();
			const endISO = new Date(endVal + 'T23:59:59').toISOString();

			document.getElementById('revenue-list').innerHTML = '<div class="text-center py-8 text-gray-400 text-xs animate-pulse">â³ Äang táº£i dá»¯ liá»‡u...</div>';

			// Láº¥y dá»¯ liá»‡u tá»« Server
			const { data: orders, error } = await client
				.from('orders')
				.select('*')
				.gte('created_at', startISO)
				.lte('created_at', endISO)
				.order('created_at', { ascending: false });

			if (error) {
				document.getElementById('revenue-list').innerHTML = '<div class="text-center text-red-400 text-xs">Lá»—i táº£i dá»¯ liá»‡u</div>';
				return showAlert("Lá»—i", error.message, 'error');
			}

			if (!orders || orders.length === 0) {
				document.getElementById('revenue-list').innerHTML = '<div class="text-center py-10 text-gray-400 flex flex-col items-center"><span class="text-4xl mb-2">ğŸ“­</span><span>KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o</span></div>';
				document.getElementById('filter-count').innerText = "0 Ä‘Æ¡n";
				document.getElementById('filter-sum').innerText = "0Ä‘";
				return;
			}

			// --- [QUAN TRá»ŒNG] TÃNH Tá»”NG DOANH THU THá»°C Táº¾ ---
			// CÃ´ng thá»©c: Tá»•ng = (Tá»•ng tiá»n Ä‘Æ¡n - Tiá»n Ä‘Ã£ hoÃ n)
			const total = orders.reduce((sum, o) => sum + (o.total_amount - (o.returned_amount || 0)), 0);
			
			document.getElementById('filter-count').innerText = `${orders.length} Ä‘Æ¡n`;
			document.getElementById('filter-sum').innerText = formatMoney(total); // Cáº­p nháº­t sá»‘ tiá»n chuáº©n xÃ¡c lÃªn giao diá»‡n

			// Render Danh sÃ¡ch chi tiáº¿t
			document.getElementById('revenue-list').innerHTML = orders.map(o => {
				const noteSafe = encodeURIComponent(o.note || "");
				
				// TÃ­nh tiá»n thá»±c cá»§a Ä‘Æ¡n nÃ y Ä‘á»ƒ hiá»ƒn thá»‹ trong danh sÃ¡ch
				const realAmount = o.total_amount - (o.returned_amount || 0);
				
				// Hiá»ƒn thá»‹ thÃªm dÃ²ng ghi chÃº náº¿u cÃ³ tráº£ hÃ ng
				const refundNote = (o.returned_amount && o.returned_amount > 0) 
					? `<div class="text-[9px] text-red-500 font-bold bg-red-50 px-2 py-0.5 rounded inline-block text-right mt-1 border border-red-100">â†© ÄÃ£ hoÃ n: -${formatMoney(o.returned_amount)}</div>` 
					: '';

				// Náº¿u cÃ³ hoÃ n tiá»n thÃ¬ Ä‘á»•i mÃ u giÃ¡ tiá»n sang mÃ u cam Ä‘á»ƒ chÃº Ã½
				const priceColor = (o.returned_amount > 0) ? "text-orange-600" : "text-blue-600";

				return `
				<div onclick="viewHistoryDetail(${o.id}, ${o.total_amount}, '${o.created_at}', '${noteSafe}')" class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center active:bg-gray-50 transition-colors cursor-pointer mb-2">
					<div class="flex items-center gap-3">
						<div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-xs">#${o.id}</div>
						<div>
							<div class="text-xs font-bold text-gray-700">${new Date(o.created_at).toLocaleString('vi-VN')}</div>
							<div class="text-[10px] text-gray-400 flex items-center gap-1">
								<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> ${o.staff_email.split('@')[0]}
							</div>
						</div>
					</div>
					<div class="text-right flex flex-col items-end">
						<div class="text-sm font-bold ${priceColor} font-display">${formatMoney(realAmount)}</div>
						${refundNote}
					</div>
				</div>
				`;
			}).join('');
		}
		
		// --- HÃ€M XUáº¤T BÃO CÃO EXCEL ---
		async function exportRevenueReport() {
			const startStr = document.getElementById('filter-start').value;
			const endStr = document.getElementById('filter-end').value;

			if (!startStr || !endStr) return showAlert("Thiáº¿u thÃ´ng tin", "Vui lÃ²ng chá»n ngÃ y báº¯t Ä‘áº§u vÃ  káº¿t thÃºc!", 'error');

			// Táº¡o thá»i gian chuáº©n ISO (Tá»« 00:00:00 ngÃ y Ä‘áº§u -> 23:59:59 ngÃ y cuá»‘i)
			const startDate = new Date(startStr + 'T00:00:00').toISOString();
			const endDate = new Date(endStr + 'T23:59:59').toISOString();

			showAlert("Äang xá»­ lÃ½", "Äang táº£i dá»¯ liá»‡u bÃ¡o cÃ¡o...", 'info');

			// Láº¥y Ä‘Æ¡n hÃ ng KÃˆM THEO chi tiáº¿t sáº£n pháº©m (dÃ¹ng Query Relation cá»§a Supabase)
			const { data: orders, error } = await client
				.from('orders')
				.select('*, order_items(*)') 
				.gte('created_at', startDate)
				.lte('created_at', endDate)
				.order('created_at', { ascending: false });

			if (error) return showAlert("Lá»—i", error.message, 'error');
			if (!orders || orders.length === 0) return showAlert("Trá»‘ng", "KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o trong khoáº£ng thá»i gian nÃ y.", 'info');

			// Cháº¿ biáº¿n dá»¯ liá»‡u pháº³ng Ä‘á»ƒ Ä‘Æ°a vÃ o Excel
			const excelData = [];
			let totalRevenuePeriod = 0;

			orders.forEach(order => {
				const orderDate = new Date(order.created_at).toLocaleString('vi-VN');
				const staffName = order.staff_email.split('@')[0];
				
				// Náº¿u Ä‘Æ¡n hÃ ng cÃ³ sáº£n pháº©m con
				if (order.order_items && order.order_items.length > 0) {
					order.order_items.forEach(item => {
						excelData.push({
							"MÃ£ ÄÆ¡n": order.id,
							"NgÃ y Giá»": orderDate,
							"NhÃ¢n ViÃªn": staffName,
							"TÃªn Sáº£n Pháº©m": item.product_name,
							"Sá»‘ LÆ°á»£ng": item.quantity,
							"ÄÆ¡n GiÃ¡": item.price,
							"ThÃ nh Tiá»n (SP)": item.total,
							"Tá»•ng ÄÆ¡n HÃ ng": "" // Äá»ƒ trá»‘ng cho Ä‘áº¹p, Ä‘á»¡ rá»‘i máº¯t
						});
					});
					// ThÃªm 1 dÃ²ng tá»•ng káº¿t Ä‘Æ¡n (tÃ¹y chá»n, Ä‘á»ƒ dá»… nhÃ¬n trong Excel)
					excelData.push({
						"MÃ£ ÄÆ¡n": `Tá»•ng #${order.id}`,
						"NgÃ y Giá»": "", "NhÃ¢n ViÃªn": "", "TÃªn Sáº£n Pháº©m": "---", "Sá»‘ LÆ°á»£ng": "", "ÄÆ¡n GiÃ¡": "",
						"ThÃ nh Tiá»n (SP)": "",
						"Tá»•ng ÄÆ¡n HÃ ng": order.total_amount
					});
				} else {
					// TrÆ°á»ng há»£p hiáº¿m: Ä‘Æ¡n lá»—i khÃ´ng cÃ³ chi tiáº¿t
					excelData.push({
						"MÃ£ ÄÆ¡n": order.id,
						"NgÃ y Giá»": orderDate,
						"NhÃ¢n ViÃªn": staffName,
						"TÃªn Sáº£n Pháº©m": "(KhÃ´ng cÃ³ chi tiáº¿t)",
						"Sá»‘ LÆ°á»£ng": 0, "ÄÆ¡n GiÃ¡": 0, "ThÃ nh Tiá»n (SP)": 0,
						"Tá»•ng ÄÆ¡n HÃ ng": order.total_amount
					});
				}
				totalRevenuePeriod += order.total_amount;
			});

			// ThÃªm dÃ²ng tá»•ng doanh thu cuá»‘i cÃ¹ng cá»§a cáº£ Ä‘á»£t
			excelData.push({}); // DÃ²ng trá»‘ng cÃ¡ch ra
			excelData.push({
				"MÃ£ ÄÆ¡n": "Tá»”NG Cá»˜NG",
				"Tá»•ng ÄÆ¡n HÃ ng": totalRevenuePeriod
			});

			// Xuáº¥t file báº±ng SheetJS
			const ws = XLSX.utils.json_to_sheet(excelData);
			
			// Chá»‰nh Ä‘á»™ rá»™ng cá»™t cho Ä‘áº¹p
			ws['!cols'] = [{wch:10}, {wch:20}, {wch:15}, {wch:30}, {wch:10}, {wch:15}, {wch:15}, {wch:15}];

			const wb = XLSX.utils.book_new();
			XLSX.utils.book_append_sheet(wb, ws, "Bao_Cao_Chi_Tiet");
			
			// TÃªn file: DoanhThu_TuNgay_DenNgay.xlsx
			XLSX.writeFile(wb, `DoanhThu_${startStr}_${endStr}.xlsx`);
			
			closeAlert(); // Táº¯t thÃ´ng bÃ¡o
		}
		
        function renderProductList(search = "") {
			document.getElementById('admin-product-list').innerHTML = productsDB
				.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || 
							 (p.item_code && p.item_code.toLowerCase().includes(search.toLowerCase())) || 
							 (p.barcode && p.barcode.includes(search)))
				.map(p => {
					// Xá»­ lÃ½ hiá»ƒn thá»‹ giÃ¡
					let priceDisplay = `<div class="text-xs font-bold text-blue-600 mt-1">${formatMoney(p.price)}</div>`;
					if (p.sale_price && p.sale_price < p.price) {
						priceDisplay = `<div class="mt-1">
											<span class="text-gray-400 line-through text-[10px] mr-1">${formatMoney(p.price)}</span>
											<span class="text-red-600 font-bold text-xs">${formatMoney(p.sale_price)}</span>
										</div>`;
					}

					// Xá»­ lÃ½ tráº¡ng thÃ¡i khÃ³a
					const lockedClass = p.is_locked ? "locked-item" : "";
					const lockIcon = p.is_locked ? "ğŸ”“" : "ğŸ”’";
					const lockBtnColor = p.is_locked ? "bg-gray-500" : "bg-orange-500";

					// --- HTML TRáº¢ Vá»€ (ÄÃƒ Sá»¬A HÃ€NG Dá»ŒC) ---
					return `
					<div class="bg-white p-3 rounded-lg border flex justify-between items-center shadow-sm ${lockedClass}">
						
						<div class="flex items-center gap-3 flex-1">
							<img src="${p.image || PLACEHOLDER_IMG}" class="w-12 h-12 rounded bg-gray-100 object-cover shrink-0">
							<div>
								<div class="font-bold text-gray-800 text-sm line-clamp-1">
									${p.name} 
									${p.is_locked ? '<span class="text-[10px] text-red-500 bg-red-100 px-1 rounded ml-1">(ÄÃ£ khÃ³a)</span>' : ''}
								</div>
								
								<div class="flex flex-wrap gap-1 text-[10px] mt-1">
									<span class="bg-gray-100 px-1 rounded text-gray-500 border">MÃ£: ${p.barcode || '---'}</span>
									<span class="bg-gray-100 px-1 rounded text-gray-500 border">Item: ${p.item_code || '---'}</span>
									<span class="bg-gray-100 px-1 rounded text-gray-500 border">ÄVT: ${p.unit || '---'}</span>
									<span class="bg-purple-100 text-purple-700 px-1 rounded font-bold border border-purple-200">Kho: ${p.quantity || 0}</span>
								</div>
								
								${priceDisplay}
							</div>
						</div>

						<div class="flex flex-col gap-2 ml-3 shrink-0 py-1">
							<button onclick="toggleLock(${p.id}, ${p.is_locked})" class="${lockBtnColor} text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-sm transition active:scale-90">
								${lockIcon}
							</button>
							<button onclick="openProductModal(${p.id})" class="text-blue-600 bg-blue-50 border border-blue-100 w-9 h-9 rounded-lg flex items-center justify-center transition active:scale-90">
								âœï¸
							</button>
							<button onclick="deleteProduct(${p.id})" class="text-red-600 bg-red-50 border border-red-100 w-9 h-9 rounded-lg flex items-center justify-center transition active:scale-90">
								ğŸ—‘
							</button>
						</div>

					</div>`;
				}).join('');
		}
        async function toggleLock(id, status) {
            showAlert(status ? "Má»Ÿ khÃ³a" : "KhÃ³a sáº£n pháº©m", status ? "Báº¡n muá»‘n má»Ÿ bÃ¡n láº¡i?" : "Táº¡m ngÆ°ng bÃ¡n mÃ³n nÃ y?", 'confirm', async () => {
                await client.from('products').update({ is_locked: !status }).eq('id', id); fetchProducts();
            });
        }
        async function deleteProduct(id) {
            showAlert("XÃ³a sáº£n pháº©m", "HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c. XÃ³a?", 'confirm', async () => {
                await client.from('products').delete().eq('id', id); fetchProducts();
            });
        }
        function downloadTemplate() { 
			// ThÃªm cá»™t "Tá»“n kho" vÃ o tiÃªu Ä‘á» vÃ  dá»¯ liá»‡u máº«u
			const data = [
				["MÃ£ váº¡ch", "MÃ£ Item", "TÃªn sáº£n pháº©m", "GiÃ¡ bÃ¡n", "GiÃ¡ khuyáº¿n mÃ£i", "ÄÆ¡n vá»‹", "Tá»“n kho", "Link áº¢nh"], 
				["893...", "NC01", "VÃ­ dá»¥: NÆ°á»›c ngá»t", "10000", "8000", "Chai", "100", ""]
			]; 
			
			const wb = XLSX.utils.book_new(); 
			const ws = XLSX.utils.aoa_to_sheet(data); 
			
			// Chá»‰nh Ä‘á»™ rá»™ng cá»™t cho dá»… nhÃ¬n (TÃ¹y chá»n)
			ws['!cols'] = [{wch:15}, {wch:10}, {wch:30}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:20}];

			XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Hang"); 
			XLSX.writeFile(wb, "Mau_Nhap_Hang_POS.xlsx"); 
		}
        async function handleExcelUpload(e) {
			const file = e.target.files[0]; 
			if(!file) return;

			const reader = new FileReader();
			reader.onload = async function(e) {
				const data = new Uint8Array(e.target.result); 
				const workbook = XLSX.read(data, {type: 'array'}); 
				const sheetName = workbook.SheetNames[0]; 
				const worksheet = workbook.Sheets[sheetName]; 
				const jsonData = XLSX.utils.sheet_to_json(worksheet);

				if(jsonData.length === 0) return showAlert("Lá»—i", "File khÃ´ng cÃ³ dá»¯ liá»‡u!", 'error');

				// --- Cáº¬P NHáº¬T: ThÃªm trÆ°á»ng quantity (Tá»“n kho) ---
				const productsToInsert = jsonData.map(row => ({ 
					name: row["TÃªn sáº£n pháº©m"] || "Má»›i", 
					price: parseInt(row["GiÃ¡ bÃ¡n"]) || 0, 
					sale_price: row["GiÃ¡ khuyáº¿n mÃ£i"] ? parseInt(row["GiÃ¡ khuyáº¿n mÃ£i"]) : null, 
					barcode: row["MÃ£ váº¡ch"] ? String(row["MÃ£ váº¡ch"]) : null, 
					item_code: row["MÃ£ Item"] ? String(row["MÃ£ Item"]) : null, 
					unit: row["ÄÆ¡n vá»‹"] || "CÃ¡i", 
					image: row["Link áº¢nh"] || "",
					
					// Äá»c cá»™t "Tá»“n kho", náº¿u khÃ´ng cÃ³ hoáº·c Ä‘á»ƒ trá»‘ng thÃ¬ máº·c Ä‘á»‹nh lÃ  0
					quantity: parseInt(row["Tá»“n kho"]) || 0 
				}));

				showAlert("Nháº­p Excel", `TÃ¬m tháº¥y ${productsToInsert.length} sáº£n pháº©m. Tiáº¿n hÃ nh nháº­p?`, 'confirm', async () => {
					const { error } = await client.from('products').insert(productsToInsert);
					
					if(error) {
						showAlert("Lá»—i", error.message, 'error'); 
					} else { 
						showAlert("ThÃ nh cÃ´ng", "ÄÃ£ nháº­p hÃ ng vÃ  kho thÃ nh cÃ´ng!", 'success'); 
						fetchProducts(); 
					}
					document.getElementById('excel-upload').value = "";
				});
			}; 
			reader.readAsArrayBuffer(file);
		}

		async function openHistory() {
			document.getElementById('history-modal').classList.remove('hidden');

			// 1. Láº¥y 20 Ä‘Æ¡n gáº§n nháº¥t
			let { data: orders, error } = await client
				.from('orders')
				.select('*')
				.order('created_at', { ascending: false })
				.limit(20);

			// Fallback náº¿u lá»—i
			if (error) {
				const res = await client.from('orders').select('*').limit(20);
				orders = res.data;
			}

			// 2. Render danh sÃ¡ch (Logic Ä‘á»“ng bá»™ vá»›i Admin)
			document.getElementById('history-list').innerHTML = (orders || []).map(o => {
				const noteSafe = encodeURIComponent(o.note || "");
				
				// --- LOGIC TÃNH TOÃN (Giá»‘ng bÃªn Admin) ---
				// Láº¥y sá»‘ tiá»n Ä‘Ã£ hoÃ n láº¡i (náº¿u cÃ³)
				const returnedAmt = o.returned_amount || 0;
				
				// TÃ­nh doanh thu thá»±c táº¿ cá»§a Ä‘Æ¡n nÃ y
				const realTotal = o.total_amount - returnedAmt;

				// --- LOGIC HIá»‚N THá»Š ---
				// Náº¿u cÃ³ hoÃ n tiá»n: Hiá»‡n thÃªm tag mÃ u Ä‘á» vÃ  Ä‘á»•i mÃ u giÃ¡ tiá»n
				const refundTag = returnedAmt > 0 
					? `<div class="text-[10px] text-red-500 font-bold bg-red-50 px-2 py-0.5 rounded inline-block text-right mt-1 border border-red-100">â†© ÄÃ£ hoÃ n: -${formatMoney(returnedAmt)}</div>` 
					: '';
				
				const priceColor = returnedAmt > 0 ? "text-orange-600" : "text-blue-600";

				return `
				<div onclick="viewHistoryDetail(${o.id}, ${o.total_amount}, '${o.created_at}', '${noteSafe}')" 
					 class="bg-white p-3 border rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:bg-blue-50 transition mb-2">
					
					<div class="flex items-center gap-3">
						<div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center font-bold text-xs border border-gray-200">
							#${o.id}
						</div>
						<div>
							<div class="text-xs font-bold text-gray-700">${new Date(o.created_at || Date.now()).toLocaleString('vi-VN')}</div>
							<div class="text-[10px] text-gray-400 mt-0.5 flex items-center gap-1">
								<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
								${o.staff_email ? o.staff_email.split('@')[0] : 'N/A'}
							</div>
						</div>
					</div>

					<div class="text-right flex flex-col items-end">
						<div class="font-bold ${priceColor} text-lg font-display">${formatMoney(realTotal)}</div>
						${refundTag}
					</div>
					
				</div>`;
			}).join('');
		}

		// --- LOGIC TRáº¢ HÃ€NG Má»šI ---
		let currentReturnItem = null; // Biáº¿n táº¡m lÆ°u thÃ´ng tin mÃ³n hÃ ng Ä‘ang tráº£

		async function viewHistoryDetail(id, totalCached, time, noteEncoded) {
			currentHistoryOrderId = id; 

			document.getElementById('history-detail-panel').classList.remove('hidden');
			document.getElementById('hist-detail-id').innerText = `ÄÆ¡n hÃ ng #${id}`;
			document.getElementById('hist-detail-time').innerText = new Date(time).toLocaleString('vi-VN');

			// 1. Táº£i thÃ´ng tin Ä‘Æ¡n hÃ ng má»›i nháº¥t tá»« DB
			const { data: orderData } = await client
				.from('orders')
				.select('returned_amount, total_amount')
				.eq('id', id)
				.single();
			
			const currentTotal = orderData ? orderData.total_amount : totalCached;
			const returnedAmt = orderData ? (orderData.returned_amount || 0) : 0;
			const realRevenue = currentTotal - returnedAmt;

			// 2. Xá»­ lÃ½ ghi chÃº
			let received = 0, change = 0;
			try { 
				const noteDecoded = decodeURIComponent(noteEncoded); 
				if(noteDecoded) { 
					const extra = JSON.parse(noteDecoded); 
					received = extra.received_money; 
					change = extra.change_money; 
				} 
			} catch(e) {}

			// 3. --- QUAN TRá»ŒNG: PHáº¢I Táº¢I DANH SÃCH MÃ“N (items) TRÆ¯á»šC ---
			const { data: items } = await client.from('order_items').select('*').eq('order_id', id);

			// 4. --- SAU ÄÃ“ Má»šI Táº O FOOTER (VÃŒ NÃšT IN Cáº¦N BIáº¾N items) ---
			const footerHtml = `
				<div class="flex justify-between text-sm">
					<span class="text-gray-500">Tá»•ng tiá»n ban Ä‘áº§u:</span>
					<span class="font-bold text-gray-800">${formatMoney(currentTotal)}</span>
				</div>

				${returnedAmt > 0 ? `
				<div class="flex justify-between text-sm text-red-600 bg-red-50 px-2 py-1 rounded border border-red-100 -mx-2">
					<span class="font-bold">â†© ÄÃ£ hoÃ n tiá»n:</span>
					<span class="font-bold">-${formatMoney(returnedAmt)}</span>
				</div>
				<div class="flex justify-between text-sm pt-1 pb-1">
					<span class="text-indigo-600 font-bold">ğŸ’° Doanh thu thá»±c:</span>
					<span class="font-bold text-indigo-700 text-lg">${formatMoney(realRevenue)}</span>
				</div>
				<div class="border-t border-gray-200 my-1"></div>
				` : ''}

				<div class="flex justify-between text-sm mt-1">
					<span class="text-gray-500">KhÃ¡ch Ä‘Æ°a:</span>
					<span class="font-bold text-blue-600">${received ? formatMoney(received) : '---'}</span>
				</div>
				<div class="flex justify-between text-lg pt-2 border-t border-dashed border-gray-300 mt-2">
					<span class="font-bold text-orange-600">Tiá»n thá»‘i láº¡i:</span>
					<span class="font-bold text-orange-600">${change ? formatMoney(change) : '---'}</span>
				</div>

				<button onclick="printHistoryOrder(${id}, '${time}', '${encodeURIComponent(JSON.stringify(items))}', ${currentTotal}, ${received}, ${change})" 
						class="w-full mt-3 bg-gray-800 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">
					ğŸ–¨ï¸ IN HÃ“A ÄÆ N
				</button>
			`;
			
			// GÃ¡n HTML vÃ o khung footer
			document.getElementById('hist-detail-footer').innerHTML = footerHtml;

			// 5. Hiá»ƒn thá»‹ danh sÃ¡ch mÃ³n (Code cÅ©)
			document.getElementById('hist-detail-items').innerHTML = items.map(i => {
				let originalProd = null;
				if (i.product_id) {
					 originalProd = productsDB.find(p => p.id === i.product_id);
				}
				if (!originalProd) {
					 originalProd = productsDB.find(p => p.name === i.product_name) || {};
				}

				const barcode = originalProd.barcode || '---';
				const unit = originalProd.unit || 'CÃ¡i';
				
				const returned = i.returned_quantity || 0;
				const canReturn = i.quantity - returned;
				const isFullyReturned = canReturn <= 0;

				const returnBtn = isFullyReturned 
					? `<span class="text-[10px] bg-gray-200 text-gray-500 px-2 py-1 rounded font-bold">ÄÃ£ tráº£ háº¿t</span>`
					: `<button onclick="openReturnModal(${i.id}, '${i.product_name}', ${canReturn}, ${i.price}, ${originalProd ? originalProd.id : 'null'})" class="text-[10px] bg-red-50 text-red-600 border border-red-200 px-2 py-1 rounded font-bold hover:bg-red-100 active:scale-95">â†© Tráº£ hÃ ng</button>`;

				const returnedInfo = returned > 0 ? `<div class="text-[10px] text-red-500 font-bold mt-0.5 bg-red-50 inline-block px-1 rounded border border-red-100">âš ï¸ ÄÃ£ tráº£: ${returned}/${i.quantity}</div>` : '';

				return `
					<tr>
						<td class="py-2">
							<div class="font-bold text-gray-800">${i.product_name}</div>
							<div class="text-[10px] text-gray-500">MÃ£: ${barcode} | ÄVT: ${unit}</div>
							${returnedInfo}
						</td>
						<td class="text-right font-bold align-top py-2">x${i.quantity}</td>
						<td class="text-right text-xs align-top py-2">
							<div>${formatMoney(i.price)}</div>
							<div class="mt-1">${returnBtn}</div>
						</td>
						<td class="text-right font-bold text-blue-600 align-top py-2">${formatMoney(i.total)}</td>
					</tr>`;
			}).join('');
		}

		// --- CÃC HÃ€M Xá»¬ LÃ TRáº¢ HÃ€NG ---

		function openReturnModal(itemId, name, maxQty, price, prodId) {
			currentReturnItem = { itemId, name, maxQty, price, prodId };
			
			document.getElementById('return-modal').classList.remove('hidden');
			document.getElementById('return-item-name').innerText = name;
			document.getElementById('return-max-qty').innerText = maxQty;
			
			// Reset input vá» 1
			const input = document.getElementById('return-qty-input');
			input.value = 1;
			input.max = maxQty;
			
			updateRefundAmount();
		}

		function closeReturnModal() {
			document.getElementById('return-modal').classList.add('hidden');
			currentReturnItem = null;
		}

		function adjustReturnQty(delta) {
			const input = document.getElementById('return-qty-input');
			let newVal = parseInt(input.value) + delta;
			if (newVal < 1) newVal = 1;
			if (newVal > currentReturnItem.maxQty) newVal = currentReturnItem.maxQty;
			
			input.value = newVal;
			updateRefundAmount();
		}

		function updateRefundAmount() {
			const qty = parseInt(document.getElementById('return-qty-input').value) || 0;
			const total = qty * currentReturnItem.price;
			document.getElementById('return-refund-amt').innerText = formatMoney(total);
		}

		// HÃ m Xá»­ LÃ½ Logic ChÃ­nh
		async function confirmReturn() {
			if (!currentReturnItem) return;
			
			const qtyToReturn = parseInt(document.getElementById('return-qty-input').value);
			
			// Validate
			if (qtyToReturn <= 0 || qtyToReturn > currentReturnItem.maxQty) {
				return showAlert("Lá»—i", "Sá»‘ lÆ°á»£ng tráº£ khÃ´ng há»£p lá»‡!", "error");
			}

			// XÃ¡c nháº­n láº§n cuá»‘i
			const refundMoney = formatMoney(qtyToReturn * currentReturnItem.price);
			
			closeReturnModal(); // ÄÃ³ng modal nháº­p trÆ°á»›c

			showAlert("XÃ¡c nháº­n tráº£ hÃ ng", 
				`Nháº­n láº¡i <b>${qtyToReturn}</b> sáº£n pháº©m "${currentReturnItem.name}".<br>
				 HoÃ n tiá»n cho khÃ¡ch: <b class="text-red-600 text-xl">${refundMoney}</b>.<br><br>
				 Kho hÃ ng sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng cá»™ng thÃªm.`, 
				"confirm", 
				async () => {
					try {
						// 1. Cáº­p nháº­t báº£ng order_items (Giá»¯ nguyÃªn code cÅ©)
						const { data: currentItem } = await client.from('order_items').select('returned_quantity, order_id').eq('id', currentReturnItem.itemId).single();
						const newReturnedQty = (currentItem.returned_quantity || 0) + qtyToReturn;
						await client.from('order_items').update({ returned_quantity: newReturnedQty }).eq('id', currentReturnItem.itemId);

						// 2. Cáº­p nháº­t kho hÃ ng (Giá»¯ nguyÃªn code cÅ©)
						if (currentReturnItem.prodId) {
							const prodInDb = productsDB.find(p => p.id === currentReturnItem.prodId);
							if (prodInDb) {
								const newStock = (prodInDb.quantity || 0) + qtyToReturn;
								await client.from('products').update({ quantity: newStock }).eq('id', currentReturnItem.prodId);
							}
						}

						// --- 3. Má»šI: Cáº¬P NHáº¬T DOANH THU ÄÆ N HÃ€NG (orders) ---
						// TÃ­nh sá»‘ tiá»n vá»«a hoÃ n tráº£
						const refundMoney = qtyToReturn * currentReturnItem.price;
						const orderId = currentItem.order_id; // Láº¥y ID Ä‘Æ¡n hÃ ng tá»« item

						// Láº¥y sá»‘ tiá»n Ä‘Ã£ hoÃ n trÆ°á»›c Ä‘Ã³ cá»§a Ä‘Æ¡n hÃ ng nÃ y
						const { data: ord } = await client.from('orders').select('returned_amount').eq('id', orderId).single();
						
						// Cá»™ng dá»“n tiá»n hoÃ n má»›i
						const newTotalRefund = (ord.returned_amount || 0) + refundMoney;
						
						// LÆ°u ngÆ°á»£c vÃ o DB
						await client.from('orders').update({ returned_amount: newTotalRefund }).eq('id', orderId);
						// ----------------------------------------------------

						showAlert("ThÃ nh cÃ´ng", "ÄÃ£ tráº£ hÃ ng, nháº­p kho vÃ  trá»« doanh thu!", "success");
						
						fetchProducts();
						document.getElementById('history-detail-panel').classList.add('hidden');

					} catch (err) {
						console.error(err);
						showAlert("Lá»—i há»‡ thá»‘ng", "KhÃ´ng thá»ƒ cáº­p nháº­t tráº£ hÃ ng: " + err.message, "error");
					}
				}
			);
		}

		// Báº¯t sá»± kiá»‡n nháº­p tay vÃ o Ã´ sá»‘ lÆ°á»£ng Ä‘á»ƒ cáº­p nháº­t tiá»n hoÃ n
		document.getElementById('return-qty-input').addEventListener('input', function() {
			let val = parseInt(this.value);
			if(val > currentReturnItem.maxQty) this.value = currentReturnItem.maxQty;
			if(val < 1) this.value = 1;
			updateRefundAmount();
		});

        // --- PRODUCT MODAL ---
        function openProductModal(id = null) {
            document.getElementById('product-modal').classList.remove('hidden');
            if(id) { 
				const p = productsDB.find(x=>x.id==id);
				document.getElementById('prod-id').value=p.id; 
				document.getElementById('prod-name').value=p.name; 
				document.getElementById('prod-barcode').value=p.barcode||""; 
				document.getElementById('prod-itemcode').value=p.item_code||""; 
				document.getElementById('prod-price').value=p.price; 
				document.getElementById('prod-image').value=p.image||""; 
				document.getElementById('prod-unit').value=p.unit||""; 
				document.getElementById('prod-sale').value=p.sale_price||""; 
				document.getElementById('prod-quantity').value = p.quantity || 0;
			} 
            else { 
				document.getElementById('prod-id').value=""; 
				document.getElementById('prod-name').value=""; 
				document.getElementById('prod-barcode').value=""; 
				document.getElementById('prod-itemcode').value=""; 
				document.getElementById('prod-price').value=""; 
				document.getElementById('prod-image').value=""; 
				document.getElementById('prod-unit').value=""; 
				document.getElementById('prod-sale').value="";
				document.getElementById('prod-quantity').value="0";
			}
        }
        async function saveProduct() {
            const id = document.getElementById('prod-id').value;
            const payload = { 
				name: document.getElementById('prod-name').value, 
				price: parseInt(document.getElementById('prod-price').value), 
				sale_price: parseInt(document.getElementById('prod-sale').value) || null, 
				barcode: document.getElementById('prod-barcode').value, 
				item_code: document.getElementById('prod-itemcode').value, 
				unit: document.getElementById('prod-unit').value, 
				image: document.getElementById('prod-image').value,
				quantity: parseInt(document.getElementById('prod-quantity').value) || 0 };
            if(id) await client.from('products').update(payload).eq('id', id); 
			else await client.from('products').insert(payload);
			
            document.getElementById('product-modal').classList.add('hidden'); 
			fetchProducts(); 
			showAlert("ÄÃ£ lÆ°u", "Cáº­p nháº­t sáº£n pháº©m thÃ nh cÃ´ng", 'success');
        }

        // --- GENERAL ---
        function confirmLogout() { showAlert("ÄÄƒng xuáº¥t", "Báº¡n cháº¯c cháº¯n muá»‘n thoÃ¡t phiÃªn lÃ m viá»‡c?", 'confirm', forceLogout); }
        function handleManualInput(e) { 
			const val = e.target.value.trim(); 
			
			if (val.endsWith('*') && val.length > 1) { 
				setMultiplier(parseInt(val)); 
				e.target.value = ''; 
				return; 
			} 
			if (e.key === 'Enter') { 
				addToCart(val); 
				e.target.value = '';
				e.target.blur();
			} 
		}
        function setMultiplier(n) { if(!isNaN(n) && n>0) { currentMultiplier = n; document.getElementById('multiplier-badge').classList.remove('hidden'); document.getElementById('multiplier-val').innerText = n; } }
        async function loadRevenue() { 
			const { data: orders } = await client.from('orders').select('*'); 
			if(!orders) return; 
			const today = new Date().toDateString(), thisMonth = new Date().getMonth(); 
			let sumD=0, cntD=0, sumM=0, cntM=0; 
			orders.forEach(o => { 
				const d=new Date(o.created_at);
				
				const realRevenue = o.total_amount - (o.returned_amount || 0);
				
				if(d.toDateString() === today) {
					sumD += realRevenue; // Cá»™ng doanh thu thá»±c
					cntD++;
				}
				if(d.getMonth() === thisMonth) {
					sumM += realRevenue; // Cá»™ng doanh thu thá»±c
					cntM++;
				} 
			}); 
			document.getElementById('rev-today').innerText=formatMoney(sumD); 
			document.getElementById('order-count-today').innerText=cntD+" Ä‘Æ¡n"; 
			document.getElementById('rev-month').innerText=formatMoney(sumM); 
			document.getElementById('order-count-month').innerText=cntM+" Ä‘Æ¡n"; 
		}
        
        function parkOrder() { if(cart.length>0) { parkedOrders.push({id:Date.now(), items:[...cart]}); localStorage.setItem('pos_parked_orders',JSON.stringify(parkedOrders)); cart=[]; updateParkedBadge(); updateCartUI(); document.getElementById('last-scanned-card').classList.add('hidden'); showAlert("ÄÃ£ lÆ°u", "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o má»¥c chá».", 'info'); } }
        function showRecallModal() {
            document.getElementById('recall-modal').classList.remove('hidden');
            const container = document.getElementById('parked-list');
            if (parkedOrders.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 py-4">ChÆ°a cÃ³ giao dá»‹ch nÃ o.</p>'; return; }
            container.innerHTML = parkedOrders.map((o, i) => {
                const itemsDetailHtml = o.items.map(item => `<div class="flex justify-between items-start py-2 border-b border-dashed border-gray-200 last:border-0"><div class="flex-1 pr-2"><div class="text-sm font-bold text-gray-700">${item.name}</div><div class="text-[10px] text-gray-500 mt-0.5"><span class="bg-gray-100 px-1 rounded border">MÃ£: ${item.barcode || '---'}</span></div></div><div class="text-right"><div class="text-sm font-bold text-blue-600">x${item.quantity}</div></div></div>`).join('');
                return `<div class="bg-white border rounded-xl shadow-sm mb-4 overflow-hidden"><div class="bg-orange-50 p-3 flex justify-between items-center border-b border-orange-100"><div><span class="font-bold text-orange-800 text-sm">Giao dá»‹ch #${i + 1}</span></div><div class="flex gap-2"><button onclick="restoreOrder(${i})" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold">Gá»i láº¡i</button><button onclick="deleteParked(${i})" class="text-red-500 border border-red-200 px-2 py-1.5 rounded text-xs">XÃ³a</button></div></div><div class="p-3 bg-white">${itemsDetailHtml}</div></div>`;
            }).join('');
        }
        function restoreOrder(i) { 
            const doRestore = () => { cart=parkedOrders[i].items; parkedOrders.splice(i,1); localStorage.setItem('pos_parked_orders',JSON.stringify(parkedOrders)); updateParkedBadge(); updateCartUI(); document.getElementById('recall-modal').classList.add('hidden'); renderPaymentList(); document.getElementById('scan-screen').classList.add('hidden'); document.getElementById('payment-screen').classList.remove('hidden'); };
            if(cart.length>0) showAlert("Ghi Ä‘Ã¨", "Giá» hÃ ng hiá»‡n táº¡i Ä‘ang cÃ³ sáº£n pháº©m. Báº¡n cÃ³ muá»‘n ghi Ä‘Ã¨ báº±ng Ä‘Æ¡n chá» nÃ y?", 'confirm', doRestore); else doRestore();
        }
        function deleteParked(i) { showAlert("XÃ³a Ä‘Æ¡n chá»", "Báº¡n muá»‘n xÃ³a Ä‘Æ¡n lÆ°u táº¡m nÃ y?", 'confirm', () => { parkedOrders.splice(i,1); localStorage.setItem('pos_parked_orders',JSON.stringify(parkedOrders)); updateParkedBadge(); showRecallModal(); }); }
        function updateParkedBadge() { const b=document.getElementById('parked-count'); b.innerText=parkedOrders.length; parkedOrders.length>0?b.classList.remove('hidden'):b.classList.add('hidden'); }
        function voidTransaction() {
			// 1. Kiá»ƒm tra: Náº¿u giá» hÃ ng trá»‘ng thÃ¬ bÃ¡o lá»—i vÃ  Dá»ªNG NGAY
			if (cart.length === 0) {
				return showAlert("Giá» hÃ ng trá»‘ng", "ChÆ°a cÃ³ sáº£n pháº©m nÃ o Ä‘á»ƒ xÃ³a!", 'info');
			}

			// 2. Náº¿u cÃ³ hÃ ng thÃ¬ má»›i hiá»‡n báº£ng há»i xÃ¡c nháº­n
			showAlert("Há»§y Ä‘Æ¡n", "Báº¡n muá»‘n xÃ³a toÃ n bá»™ sáº£n pháº©m trong giá»?", 'confirm', () => {
				cart = [];
				updateCartUI(); // HÃ m nÃ y sáº½ tá»± Ä‘á»™ng cáº­p nháº­t láº¡i localStorage thÃ nh rá»—ng luÃ´n
				document.getElementById('last-scanned-card').classList.add('hidden');
				
				// (TÃ¹y chá»n) Rung nháº¹ bÃ¡o hiá»‡u Ä‘Ã£ xÃ³a
				if(navigator.vibrate) navigator.vibrate(50);
			});
		}
        
        // --- CHECK PRICE ---
        function openCheckPriceModal() { document.getElementById('check-price-modal').classList.remove('hidden'); document.getElementById('check-result').innerHTML = '<p class="text-gray-400">Má»i nháº­p mÃ£ hoáº·c tÃªn sáº£n pháº©m</p>'; setTimeout(() => document.getElementById('check-input').focus(), 100); }
        function handleCheckPriceInput(e) {
            if (e.key === 'Enter') { 
				const val = e.target.value.trim().toLowerCase(); 
				if (!val) return; 
				
				const p = productsDB.find(x => (x.barcode && x.barcode == val) || (x.item_code && x.item_code.toLowerCase() == val)) || productsDB.find(x => x.name.toLowerCase().includes(val)); 
				
				renderCheckResult(p); 
				e.target.value = '';
				e.target.blur();
			}
        }
        function renderCheckResult(p) {
            const el = document.getElementById('check-result');
            if (!p) { el.innerHTML = `<div class="text-6xl mb-2">ğŸ¤·â€â™‚ï¸</div><h3 class="text-red-500 font-bold text-xl">KhÃ´ng tÃ¬m tháº¥y!</h3>`; return; }
            let priceHtml = ''; if (p.sale_price && p.sale_price < p.price) { priceHtml = `<div class="text-gray-400 line-through text-lg">${formatMoney(p.price)}</div><div class="text-red-600 font-bold text-4xl mt-1">${formatMoney(p.sale_price)}</div><span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs font-bold mt-1 inline-block">Äang giáº£m giÃ¡</span>`; } else { priceHtml = `<div class="text-blue-600 font-bold text-4xl mt-2">${formatMoney(p.price)}</div>`; }
            el.innerHTML = `<img src="${p.image || PLACEHOLDER_IMG}" class="w-24 h-24 object-cover rounded-lg mb-2 shadow-sm border mx-auto"><h3 class="font-bold text-gray-800 text-xl leading-tight px-2">${p.name}</h3><div class="text-xs text-gray-500 mt-1">MÃ£: ${p.barcode || '---'} | Code: ${p.item_code || '---'}</div><div class="text-xs text-gray-500">ÄVT: ${p.unit || 'CÃ¡i'}</div>${priceHtml}${p.is_locked ? '<div class="mt-2 text-red-500 font-bold border border-red-200 bg-red-50 p-2 rounded">ğŸ”’ Sáº¢N PHáº¨M ÄANG KHÃ“A</div>' : ''}`;
        }

        function formatMoney(n) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n); }
        checkSession();
		
		// --- Xá»¬ LÃ NÃšT BACK TRÃŠN ÄIá»†N THOáº I (History API) ---
		window.addEventListener('popstate', function (event) {
			// Kiá»ƒm tra xem mÃ n hÃ¬nh nÃ o Ä‘ang má»Ÿ Ä‘á»ƒ Ä‘Ã³ng láº¡i
			const paymentScreen = document.getElementById('payment-screen');
			const adminScreen = document.getElementById('admin-screen');

			// 1. Náº¿u Ä‘ang á»Ÿ mÃ n hÃ¬nh Thanh toÃ¡n -> Quay vá» BÃ¡n hÃ ng
			if (!paymentScreen.classList.contains('hidden')) {
				paymentScreen.classList.add('hidden');
				document.getElementById('scan-screen').classList.remove('hidden');
				if (html5QrcodeScanner) html5QrcodeScanner.resume(); // Báº­t láº¡i camera
			}
			
			// 2. Náº¿u Ä‘ang á»Ÿ mÃ n hÃ¬nh Admin -> Quay vá» BÃ¡n hÃ ng
			else if (!adminScreen.classList.contains('hidden')) {
				adminScreen.classList.add('hidden');
				document.getElementById('scan-screen').classList.remove('hidden');
				if (html5QrcodeScanner) html5QrcodeScanner.resume(); // Báº­t láº¡i camera
			}
		});
		
		// --- LOGIC HEARTBEAT (BÃO ONLINE & CHECK KICK) ---
		let heartbeatInterval = null;

		function startHeartbeat() {
			if (heartbeatInterval) clearInterval(heartbeatInterval);
			
			// Gá»i ngay láº­p tá»©c láº§n Ä‘áº§u
			pingServer();

			// Láº·p láº¡i má»—i 30 giÃ¢y
			heartbeatInterval = setInterval(pingServer, 30000); 
		}

		async function pingServer() {
			if (!currentUserEmail) return;

			try {
				// 1. Kiá»ƒm tra tráº¡ng thÃ¡i báº£n thÃ¢n
				const { data: user, error } = await client
					.from('app_users')
					.select('*')
					.eq('email', currentUserEmail)
					.maybeSingle(); // Chuáº©n: dÃ¹ng maybeSingle Ä‘á»ƒ trÃ¡nh lá»—i náº¿u chÆ°a cÃ³ user

				// Náº¿u chÆ°a cÃ³ -> Tá»± Ä‘á»™ng thÃªm vÃ o
				if (!user && !error) {
					await client.from('app_users').insert({ 
						email: currentUserEmail, 
						role: currentUserRole, // LÆ°u Ã½: Äáº£m báº£o biáº¿n nÃ y Ä‘ang chá»©a Ä‘Ãºng role hiá»‡n táº¡i
						last_seen: new Date() 
					});
				}
				
				if (currentUserRole !== 'admin') {
					const { data: settings } = await client.from('app_settings').select('maintenance_mode, maintenance_message').eq('id', 1).single();
					
					if (settings && settings.maintenance_mode) {
						showAlert("Há»† THá»NG Báº¢O TRÃŒ", settings.maintenance_message, "error", () => {
							forceLogout();
						});
						return; // Dá»«ng ngay
					}
				}
				
				// Náº¿u Ä‘Ã£ cÃ³ -> Kiá»ƒm tra tráº¡ng thÃ¡i
				if (user) {
					// A. Náº¿u bá»‹ KHÃ“A hoáº·c bá»‹ KICK
					if (user.is_locked || user.force_logout) {
						
						// Xá»­ lÃ½ trÆ°á»ng há»£p Kick (Reset cá» trÆ°á»›c khi Ä‘Ã¡)
						if (user.force_logout) {
							await client.from('app_users').update({ force_logout: false }).eq('email', currentUserEmail);
							
							// Sá»¬A: ÄÆ°a forceLogout vÃ o lÃ m tham sá»‘ thá»© 4 (callback)
							showAlert("Cáº¢NH BÃO", 'âš ï¸ Báº N ÄÃƒ Bá»Š BUá»˜C ÄÄ‚NG XUáº¤T Tá»ª QUáº¢N TRá»Š VIÃŠN.', "error", () => {
								forceLogout(); 
							});
						} else {
							// TrÆ°á»ng há»£p bá»‹ KhÃ³a
							showAlert("THÃ”NG BÃO", 'â›” TÃ€I KHOáº¢N Cá»¦A Báº N ÄÃƒ Bá»Š KHÃ“A!', "error", () => {
								forceLogout();
							});
						}
						
						// Ngáº¯t hÃ m luÃ´n Ä‘á»ƒ khÃ´ng cháº¡y cáº­p nháº­t last_seen bÃªn dÆ°á»›i
						return; 
					}

					// B. Náº¿u bÃ¬nh thÆ°á»ng -> Cáº­p nháº­t 'last_seen'
					await client.from('app_users').update({ last_seen: new Date() }).eq('email', currentUserEmail);
				}
			} catch (e) { 
				// Lá»—i máº¡ng hoáº·c lá»—i server thÃ¬ bá» qua, khÃ´ng cáº§n lÃ m phiá»n user
				console.log("Lá»—i Heartbeat:", e); 
			}
		}
		
		// --- SYSTEM SETTINGS ---
		async function fetchSystemSettings() {
			const { data } = await client.from('app_settings').select('*').eq('id', 1).single();
			if (data) {
				// LÆ°u vÃ o biáº¿n toÃ n cá»¥c
				globalSettings.allow_print = data.allow_print;
				globalSettings.enable_charts = data.enable_charts;
				globalSettings.store_name = data.store_name || "Cá»¬A HÃ€NG MINI POS";
				globalSettings.store_address = data.store_address || "";
				globalSettings.store_hotline = data.store_hotline || "";
				globalSettings.receipt_footer = data.receipt_footer || "";
				globalSettings.wifi_info = data.wifi_info || "";

				// Äá»• dá»¯ liá»‡u vÃ o Ã´ input trong tab CÃ i Ä‘áº·t
				document.getElementById('sys-maintenance-toggle').checked = data.maintenance_mode;
				document.getElementById('sys-print-toggle').checked = data.allow_print;
				document.getElementById('sys-chart-toggle').checked = data.enable_charts;
				document.getElementById('sys-message').value = data.maintenance_message;

				// --- PHáº¦N Má»šI ---
				document.getElementById('sys-store-name').value = data.store_name || "";
				document.getElementById('sys-store-address').value = data.store_address || "";
				document.getElementById('sys-store-hotline').value = data.store_hotline || "";
				document.getElementById('sys-footer').value = data.receipt_footer || "";
				document.getElementById('sys-wifi').value = data.wifi_info || "";
			}
		}

		async function saveSystemSettings() {
			const maintMode = document.getElementById('sys-maintenance-toggle').checked;
			const printMode = document.getElementById('sys-print-toggle').checked;
			const chartMode = document.getElementById('sys-chart-toggle').checked;
			const msg = document.getElementById('sys-message').value.trim();

			// --- Láº¤Y Dá»® LIá»†U Tá»ª INPUT Má»šI ---
			const sName = document.getElementById('sys-store-name').value.trim();
			const sAddr = document.getElementById('sys-store-address').value.trim();
			const sHotline = document.getElementById('sys-store-hotline').value.trim();
			const sFoot = document.getElementById('sys-footer').value.trim();
			const sWifi = document.getElementById('sys-wifi').value.trim();

			showAlert("LÆ°u cÃ i Ä‘áº·t", `XÃ¡c nháº­n cáº­p nháº­t cáº¥u hÃ¬nh há»‡ thá»‘ng?`, 'confirm', async () => {
				const { error } = await client.from('app_settings').update({
					maintenance_mode: maintMode,
					maintenance_message: msg,
					allow_print: printMode,
					enable_charts: chartMode,
					// --- Cáº¬P NHáº¬T Cá»˜T Má»šI ---
					store_name: sName,
					store_address: sAddr,
					store_hotline: sHotline,
					receipt_footer: sFoot,
					wifi_info: sWifi
				}).eq('id', 1);

				if (error) {
					showAlert("Lá»—i", error.message, 'error');
				} else {
					// Cáº­p nháº­t ngay vÃ o biáº¿n bá»™ nhá»›
					globalSettings.allow_print = printMode;
					globalSettings.enable_charts = chartMode;
					globalSettings.store_name = sName;
					globalSettings.store_address = sAddr;
					globalSettings.store_hotline = sHotline;
					globalSettings.receipt_footer = sFoot;
					globalSettings.wifi_info = sWifi;

					if(!document.getElementById('admin-revenue').classList.contains('hidden')){
						switchAdminTab('revenue');
					}
					
					showAlert("ThÃ nh cÃ´ng", "ÄÃ£ cáº­p nháº­t cáº¥u hÃ¬nh há»‡ thá»‘ng.", 'success');
				}
			});
		}
		
		// ==========================================
		// --- TÃNH NÄ‚NG ÄÄ‚NG NHáº¬P Báº°NG QR CODE ---
		// ==========================================
		let html5QrCode; 

		function startLoginScanner() {
			const overlay = document.getElementById('login-scanner-overlay');
			if (overlay) overlay.classList.remove('hidden');

			if (!html5QrCode) {
				// --- Sá»¬A ID á» ÄÃ‚Y CHO KHá»šP Vá»šI HTML ---
				html5QrCode = new Html5Qrcode("reader-login"); 
			}

			const config = { fps: 10, qrbox: 250, aspectRatio: 1.0 };

			html5QrCode.start(
				{ facingMode: "environment" },
				config,
				(decodedText) => {
					// Khi quÃ©t thÃ nh cÃ´ng
					console.log("QR Login Scan:", decodedText);
					handleLoginQRResult(decodedText);
				},
				() => {} // Bá» qua lá»—i Ä‘ang quÃ©t
			).catch(err => {
				console.error(err);
				showAlert("Lá»—i", 'KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera sau. Äang thá»­ camera trÆ°á»›c...', "error");
				// Fallback sang camera trÆ°á»›c náº¿u lá»—i
				html5QrCode.start({ facingMode: "user" }, config, (t) => handleLoginQRResult(t));
			});
		}

		function stopLoginScanner() {
			// 1. Táº¯t camera
			if (html5QrCode && html5QrCode.isScanning) {
				html5QrCode.stop().then(() => {
					console.log("ÄÃ£ táº¯t camera");
					html5QrCode.clear();
				}).catch(err => console.log("Lá»—i táº¯t camera:", err));
			}

			// 2. áº¨n Overlay
			const overlay = document.getElementById('login-scanner-overlay');
			if (overlay) overlay.classList.add('hidden');
		}

		function handleLoginQRResult(text) {
			try {
				// 1. Thá»­ giáº£i mÃ£ JSON
				const data = JSON.parse(text);
				
				console.log("Dá»¯ liá»‡u quÃ©t Ä‘Æ°á»£c:", data); // Xem trong Console F12

				// 2. Kiá»ƒm tra dá»¯ liá»‡u
				// MÃ£ chuáº©n pháº£i cÃ³ Ä‘á»§ 3 mÃ³n: action="login", email, pass
				if (data.action === 'login' && data.email && data.pass) {
					
					if(navigator.vibrate) navigator.vibrate(200);
					stopLoginScanner();

					document.getElementById('email').value = data.email;
					document.getElementById('password').value = data.pass;
					
					document.getElementById('login-msg').innerText = "âœ… ÄÃ£ nháº­n mÃ£! Äang Ä‘Äƒng nháº­p...";
					document.getElementById('login-msg').className = "text-center text-green-600 text-xs font-bold min-h-[20px]";

					setTimeout(() => { handleLogin(); }, 500);

				} else {
					// --- ÄÃ‚Y LÃ€ CHá»– BÃO Lá»–I Cá»¦A Báº N ---
					let missing = [];
					if (data.action !== 'login') missing.push(`Sai action (nháº­n Ä‘Æ°á»£c: ${data.action})`);
					if (!data.email) missing.push("Thiáº¿u Email");
					if (!data.pass) missing.push("Thiáº¿u Pass");

					showAlert("Cáº£nh bÃ¡o",'âš ï¸ MÃ£ khÃ´ng há»£p lá»‡!', "waning");
				}
			} catch (e) {
				console.log("Lá»—i Ä‘á»c mÃ£:", text);
				showAlert("Lá»—i", 'âŒ Lá»—i format: MÃ£ QR nÃ y khÃ´ng chá»©a dá»¯ liá»‡u JSON há»£p lá»‡.', "error");
			}
		}
		
		// Láº¯ng nghe sá»± kiá»‡n phÃ­m Enter táº¡i Ã´ máº­t kháº©u
		document.getElementById('qr-password-input').addEventListener('keyup', function (e) {
			if (e.key === 'Enter') {
				// áº¨n bÃ n phÃ­m áº£o ngay láº­p tá»©c Ä‘á»ƒ nhÃ¬n tháº¥y mÃ n hÃ¬nh
				e.target.blur(); 
				submitQRPassword();
			}
		});
		
		// === LOGIC CÃ€I Äáº¶T NÃšT SCAN (3 CHáº¾ Äá»˜ Má»šI) ===
		let currentScanMode = localStorage.getItem('pos_scan_mode') || 'default'; // Máº·c Ä‘á»‹nh lÃ  nÃºt to

		function initScanSettings() {
			const radios = document.getElementsByName('scan_mode');
			radios.forEach(r => {
				if(r.value === currentScanMode) r.checked = true;
			});
			updateScanButtonBehavior();
		}

		// 2. HÃ m má»Ÿ báº£ng cÃ i Ä‘áº·t
		function openScanSettings() {
			initScanSettings();
			document.getElementById('scan-settings-modal').classList.remove('hidden');
		}

		// 3. HÃ m lÆ°u cÃ i Ä‘áº·t khi chá»n Radio
		function saveScanMode(mode) {
			currentScanMode = mode;
			localStorage.setItem('pos_scan_mode', mode);
			updateScanButtonBehavior();
			
			// Náº¿u chuyá»ƒn cháº¿ Ä‘á»™, tá»‘t nháº¥t lÃ  táº¯t camera Ä‘i Ä‘á»ƒ reset giao diá»‡n
			stopScanner();
			
			if(navigator.vibrate) navigator.vibrate(50);
		}

		// 4. Cáº­p nháº­t hÃ nh vi nÃºt báº¥m (QUAN TRá»ŒNG)
		function updateScanButtonBehavior() {
			const containerSales = document.getElementById('scan-buttons-container');      // Chá»— bÃ¡n hÃ ng
			const containerCheck = document.getElementById('scan-buttons-container-check'); // Chá»— check giÃ¡
			const bigButton = document.getElementById('camera-placeholder'); // NÃºt to giá»¯a mÃ n hÃ¬nh
			
			// 1. XÃ³a nÃºt cÅ© á»Ÿ cáº£ 2 nÆ¡i
			if (containerSales) containerSales.innerHTML = "";
			if (containerCheck) containerCheck.innerHTML = "";

			if (currentScanMode === 'default') {
				// --- CHáº¾ Äá»˜ 1: Máº¶C Äá»ŠNH ---
				if (bigButton && (!html5QrcodeScanner || !html5QrcodeScanner.isScanning)) {
					bigButton.classList.remove('hidden');
				}
			} 
			else {
				// --- CHáº¾ Äá»˜ 2 & 3: DÃ™NG NÃšT NHá» ---
				if (bigButton) bigButton.classList.add('hidden');

				// Logic táº¡o nÃºt dá»±a trÃªn cháº¿ Ä‘á»™
				if (currentScanMode === 'toggle') {
					// ThÃªm nÃºt vÃ o mÃ n hÃ¬nh BÃ¡n hÃ ng
					if(containerSales) containerSales.appendChild(createToggleButton());
					// ThÃªm nÃºt vÃ o mÃ n hÃ¬nh Check giÃ¡ (Pháº£i táº¡o má»›i, khÃ´ng dÃ¹ng láº¡i biáº¿n cÅ© Ä‘Æ°á»£c)
					if(containerCheck) containerCheck.appendChild(createToggleButton());
				} 
				else if (currentScanMode === 'hold') {
					if(containerSales) containerSales.appendChild(createHoldButton());
					if(containerCheck) containerCheck.appendChild(createHoldButton());
				}
			}
		}

		function createToggleButton() {
			const btn = document.createElement('button');
			btn.className = "w-14 h-12 rounded-xl bg-blue-600 text-white flex items-center justify-center text-2xl shadow-lg active:scale-90 transition-transform shrink-0";
			btn.innerHTML = `
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
				  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z" />
				  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75zM6.75 16.5h.75v.75h-.75v-.75zM16.5 6.75h.75v.75h-.75v-.75zM13.5 13.5h.75v.75h-.75v-.75zM13.5 19.5h.75v.75h-.75v-.75zM19.5 13.5h.75v.75h-.75v-.75zM16.5 16.5h.75v.75h-.75v-.75zM16.5 19.5h.75v.75h-.75v-.75z" />
				</svg>
			`;
			btn.onclick = () => {
				if (html5QrcodeScanner && html5QrcodeScanner.isScanning) stopScanner();
				else startScanner();
			};
			return btn;
		}

		function createHoldButton() {
			const btn = document.createElement('button');
			btn.className = "w-14 h-12 rounded-xl bg-orange-500 text-white flex items-center justify-center text-2xl shadow-lg active:scale-90 transition-transform shrink-0 select-none touch-none";
			btn.innerHTML = "ğŸ‘†";
			
			const start = (e) => { 
				if(e.cancelable) e.preventDefault(); 
				startScanner(); 
				btn.classList.add('scale-110', 'bg-orange-600'); 
			};
			const stop = (e) => { 
				if(e.cancelable) e.preventDefault(); 
				stopScanner(); 
				btn.classList.remove('scale-110', 'bg-orange-600'); 
			};

			btn.addEventListener('touchstart', start, { passive: false });
			btn.addEventListener('touchend', stop);
			btn.addEventListener('mousedown', start);
			btn.addEventListener('mouseup', stop);
			btn.addEventListener('mouseleave', () => {
				if (html5QrcodeScanner && html5QrcodeScanner.isScanning) stop();
			});

			return btn;
		}

		// Gá»i hÃ m khá»Ÿi táº¡o ngay khi script cháº¡y (hoáº·c nhÃ©t vÃ o checkSession)
		setTimeout(initScanSettings, 500);
		
		// HÃ€M IN HÃ“A ÄÆ N
		function printReceipt(orderId, time, staff, items, total, received, change, isCopy = false) {
			// 1. ÄIá»€N THÃ”NG TIN Tá»ª Cáº¤U HÃŒNH (THAY VÃŒ Cá»¨NG)
			document.getElementById('rec-store-name').innerText = globalSettings.store_name || "Cá»¬A HÃ€NG MINI POS"; 
			document.getElementById('rec-address').innerText = globalSettings.store_address || "";
			document.getElementById('rec-hotline').innerText = globalSettings.store_hotline || "";
			
			// --- Xá»¬ LÃ Báº¢N SAO (Má»šI) ---
			const copyLabel = document.getElementById('rec-is-copy');
			if (isCopy) {
				// Náº¿u lÃ  in láº¡i -> Hiá»‡n chá»¯ COPY
				copyLabel.classList.remove('hidden');
			} else {
				// Náº¿u lÃ  in má»›i -> áº¨n chá»¯ COPY (reset tráº¡ng thÃ¡i cÅ©)
				copyLabel.classList.add('hidden');
			}
			
			// Cáº­p nháº­t pháº§n chÃ¢n trang
			document.getElementById('rec-footer-1').innerText = globalSettings.receipt_footer || "Cáº£m Æ¡n quÃ½ khÃ¡ch!";
			document.getElementById('rec-footer-2').innerText = globalSettings.wifi_info || "";

			document.getElementById('rec-id').innerText = "#" + orderId;
			document.getElementById('rec-time').innerText = new Date(time).toLocaleString('vi-VN');
			document.getElementById('rec-staff').innerText = staff ? staff.split('@')[0] : 'Admin';
			
			const listEl = document.getElementById('rec-items-list');
			
			// --- PHáº¦N TIÃŠU Äá»€ Báº¢NG (THEAD) ---
			// Ã‰p cá»©ng Ä‘á»™ rá»™ng vÃ  cÄƒn lá» cho tiÃªu Ä‘á»
			const headerHtml = `
				<thead>
					<tr class="border-b border-black border-dashed">
						<th class="w-[40%] text-left pb-1">TÃªn SP / MÃ£</th>
						<th class="w-[15%] text-center pb-1">SL</th>
						<th class="w-[20%] text-right pb-1">GiÃ¡</th>
						<th class="w-[25%] text-right pb-1">ThÃ nh tiá»n</th>
					</tr>
				</thead>
			`;

			// --- PHáº¦N Ná»˜I DUNG (TBODY) ---
			const bodyHtml = items.map(i => {
				let name = i.product_name || i.name; 
				let code = i.barcode || i.item_code;
				
				// TÃ¬m mÃ£ náº¿u thiáº¿u
				if (!code) {
					 const p = productsDB.find(x => x.id === i.product_id) || productsDB.find(x => x.name === name);
					 if (p) code = p.barcode || p.item_code;
				}
				const codeDisplay = code ? `${code}` : '';

				return `
				<tr>
					<td class="align-top pr-1 font-bold pt-1" colspan="4">${name}</td>
				</tr>
				<tr class="border-b border-dashed border-gray-300">
					<td class="text-[11px] align-top pt-0 pb-1 w-[40%]">${codeDisplay}</td>
					
					<td class="text-center align-top pt-0 pb-1 w-[15%] font-bold">x${i.quantity}</td>
					
					<td class="text-right align-top pt-0 pb-1 w-[20%]">${formatMoney(i.price).replace('â‚«','')}â‚«</td>
					
					<td class="text-right align-top font-bold pt-0 pb-1 w-[25%]">${formatMoney(i.total || (i.price*i.quantity)).replace('â‚«','')}â‚«</td>
				</tr>
				`;
			}).join('');

			// GÃ¡n láº¡i HTML trá»n bá»™ (bao gá»“m cáº£ thead má»›i sá»­a)
			document.querySelector('#receipt-print-area table').innerHTML = headerHtml + `<tbody id="rec-items-list">${bodyHtml}</tbody>`;

			// Äiá»n tá»•ng tiá»n
			document.getElementById('rec-total').innerText = formatMoney(total);
			document.getElementById('rec-cash').innerText = received ? formatMoney(received) : "---";
			document.getElementById('rec-change').innerText = change ? formatMoney(change) : "---";

			setTimeout(() => { window.print(); }, 300); 
		}
		
		// HÃ m wrapper Ä‘á»ƒ gá»i in tá»« lá»‹ch sá»­
		function printHistoryOrder(id, time, itemsJson, total, received, change) {
			const items = JSON.parse(decodeURIComponent(itemsJson));
			// Staff láº¥y tá»« thÃ´ng tin hiá»‡n táº¡i hoáº·c pháº£i lÆ°u vÃ o history náº¿u muá»‘n chÃ­nh xÃ¡c ngÆ°á»i bÃ¡n cÅ©
			printReceipt(id, time, currentUserEmail, items, total, received, change, true);
		}
    </script>
	<script>
		// ÄÄƒng kÃ½ PWA Service Worker
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', () => {
				navigator.serviceWorker.register('./sw.js')
					.then(reg => console.log('PWA Ä‘Ã£ sáºµn sÃ ng:', reg.scope))
					.catch(err => console.log('Lá»—i PWA:', err));
			});
		}
	</script>
	<script type="module">
		import { BarcodeDetector } from "https://cdn.jsdelivr.net/npm/barcode-detector@2/dist/es/index.min.js";
		// GÃ¡n vÃ o window Ä‘á»ƒ dÃ¹ng Ä‘Æ°á»£c á»Ÿ cÃ¡c hÃ m bÃªn dÆ°á»›i
		window.BarcodeDetectorPolyfill = BarcodeDetector; 
	</script>
</body>
</html>
