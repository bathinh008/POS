<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini POS</title>
    
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#2563eb">
	<link rel="icon" type="image/x-icon" href="./mini_pos.ico">
    
    <link rel="apple-touch-icon" href="./mini_pos.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	
	<!--<script src="https://unpkg.com/@zxing/library@latest"></script>-->
	<script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.5.0/dist/easy.qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; user-select: none; }
        .hidden { display: none !important; }
        .scan-success { animation: popIn 0.3s ease-out; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .history-table th { font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 700; padding: 8px; text-align: left; background: #f9fafb; }
        .history-table td { padding: 8px; font-size: 13px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .locked-item { opacity: 0.6; background-color: #f3f4f6; }
        .locked-item img { filter: grayscale(100%); }
		
		/* --- TH√äM V√ÄO CU·ªêI TH·∫∫ STYLE --- */
		.modal-overlay { z-index: 60 !important; } /* ƒê·∫£m b·∫£o n√≥ ƒë√® l√™n m·ªçi th·ª© */
		.modal-enter { animation: modalSlideIn 0.2s ease-out forwards; }
		@keyframes modalSlideIn { 
			from { transform: scale(0.95); opacity: 0; } 
			to { transform: scale(1); opacity: 1; } 
		}
		
		/* --- S·ª¨A L·ªñI CAMERA CO GI√ÉN --- */
		#reader {
			width: 100%;
			height: 100%;
			overflow: hidden;
			position: absolute !important; /* <--- S·ª≠a th√†nh absolute ƒë·ªÉ ghim ch·∫∑t v√†o khung cha */
			top: 0;
			left: 0;
		}

		#reader video {
			width: 100% !important;
			height: 100% !important;
			object-fit: cover !important; /* L·∫•p ƒë·∫ßy khung, kh√¥ng m√©o */
			border-radius: 0 !important;
		}

		#custom-alert {
			z-index: 2147483647 !important; /* S·ªë l·ªõn nh·∫•t m√† tr√¨nh duy·ªát hi·ªÉu ƒë∆∞·ª£c */
		}
		
		/* --- HI·ªÜU ·ª®NG GI·ªé H√ÄNG CAO C·∫§P --- */

		/* 1. N√∫t rung nh·∫π khi ch·ªù thanh to√°n */
		@keyframes soft-pulse {
			0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
			70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
			100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
		}

		/* 2. Class k√≠ch ho·∫°t hi·ªáu ·ª©ng rung */
		.cart-active-pulse {
			animation: soft-pulse 2s infinite;
		}

		/* 3. Hi·ªáu ·ª©ng s·ªë n·∫£y l√™n (Pop) khi th√™m h√†ng */
		.badge-pop {
			animation: popInBadge 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}
		@keyframes popInBadge {
			0% { transform: scale(0.8); }
			50% { transform: scale(1.5); }
			100% { transform: scale(1); }
		}
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">

    <div id="login-screen" class="fixed inset-0 z-50 bg-gray-100 flex items-center justify-center p-4">
		<div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
			<div class="text-center mb-6">
				<div class="">
					<img src="./mini_pos.png" class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-3">
				</div>
				<h1 class="text-2xl font-bold text-gray-800">Mini POS</h1>
				<p class="text-gray-400 text-sm">H·ªá th·ªëng h·ªó tr·ª£ b√°n h√†ng</p>
			</div>
			
			<div class="space-y-4">
				<div>
					<label class="block text-xs font-bold text-gray-500 mb-1">Email</label>
					<!--<input type="email" id="email" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="name@example.com">-->
					<input 
						type="email" 
						id="email" 
						class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
						placeholder="name@example.com"
						enterkeyhint="next"
						onkeyup="if(event.key === 'Enter') document.getElementById('password').focus()"
					>
				</div>
				<div>
					<label class="block text-xs font-bold text-gray-500 mb-1">M·∫≠t kh·∫©u</label>
					<!--<input type="password" id="password" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">-->
					<input 
						type="password" 
						id="password" 
						class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
						placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
						enterkeyhint="go"
						onkeyup="handleLoginKey(event)"
					>
				</div>
				
				<div id="login-msg" class="text-center text-red-500 text-xs font-bold min-h-[20px]"></div>
				
				<button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">ƒêƒÇNG NH·∫¨P</button>
				
				<div class="relative flex py-2 items-center">
					<div class="flex-grow border-t border-gray-200"></div>
					<span class="flex-shrink-0 mx-4 text-gray-400 text-xs">Ho·∫∑c</span>
					<div class="flex-grow border-t border-gray-200"></div>
				</div>
				
				<button onclick="startLoginScanner()" class="w-full bg-white text-gray-700 border border-gray-300 py-3 rounded-xl font-bold shadow-sm active:scale-95 transition-transform flex items-center justify-center gap-2">
					<i class="fas fa-qrcode"></i> Qu√©t m√£ QR ƒëƒÉng nh·∫≠p
				</button>
			</div>
		</div>

		<div id="login-scanner-overlay" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[60] flex flex-col items-center justify-center">
			<p class="text-white font-bold mb-4 text-lg">ƒê∆∞a m√£ QR v√†o khung</p>
			
			<div class="relative w-80 h-80 border-4 border-blue-500 rounded-2xl overflow-hidden shadow-2xl bg-black">
				<div id="reader-login" class="w-full h-full"></div>
			</div>

			<button onclick="stopLoginScanner()" class="mt-8 bg-white text-red-600 px-6 py-2 rounded-full font-bold shadow-lg">ƒê√≥ng Camera</button>
		</div>
	</div>

    <div id="scan-screen" class="flex-1 flex flex-col hidden bg-gray-100">
        <div class="bg-white p-3 flex justify-between items-center shadow-sm z-20 sticky top-0">
            <div class="flex flex-col">
                <span id="user-email" class="text-xs font-bold text-gray-400 uppercase">Staff</span>
                <div class="flex items-center gap-2"><span class="text-lg font-bold text-gray-800">B√°n H√†ng</span><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span></div>
            </div>
            
        </div>

		<div class="bg-white px-3 py-2 border-b shadow-sm z-20 sticky top-0">
			<div class="flex gap-3 overflow-x-auto no-scrollbar pb-1">
				<button onclick="toggleCheckPriceMode()" class="flex items-center gap-2 bg-teal-50 text-teal-700 px-4 py-2 rounded-full border border-teal-100 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0">
					<span>üîç</span> <span>Check gi√°</span>
				</button>

				<button onclick="showRecallModal()" class="flex items-center gap-2 bg-orange-50 text-orange-600 px-4 py-2 rounded-full border border-orange-100 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0 relative">
					<span id="parked-count" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center border border-white">0</span>
					<span>üõë ƒê∆°n ch·ªù</span>
				</button>

				<button onclick="openHistory()" class="flex items-center gap-2 bg-blue-50 text-blue-600 px-4 py-2 rounded-full border border-blue-100 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0">
					<span>üïí L·ªãch s·ª≠</span>
				</button>
				
				<button id="btn-open-admin" onclick="openAdminScreen()" class="hidden flex items-center gap-2 bg-purple-50 text-purple-600 px-4 py-2 rounded-full border border-purple-100 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0">
					<span>‚öôÔ∏è Qu·∫£n l√Ω</span>
				</button>
				
				<button onclick="confirmLogout()" class="flex items-center gap-2 bg-gray-100 text-gray-600 px-4 py-2 rounded-full border border-gray-200 font-bold text-xs whitespace-nowrap active:scale-95 transition-transform shrink-0">
					<span>üö™ Tho√°t</span>
				</button>
			</div>
		</div>

        <div class="relative bg-black flex-1 flex flex-col items-center justify-center overflow-hidden group w-full">
    
			<div id="reader" class="w-full h-full absolute inset-0 z-0"></div>

			<!--<div class="absolute inset-0 pointer-events-none flex items-center justify-center z-10">
				<div class="w-64 h-64 border-2 border-white/50 rounded-3xl relative shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]">
					<div class="absolute top-0 left-0 w-6 h-6 border-t-4 border-l-4 border-white rounded-tl-xl -mt-1 -ml-1"></div>
					<div class="absolute top-0 right-0 w-6 h-6 border-t-4 border-r-4 border-white rounded-tr-xl -mt-1 -mr-1"></div>
					<div class="absolute bottom-0 left-0 w-6 h-6 border-b-4 border-l-4 border-white rounded-bl-xl -mb-1 -ml-1"></div>
					<div class="absolute bottom-0 right-0 w-6 h-6 border-b-4 border-r-4 border-white rounded-br-xl -mb-1 -mr-1"></div>
					<div class="absolute inset-0 border-b-2 border-green-400 opacity-50 animate-[scan_2s_infinite]"></div>
				</div>
			</div> -->

			<button id="btn-stop-cam" onclick="stopScanner()" class="hidden absolute top-4 right-4 z-40 bg-black/50 text-white p-2 rounded-full border border-white/30 backdrop-blur-md hover:bg-red-600 transition">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
			</button>
			
			<div id="multiplier-badge" 
				 class="hidden absolute top-10 inset-x-0 mx-auto w-fit z-30 bg-red-600 text-white px-4 py-1 rounded-full font-bold shadow-lg border border-white animate-bounce">
				S·ªë l∆∞·ª£ng: x<span id="multiplier-val">1</span><span> S·∫£n ph·∫©m</span>
			</div>

			<div id="camera-placeholder" class="z-20 text-center absolute">
				<button onclick="startScanner()" class="bg-white/20 backdrop-blur-md border border-white/40 text-white px-8 py-4 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-white/30 transition">
					üì∑ B·∫¨T CAMERA
				</button>
			</div>
		</div>

        <div class="sticky bottom-0 z-50 bg-white border-t rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] -mt-6 pb-[env(safe-area-inset-bottom)] overflow-hidden transition-all duration-300">
    
			<div id="sales-panel" class="block">
				<div class="p-4 pb-2">
					<div class="mb-3 flex gap-2 items-center">
    
						<button onclick="openScanSettings()" class="w-12 h-12 rounded-xl bg-gray-200 text-gray-600 flex items-center justify-center text-xl shadow-sm active:scale-95 transition-transform shrink-0">
							‚öôÔ∏è
						</button>

						<div class="relative flex-1 group">
							<input 
								type="tel" 
								id="manual-input" 
								placeholder="Nh·∫≠p m√£ ho·∫∑c s·ªë l∆∞·ª£ng (vd: 5*)" 
								class="w-full bg-gray-100 p-3.5 pl-10 rounded-xl text-lg font-semibold outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all shadow-inner" 
								onkeyup="handleManualInput(event)"
								enterkeyhint="search"
								autocomplete="off"
							>
							<span class="absolute left-3 top-4 text-gray-400">‚å®Ô∏è</span>
						</div>

						<div id="scan-buttons-container" class="flex gap-1 shrink-0"></div>
					</div>
					
					<div id="last-scanned-card" class="bg-emerald-50 p-3 rounded-2xl border border-emerald-100 flex items-center justify-between hidden scan-success mb-3 shadow-sm">
						<div>
							<h3 id="last-item-name" class="font-bold text-gray-800 line-clamp-1">...</h3>
							<div id="last-item-info" class="text-[11px] text-gray-500 font-semibold mb-1">...</div>
							<div id="last-item-price-container"></div>
						</div>
						<div class="bg-white px-3 py-1 rounded-xl border border-emerald-200 shadow-sm"><span id="last-item-qty" class="text-xl font-bold text-emerald-600">+1</span></div>
					</div>

					<div class="grid grid-cols-2 gap-3">
						<button onclick="voidTransaction()" class="bg-red-50 text-red-600 py-3.5 rounded-xl font-bold text-xs hover:bg-red-100 transition-colors">üóë H·ª¶Y ƒê∆†N</button>
						<button onclick="parkOrder()" class="bg-orange-50 text-orange-600 py-3.5 rounded-xl font-bold text-xs hover:bg-orange-100 transition-colors">‚è∏ HO√ÉN GIAO D·ªäCH</button>
					</div>
				</div>

				<div class="px-4 pb-4 pt-2">
					<button id="btn-cart-payment" onclick="goToPayment()" class="w-full bg-gray-200 text-gray-400 p-4 rounded-2xl font-bold text-xl shadow-none flex justify-between items-center active:scale-[0.98] transition-all duration-300 group">
						<div class="flex items-center gap-3">
							<span class="bg-black/10 px-3 py-1 rounded-lg text-sm backdrop-blur-md" id="quick-count">0</span>
							<span class="text-sm font-normal opacity-90">Gi·ªè h√†ng</span>
						</div>
						<span id="quick-total">0ƒë &rarr;</span>
					</button>
				</div>
			</div>

			<div id="check-price-panel" class="hidden bg-teal-50 h-full flex flex-col">
				<div class="px-4 py-3 bg-teal-600 text-white flex justify-between items-center shadow-md shrink-0">
					<div class="flex items-center gap-2">
						<span class="text-2xl animate-bounce">üîç</span>
						<div>
							<h3 class="font-bold text-lg leading-none">Ch·∫ø ƒë·ªô Xem Gi√°</h3>
							<p class="text-[10px] opacity-80">Qu√©t m√£ ƒë·ªÉ xem, kh√¥ng th√™m v√†o gi·ªè</p>
						</div>
					</div>
					<button onclick="toggleCheckPriceMode()" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg text-xs font-bold border border-white/30">ƒê√≥ng</button>
				</div>

				<div class="p-4 flex-1 flex flex-col gap-3">
					<div class="relative">
						<input 
							type="tel" 
							id="check-price-input" 
							placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£..." 
							class="w-full bg-white border-2 border-teal-200 p-3 pl-10 rounded-xl text-lg font-bold outline-none focus:border-teal-500 text-teal-800" 
							onkeyup="handleCheckPriceManual(event)"
							enterkeyhint="search"
							autocomplete="off"
							autocorrect="off"
							autocapitalize="off"
						>
						<span class="absolute left-3 top-3.5 text-teal-300">üîé</span>
					</div>

					<div id="check-result-container" class="bg-white rounded-2xl border border-teal-100 shadow-sm flex-1 flex flex-col items-center justify-center p-4 text-center min-h-[160px]">
						<div class="opacity-50 grayscale">
							<div class="text-5xl mb-2">üè∑Ô∏è</div>
							<p class="text-gray-400 text-sm">M·ªùi qu√©t s·∫£n ph·∫©m...</p>
						</div>
					</div>
				</div>
			</div>
		</div>
    </div>

    <div id="admin-screen" class="hidden fixed inset-0 z-40 bg-gray-50 flex flex-col h-full animate-fade-in">
        <div class="bg-white p-4 shadow-md flex justify-between items-center z-10 sticky top-0">
            <div class="flex items-center gap-2"><button onclick="closeAdminScreen()" class="p-2 -ml-2 hover:bg-gray-100 rounded-full">‚¨Ö</button><h2 class="font-bold text-xl text-gray-800">Qu·∫£n L√Ω</h2></div>
            <button onclick="forceLogout()" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded">ƒêƒÉng xu·∫•t</button>
        </div>
        <div class="p-3 bg-white border-b flex gap-2">
            <button onclick="switchAdminTab('products')" id="tab-products" class="flex-1 py-2.5 rounded-lg font-bold bg-blue-600 text-white">üì¶ H√†ng h√≥a</button>
            <button onclick="switchAdminTab('revenue')" id="tab-revenue" class="flex-1 py-2.5 rounded-lg font-bold bg-white text-gray-500 border">üí∞ Doanh thu</button>
			<button onclick="switchAdminTab('users')" id="tab-users" class="flex-1 py-2.5 rounded-lg font-bold bg-white text-gray-500 border">üë• Nh√¢n vi√™n</button>
			<button onclick="switchAdminTab('system')" id="tab-system" class="flex-1 py-2.5 rounded-lg font-bold bg-white text-gray-500 border">üîß H·ªá th·ªëng</button>
        </div>
        
        <div id="admin-products" class="flex-1 flex flex-col overflow-hidden">
            <div class="p-3 bg-white flex flex-col gap-2 border-b">
                <div class="flex gap-2">
                    <input type="text" placeholder="T√¨m t√™n, m√£..." class="flex-1 bg-gray-100 p-2.5 rounded-lg outline-none" oninput="renderProductList(this.value)">
                    <button onclick="openProductModal()" class="bg-green-600 text-white px-4 rounded-lg font-bold">+</button>
                </div>
                <div class="flex gap-2 justify-end">
					<button onclick="deleteAllProducts()" class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold border border-red-200 hover:bg-red-200 mr-auto">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
                    <button onclick="downloadTemplate()" class="text-xs text-blue-600 underline">‚¨áÔ∏è T·∫£i m·∫´u Excel</button>
                    <label class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold cursor-pointer border border-green-200 hover:bg-green-200 flex items-center gap-1">
                        <span>üì• Nh·∫≠p Excel</span>
                        <input type="file" id="excel-upload" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(event)">
                    </label>
                </div>
            </div>
            <div id="admin-product-list" class="flex-1 overflow-y-auto p-3 space-y-2 pb-20"></div>
        </div>

        <div id="admin-revenue" class="hidden flex-1 flex flex-col overflow-hidden bg-gray-50 h-full">
			<div class="p-4 grid grid-cols-2 gap-3 shrink-0">
				<div class="bg-white p-4 rounded-2xl shadow-sm border border-indigo-50">
					<p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">H√¥m nay</p>
					<p class="text-xl font-bold text-indigo-700 mt-1 font-display truncate" id="rev-today">0ƒë</p>
					<p id="order-count-today" class="text-[10px] text-indigo-400 mt-1 font-medium">0 ƒë∆°n</p>
				</div>
				<div class="bg-white p-4 rounded-2xl shadow-sm border border-purple-50">
					<p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Th√°ng n√†y</p>
					<p class="text-xl font-bold text-purple-700 mt-1 font-display truncate" id="rev-month">0ƒë</p>
					<p id="order-count-month" class="text-[10px] text-purple-400 mt-1 font-medium">0 ƒë∆°n</p>
				</div>
			</div>

			<div class="flex-1 bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] flex flex-col overflow-hidden border-t border-gray-100 mx-2">
				
				<div class="p-4 border-b border-gray-100 z-10 bg-white">
					<div class="flex items-center justify-between mb-3">
						<h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">üìä Chi ti·∫øt doanh s·ªë</h3>
						<button onclick="loadRevenue(); viewRevenueDetail();" class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 hover:bg-gray-200">üîÑ L√†m m·ªõi</button>
					</div>
					
					<div class="flex gap-2 mb-3">
						<div class="flex-1">
							<label class="text-[9px] font-bold text-gray-400 block mb-1 uppercase">T·ª´ ng√†y</label>
							<input type="date" id="filter-start" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs font-bold text-gray-700 outline-none focus:ring-1 focus:ring-indigo-500">
						</div>
						<div class="flex-1">
							<label class="text-[9px] font-bold text-gray-400 block mb-1 uppercase">ƒê·∫øn ng√†y</label>
							<input type="date" id="filter-end" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs font-bold text-gray-700 outline-none focus:ring-1 focus:ring-indigo-500">
						</div>
						<div class="flex items-end">
							<button onclick="viewRevenueDetail()" class="bg-indigo-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-md active:bg-indigo-700 transition-transform">
								üîç
							</button>
						</div>
					</div>

					<div class="flex justify-between items-center bg-indigo-50 p-2.5 rounded-xl border border-indigo-100">
						<span class="text-xs text-indigo-600 font-bold" id="filter-count">0 ƒë∆°n h√†ng</span>
						<span class="text-base font-bold text-indigo-700 font-display" id="filter-sum">0ƒë</span>
					</div>
					
					<button onclick="exportRevenueReport()" class="w-full mt-2 text-[10px] text-emerald-600 font-bold border border-emerald-200 bg-emerald-50 py-2 rounded-lg hover:bg-emerald-100">
						üì• Xu·∫•t Excel (Theo ng√†y ƒë√£ ch·ªçn)
					</button>
				</div>

				<div id="revenue-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50 pb-20">
					</div>
			</div>
		</div>
		
		<div id="admin-users" class="hidden flex-1 flex flex-col overflow-hidden bg-gray-50 h-full">
			<div class="p-3 bg-white border-b shadow-sm">
				<h3 class="font-bold text-gray-700">Danh s√°ch t√†i kho·∫£n</h3>
				<p class="text-[10px] text-gray-400">Tr·∫°ng th√°i c·∫≠p nh·∫≠t m·ªói 30 gi√¢y</p>
			</div>
			<div id="user-list" class="flex-1 overflow-y-auto p-3 space-y-2 pb-20">
				</div>
		</div>
		
		<div id="admin-system" class="hidden flex-1 flex flex-col bg-gray-50 h-full p-4 space-y-4">
			<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
				<div class="flex justify-between items-center mb-4">
					<div>
						<h3 class="font-bold text-gray-800 text-lg">Ch·∫ø ƒë·ªô B·∫£o tr√¨ üöß</h3>
						<p class="text-xs text-gray-500">Khi b·∫≠t, ch·ªâ Admin m·ªõi c√≥ th·ªÉ ƒëƒÉng nh·∫≠p.</p>
					</div>
					<label class="relative inline-flex items-center cursor-pointer">
						<input type="checkbox" id="sys-maintenance-toggle" class="sr-only peer">
						<div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
					</label>
				</div>

				<div class="space-y-2">
					<label class="text-xs font-bold text-gray-500 uppercase">Th√¥ng b√°o hi·ªÉn th·ªã</label>
					<textarea id="sys-message" rows="3" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Nh·∫≠p l·ªùi nh·∫Øn cho nh√¢n vi√™n..."></textarea>
				</div>

				<button onclick="saveSystemSettings()" class="mt-4 w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">L∆ØU C√ÄI ƒê·∫∂T</button>
			</div>
		</div>
    </div>

    <div id="payment-screen" class="hidden h-dvh w-full flex flex-col bg-gray-50 absolute inset-0 z-50">
        <div class="bg-white p-4 shadow-sm flex items-center gap-3 sticky top-0 z-20">
            <button onclick="backToScan()" class="p-2 -ml-2 hover:bg-gray-100 rounded-full">‚¨Ö</button>
            <h2 class="font-bold text-lg">Thanh to√°n</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3 pb-40" id="cart-list"></div>
        <div class="sticky bottom-0 z-30 bg-white p-5 border-t rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] pb-[env(safe-area-inset-bottom)]">
			<div class="flex flex-col items-center justify-center mb-6 border-b border-dashed pb-6">
				<span class="text-gray-400 font-bold text-xs uppercase tracking-widest mb-1">T·ªïng ti·ªÅn c·∫ßn thu</span>
				<span id="final-total" class="text-5xl font-bold text-blue-600 tracking-tight">0ƒë</span>
			</div>
			<div class="mb-4">
				<div class="flex justify-between mb-1">
					<label class="text-xs font-bold text-gray-400 uppercase">Kh√°ch ƒë∆∞a</label>
					<button onclick="setExactMoney()" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">Nh·∫≠p ƒë√∫ng s·ªë ti·ªÅn</button>
				</div>
				<div class="relative">
					<input type="number" id="money-received" placeholder="0" class="w-full bg-gray-100 p-3 rounded-xl text-xl font-bold text-gray-800 outline-none focus:ring-2 focus:ring-blue-500" oninput="calculateChange()">
				</div>
				<div class="flex gap-2 mt-2 overflow-x-auto pb-1 no-scrollbar">
					<button onclick="addMoney(500000)" class="bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap active:bg-green-100">+500k</button>
					<button onclick="addMoney(200000)" class="bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap active:bg-green-100">+200k</button>
					<button onclick="addMoney(100000)" class="bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap active:bg-green-100">+100k</button>
					<button onclick="addMoney(50000)" class="bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap active:bg-green-100">+50k</button>
				</div>
			</div>
			<div class="flex justify-between items-center bg-orange-50 p-3 rounded-xl border border-orange-100 mb-4">
				<span class="text-orange-800 font-bold text-sm">Ti·ªÅn th·ª´a:</span>
				<span id="change-amount" class="text-2xl font-bold text-orange-600">0ƒë</span>
			</div>
			
			<button onclick="processPayment()" 
				id="btn-confirm-pay" 
				class="w-full bg-gray-200 text-gray-400 p-4 rounded-xl font-bold text-lg shadow-none transition-all duration-300 flex justify-center items-center gap-2 group">
				X√ÅC NH·∫¨N THANH TO√ÅN
			</button>
		</div>
    </div>

    <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
		<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg h-[85vh] flex flex-col overflow-hidden">
			<div class="p-4 border-b flex justify-between items-center bg-gray-50">
				<h3 class="font-bold text-gray-800">L·ªãch s·ª≠ giao d·ªãch</h3>
				<button onclick="document.getElementById('history-modal').classList.add('hidden')" class="text-2xl text-gray-400">√ó</button>
			</div>
			<div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-100"></div>
		</div>
	</div>

	<div id="history-detail-panel" class="hidden fixed bottom-0 left-0 w-full h-[70vh] bg-white rounded-t-2xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] flex flex-col z-[60] transition-transform duration-300">
		<div class="p-4 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-2xl">
			<div>
				<h4 class="font-bold text-lg" id="hist-detail-id">#Order</h4>
				<p class="text-xs opacity-80" id="hist-detail-time">...</p>
			</div>
			<button onclick="document.getElementById('history-detail-panel').classList.add('hidden')" class="bg-white/20 hover:bg-white/30 p-2 rounded-full">‚ñº</button>
		</div>
		
		<div class="flex-1 overflow-y-auto p-0">
			<table class="w-full history-table">
				<thead>
					<tr>
						<th>T√™n SP / M√£</th>
						<th class="text-right">SL</th>
						<th class="text-right">Gi√°</th>
						<th class="text-right">T·ªïng</th>
					</tr>
				</thead>
				<tbody id="hist-detail-items"></tbody>
			</table>
		</div>
		
		<div class="p-4 bg-gray-50 border-t space-y-2">
			<div class="flex justify-between text-sm">
				<span class="text-gray-500">T·ªïng ti·ªÅn h√†ng:</span>
				<span class="font-bold text-gray-800" id="hist-detail-total">0ƒë</span>
			</div>
			<div class="flex justify-between text-sm">
				<span class="text-gray-500">Kh√°ch ƒë∆∞a:</span>
				<span class="font-bold text-blue-600" id="hist-detail-received">---</span>
			</div>
			<div class="flex justify-between text-lg pt-2 border-t border-dashed border-gray-300">
				<span class="font-bold text-orange-600">Ti·ªÅn th·ªëi l·∫°i:</span>
				<span class="font-bold text-orange-600" id="hist-detail-change">---</span>
			</div>
		</div>
	</div>

    <div id="recall-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-orange-50 rounded-t-xl"><h3 class="font-bold text-orange-800">Giao d·ªãch ch·ªù</h3><button onclick="document.getElementById('recall-modal').classList.add('hidden')" class="text-2xl text-gray-400">√ó</button></div>
            <div id="parked-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        </div>
    </div>

    <div id="product-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col max-h-[90vh]">
            <div class="p-4 border-b font-bold text-lg">Th√¥ng tin s·∫£n ph·∫©m</div>
            <div class="p-4 overflow-y-auto space-y-3">
				<input type="hidden" id="prod-id">
				
				<div>
					<label class="text-xs font-bold text-gray-500">T√™n SP *</label>
					<input type="text" id="prod-name" class="w-full border p-2 rounded focus:ring-1 focus:ring-blue-500">
				</div>

				<div class="grid grid-cols-2 gap-2">
					<div><label class="text-xs font-bold text-gray-500">M√£ v·∫°ch</label><input type="text" id="prod-barcode" class="w-full border p-2 rounded"></div>
					<div><label class="text-xs font-bold text-blue-600">M√£ Item</label><input type="text" id="prod-itemcode" class="w-full border p-2 rounded border-blue-200 bg-blue-50"></div>
				</div>

				<div class="grid grid-cols-2 gap-2">
					<div><label class="text-xs font-bold text-gray-500">ƒê∆°n v·ªã t√≠nh</label><input type="text" id="prod-unit" class="w-full border p-2 rounded"></div>
					<div>
						<label class="text-xs font-bold text-purple-600">T·ªìn kho üì¶</label>
						<input type="number" id="prod-quantity" class="w-full border-2 border-purple-200 bg-purple-50 p-2 rounded font-bold text-purple-700">
					</div>
				</div>

				<div class="grid grid-cols-2 gap-2">
					<div><label class="text-xs font-bold text-gray-500">Gi√° b√°n *</label><input type="number" id="prod-price" class="w-full border p-2 rounded"></div>
					<div><label class="text-xs font-bold text-red-500">Gi√° KM</label><input type="number" id="prod-sale" class="w-full border p-2 rounded bg-red-50"></div>
				</div>
				
				<div><label class="text-xs font-bold text-gray-500">Link ·∫¢nh</label><input type="text" id="prod-image" class="w-full border p-2 rounded"></div>
			</div>
            <div class="p-4 border-t grid grid-cols-2 gap-3"><button onclick="document.getElementById('product-modal').classList.add('hidden')" class="bg-gray-100 text-gray-600 py-2 rounded font-bold">H·ªßy</button><button onclick="saveProduct()" class="bg-blue-600 text-white py-2 rounded font-bold">L∆∞u</button></div>
        </div>
    </div>
	
	<div id="custom-alert" class="hidden fixed inset-0 flex items-center justify-center modal-overlay p-4">
		<div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-enter flex flex-col">
			<div id="alert-header" class="p-6 pb-2 text-center">
				<div id="alert-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl bg-blue-50 text-blue-600">‚ÑπÔ∏è</div>
				<h3 id="alert-title" class="text-xl font-bold text-gray-800">Th√¥ng b√°o</h3>
			</div>
			<div class="px-6 pb-6 text-center"><p id="alert-msg" class="text-gray-500">N·ªôi dung...</p></div>
			<div class="grid grid-cols-2 gap-0 border-t bg-gray-50" id="alert-actions"></div>
		</div>
	</div>

	<div id="qr-modal" class="hidden fixed inset-0 z-[70] bg-black bg-opacity-60 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
		<div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm flex flex-col items-center relative animate-popIn">
			
			<button onclick="closeQRModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center transition">
				‚úï
			</button>

			<h3 class="font-bold text-xl text-gray-800 mb-1">Th·∫ª Nh√¢n Vi√™n</h3>
			<p class="text-xs text-gray-400 mb-6">D√πng ƒë·ªÉ ƒëƒÉng nh·∫≠p nhanh</p>

			<div class="bg-white p-3 border-2 border-dashed border-gray-300 rounded-xl mb-4">
				<div id="qr-code-container"></div>
			</div>

			<div class="text-center mb-6">
				<p class="text-xs font-bold text-gray-500 uppercase tracking-wider">T√†i kho·∫£n</p>
				<p id="qr-user-email" class="font-bold text-blue-600 text-lg"></p>
			</div>

			<div class="flex gap-2 w-full">
				<button onclick="downloadQR()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-1">
					‚¨áÔ∏è L∆∞u
				</button>

				<button onclick="printQR()" class="flex-1 bg-gray-800 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-1">
					üñ®Ô∏è In
				</button>
				
				<button onclick="closeQRModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold active:scale-95 transition-transform">
					ƒê√≥ng
				</button>
			</div>
		</div>
	</div>

	<div id="password-input-modal" class="hidden fixed inset-0 z-[9999] bg-black bg-opacity-60 flex items-center justify-center p-4 backdrop-blur-sm">
		<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm animate-popIn relative z-[10000]" onclick="event.stopPropagation()">
			<h3 class="font-bold text-lg text-gray-800 mb-2">üîí X√°c th·ª±c Admin</h3>
			<p class="text-sm text-gray-500 mb-4">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c·ªßa nh√¢n vi√™n ƒë·ªÉ t·∫°o m√£ QR ƒëƒÉng nh·∫≠p.</p>
			
			<!--<input type="password" id="qr-password-input" 
				   class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none mb-4 select-text text-gray-900 bg-white" 
				   placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autocomplete="off">-->
			<input 
				type="password" 
				id="qr-password-input" 
				class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none mb-4 select-text text-gray-900 bg-white" 
				placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." 
				autocomplete="off"
				enterkeyhint="go" 
			>
			<div class="flex gap-3 justify-end">
				<button onclick="closePassModal()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200">H·ªßy</button>
				<button onclick="submitQRPassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700">T·∫°o M√£</button>
			</div>
		</div>
	</div>

	<div id="scan-settings-modal" class="hidden fixed inset-0 z-[80] bg-black bg-opacity-60 flex items-center justify-center p-4 backdrop-blur-sm">
		<div class="bg-white rounded-2xl shadow-2xl p-5 w-full max-w-sm animate-popIn">
			<div class="flex justify-between items-center mb-4 border-b pb-2">
				<h3 class="font-bold text-lg text-gray-800">‚öôÔ∏è C√†i ƒë·∫∑t N√∫t Qu√©t</h3>
				<button onclick="document.getElementById('scan-settings-modal').classList.add('hidden')" class="text-gray-400 text-xl">‚úï</button>
			</div>

			<div class="space-y-3">
				
				<label class="flex items-center justify-between p-3 border rounded-xl cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
					<div class="flex items-center gap-3">
						<span class="text-xl">üî≥</span>
						<div>
							<div class="font-bold text-gray-800 text-sm">N√∫t to gi·ªØa m√†n h√¨nh</div>
							<div class="text-[10px] text-gray-500">Giao di·ªán g·ªëc (Kh√¥ng c√≥ n√∫t nh·ªè)</div>
						</div>
					</div>
					<input type="radio" name="scan_mode" value="default" class="w-5 h-5 text-blue-600" onchange="saveScanMode('default')">
				</label>

				<label class="flex items-center justify-between p-3 border rounded-xl cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
					<div class="flex items-center gap-3">
						<span class="text-blue-600">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
							  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z" />
							  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75zM6.75 16.5h.75v.75h-.75v-.75zM16.5 6.75h.75v.75h-.75v-.75zM13.5 13.5h.75v.75h-.75v-.75zM13.5 19.5h.75v.75h-.75v-.75zM19.5 13.5h.75v.75h-.75v-.75zM16.5 16.5h.75v.75h-.75v-.75zM16.5 19.5h.75v.75h-.75v-.75z" />
							</svg>
						</span>
						
						<div>
							<div class="font-bold text-gray-800 text-sm">N√∫t nh·ªè: T·∫Øt / M·ªü</div>
							<div class="text-[10px] text-gray-500">N√∫t nh·ªè c·∫°nh √¥ nh·∫≠p. ·∫®n n√∫t to.</div>
						</div>
					</div>
					<input type="radio" name="scan_mode" value="toggle" class="w-5 h-5 text-blue-600" onchange="saveScanMode('toggle')">
				</label>

				<label class="flex items-center justify-between p-3 border rounded-xl cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
					<div class="flex items-center gap-3">
						<span class="text-xl">üëÜ</span>
						<div>
							<div class="font-bold text-gray-800 text-sm">N√∫t nh·ªè: Gi·ªØ ƒë·ªÉ qu√©t</div>
							<div class="text-[10px] text-gray-500">Gi·ªØ tay camera b·∫≠t. ·∫®n n√∫t to.</div>
						</div>
					</div>
					<input type="radio" name="scan_mode" value="hold" class="w-5 h-5 text-blue-600" onchange="saveScanMode('hold')">
				</label>
			</div>

			<div class="mt-6">
				<button onclick="document.getElementById('scan-settings-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">ƒê√≥ng</button>
			</div>
		</div>
	</div>

    <script>
        const SUPABASE_URL = 'https://renqusdcczlhrglbclhe.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlbnF1c2RjY3psaHJnbGJjbGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTIyMzUsImV4cCI6MjA4MDU4ODIzNX0.kF960FS-VvAM2rkNo9kVHfmGAkpwrmlZ5Vf9-QFiC2E';
        
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
			auth: {
				storage: sessionStorage,
				autoRefreshToken: true,
				persistSession: true,
				detectSessionInUrl: true
			}
		});
        const PLACEHOLDER_IMG = "data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2250%22%20height%3D%2250%22%20viewBox%3D%220%200%2050%2050%22%3E%3Crect%20width%3D%2250%22%20height%3D%2250%22%20fill%3D%22%23e5e7eb%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22sans-serif%22%20font-size%3D%2212%22%20fill%3D%22%239ca3af%22%3EIMG%3C%2Ftext%3E%3C%2Fsvg%3E";

        let productsDB = [];

		let cart = JSON.parse(localStorage.getItem('pos_current_cart')) || []; 
		let parkedOrders = JSON.parse(localStorage.getItem('pos_parked_orders')) || [];
		
        let html5QrcodeScanner = null, currentUserEmail = "", currentMultiplier = 1, currentUserRole = "staff";
		
		let lastScannedCode = null;
		let lastScanTime = 0;
		const SCAN_DELAY = 2000;

		// --- LOGIC KI·ªÇM TRA GI√Å M·ªöI ---
		let isCheckPriceMode = false;

		function toggleCheckPriceMode() {
			isCheckPriceMode = !isCheckPriceMode;
			
			const salesPanel = document.getElementById('sales-panel');
			const checkPanel = document.getElementById('check-price-panel');
			const scanFrame = document.querySelector('.border-green-400'); // Khung qu√©t (n·∫øu c√≥)
			
			if (isCheckPriceMode) {
				// B·∫≠t ch·∫ø ƒë·ªô xem gi√°
				salesPanel.classList.add('hidden');
				checkPanel.classList.remove('hidden');
				document.getElementById('check-price-input').focus();
				
				// ƒê·ªïi m√†u khung qu√©t sang m√†u Teal cho d·ªÖ nh·∫≠n bi·∫øt (n·∫øu mu·ªën)
				showAlert("ƒê√£ b·∫≠t ch·∫ø ƒë·ªô xem gi√°", "M·ªçi m√£ qu√©t l√∫c n√†y s·∫Ω ch·ªâ hi·ªán gi√°.", "info");
			} else {
				// T·∫Øt ch·∫ø ƒë·ªô, quay v·ªÅ b√°n h√†ng
				salesPanel.classList.remove('hidden');
				checkPanel.classList.add('hidden');
				
				// Reset k·∫øt qu·∫£
				document.getElementById('check-result-container').innerHTML = `
					<div class="opacity-50 grayscale">
						<div class="text-5xl mb-2">üè∑Ô∏è</div>
						<p class="text-gray-400 text-sm">M·ªùi qu√©t s·∫£n ph·∫©m...</p>
					</div>`;
			}
		}

		// H√†m x·ª≠ l√Ω nh·∫≠p tay ·ªü ch·∫ø ƒë·ªô xem gi√°
		function handleCheckPriceManual(e) {
			if (e.key === 'Enter') {
				const val = e.target.value.trim();
				if (val) processCheckPrice(val);
				e.target.value = '';
				e.target.blur();
			}
		}

		// H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ (Render v√†o khung b√™n d∆∞·ªõi)
		function processCheckPrice(key) {
			const k = key.trim().toLowerCase();
			const p = productsDB.find(x => (x.barcode == k || (x.item_code && x.item_code.toLowerCase() == k))) || productsDB.find(x => x.name.toLowerCase().includes(k));
			
			const el = document.getElementById('check-result-container');
			
			if (!p) {
				el.innerHTML = `<div class="text-5xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</div><h3 class="text-red-500 font-bold text-xl">Kh√¥ng t√¨m th·∫•y!</h3><p class="text-xs text-gray-400">M√£: ${key}</p>`;
				// Ph√°t √¢m thanh l·ªói n·∫øu c·∫ßn
				if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
				return;
			}

			// N·∫øu t√¨m th·∫•y -> Hi·ªÉn th·ªã ƒë·∫πp
			let priceHtml = '';
			if (p.sale_price && p.sale_price < p.price) {
				priceHtml = `
					<div class="flex items-end gap-2 justify-center mt-1">
						<span class="text-gray-400 line-through text-lg font-medium">${formatMoney(p.price)}</span>
						<span class="text-red-600 font-bold text-4xl font-display">${formatMoney(p.sale_price)}</span>
					</div>
					<span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold mt-2 inline-block animate-pulse">üî• ƒêang gi·∫£m gi√°</span>`;
			} else {
				priceHtml = `<div class="text-teal-600 font-bold text-4xl mt-2 font-display">${formatMoney(p.price)}</div>`;
			}

			el.innerHTML = `
				<div class="flex gap-4 items-center w-full text-left">
					<img src="${p.image || PLACEHOLDER_IMG}" class="w-24 h-24 object-cover rounded-xl shadow-sm border border-gray-100 bg-white">
					<div class="flex-1">
						<h3 class="font-bold text-gray-800 text-lg leading-tight line-clamp-2">${p.name}</h3>
						<div class="flex gap-2 mt-1">
							<span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold border">M√£: ${p.barcode || '---'}</span>
							<span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold border">ƒêVT: ${p.unit || 'C√°i'}</span>
						</div>
					</div>
				</div>
				<div class="mt-2 w-full border-t border-dashed border-teal-100 pt-2 text-center">
					${priceHtml}
					${p.is_locked ? '<div class="mt-2 text-red-500 font-bold text-xs bg-red-50 p-2 rounded border border-red-100">üîí S·∫¢N PH·∫®M ƒêANG KH√ìA</div>' : ''}
				</div>
			`;
			
			if(navigator.vibrate) navigator.vibrate(50);
		}

        // === SYSTEM FUNCTIONS ===
        async function checkSession() {
			try {
				const { data: { session }, error } = await client.auth.getSession();
				if (error) throw error;
				
				if (session) {
					currentUserEmail = session.user.email;
					
					// 1. L·∫•y Role tr∆∞·ªõc
					await fetchUserRole(currentUserEmail); 

					// 2. --- KI·ªÇM TRA B·∫¢O TR√å NGAY SAU KHI C√ì ROLE ---
					const { data: settings } = await client.from('app_settings').select('*').eq('id', 1).single();
					
					if (settings && settings.maintenance_mode && currentUserRole !== 'admin') {
						showAlert("B·∫¢O TR√å", settings.maintenance_message || "H·ªá th·ªëng ƒëang b·∫£o tr√¨.", 'error', () => {
							forceLogout();
						});
						return; // D·ª´ng l·∫°i, kh√¥ng cho v√†o App
					}
					// ------------------------------------------------

					// N·∫øu qua ƒë∆∞·ª£c c·ª≠a ·∫£i tr√™n th√¨ m·ªõi v√†o App
					document.getElementById('user-email').innerText = currentUserEmail.split('@')[0];
					document.getElementById('login-screen').classList.add('hidden'); 
					document.getElementById('scan-screen').classList.remove('hidden');
					
					fetchProducts(); 
					updateParkedBadge();
					updateCartUI();
					startHeartbeat();
				}
			} catch (err) { console.log(err); forceLogout(); }
		}
        async function handleLogin() {
			// 1. L·∫•y gi√° tr·ªã v√† TRIM (x√≥a kho·∫£ng tr·∫Øng th·ª´a ƒë·∫ßu ƒëu√¥i)
			const email = document.getElementById('email').value.trim();
			const password = document.getElementById('password').value.trim();

			// 2. Ki·ªÉm tra n·∫øu ƒë·ªÉ tr·ªëng th√¨ b√°o l·ªói ngay, kh√¥ng g·ª≠i l√™n server
			if (!email || !password) {
				document.getElementById('login-msg').innerText = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß Email v√† M·∫≠t kh·∫©u!";
				return;
			}

			// 3. G·ª≠i y√™u c·∫ßu ƒëƒÉng nh·∫≠p
			const { error } = await client.auth.signInWithPassword({ email, password });

			if (error) {
				console.error("L·ªói ƒëƒÉng nh·∫≠p:", error); // Xem l·ªói chi ti·∫øt trong Console (F12)
				
				// D·ªãch m·ªôt s·ªë l·ªói ph·ªï bi·∫øn sang ti·∫øng Vi·ªát
				if (error.message.includes("Invalid login credentials")) {
					document.getElementById('login-msg').innerText = "‚ùå Sai Email ho·∫∑c M·∫≠t kh·∫©u!";
				} else if (error.message.includes("Email not confirmed")) {
					document.getElementById('login-msg').innerText = "üìß Email ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c (Vui l√≤ng t·∫Øt Confirm Email trong Supabase)";
				} else {
					document.getElementById('login-msg').innerText = "‚ùå L·ªói: " + error.message;
				}
			} else {
				checkSession();
			}
		}
        async function forceLogout() { await client.auth.signOut(); localStorage.clear(); window.location.reload(); }
        
        async function fetchUserRole(email) {
			try {
				const { data } = await client
					.from('app_users') 
					.select('role')
					.eq('email', email)
					.maybeSingle(); // D√πng maybeSingle cho an to√†n

				currentUserRole = data ? data.role : 'staff';
				
				// C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
				if(currentUserRole === 'admin') {
					document.getElementById('btn-open-admin').classList.remove('hidden');
				} else {
					document.getElementById('btn-open-admin').classList.add('hidden');
				}
			} catch (e) { console.log(e); }
		}

        // ======================= CUSTOM MODAL LOGIC (TR√ÅI TIM UI M·ªöI) =======================
        let modalCallback = null;

        function showAlert(title, msg, type = 'info', callback = null) {
            const modal = document.getElementById('custom-alert');
            const iconEl = document.getElementById('alert-icon');
            const actionsEl = document.getElementById('alert-actions');
            
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerHTML = msg;
            modalCallback = callback;

            // C·∫•u h√¨nh giao di·ªán theo lo·∫°i th√¥ng b√°o
            let iconHtml = '‚ÑπÔ∏è', colorClass = 'bg-blue-50 text-blue-600', btnsHtml = '';

            if (type === 'success') {
                iconHtml = '‚úÖ'; colorClass = 'bg-green-50 text-green-600';
                btnsHtml = `<button onclick="closeAlert()" class="col-span-2 py-4 text-green-600 font-bold hover:bg-green-50">ƒê√≥ng</button>`;
            } else if (type === 'error') {
                iconHtml = '‚ö†Ô∏è'; colorClass = 'bg-red-50 text-red-600';
                btnsHtml = `<button onclick="closeAlert()" class="col-span-2 py-4 text-red-600 font-bold hover:bg-red-50">ƒê√≥ng</button>`;
            } else if (type === 'confirm') {
                iconHtml = '‚ùì'; colorClass = 'bg-orange-50 text-orange-600';
                btnsHtml = `
                    <button onclick="closeAlert()" class="py-4 text-gray-500 font-semibold hover:bg-gray-100 border-r">H·ªßy</button>
                    <button onclick="confirmAction()" class="py-4 text-blue-600 font-bold hover:bg-blue-50">ƒê·ªìng √Ω</button>`;
            } else {
                btnsHtml = `<button onclick="closeAlert()" class="col-span-2 py-4 text-blue-600 font-bold hover:bg-blue-50">OK</button>`;
            }

            iconEl.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl ${colorClass}`;
            iconEl.innerHTML = iconHtml;
            actionsEl.innerHTML = btnsHtml;
            modal.classList.remove('hidden');
        }

        function closeAlert() {
            document.getElementById('custom-alert').classList.add('hidden');
            modalCallback = null;
        }

        function confirmAction() {
            if (modalCallback) modalCallback();
            closeAlert();
        }

        // ======================= APP LOGIC =======================

        async function fetchProducts() {
            let { data, error } = await client.from('products').select('*').order('created_at', { ascending: false });
            if (error) { const res = await client.from('products').select('*'); data = res.data; }
            if (data) { productsDB = data; renderProductList(); }
        }

        // --- SCANNER ---
        function startScanner() {
			// 1. Ki·ªÉm tra n·∫øu ƒëang ch·∫°y th√¨ kh√¥ng b·∫≠t th√™m (tr√°nh l·ªói "Already under transition")
			if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
				return;
			}

			// 2. ·∫®n giao di·ªán ch·ªù, hi·ªán n√∫t t·∫Øt
			document.getElementById('camera-placeholder').classList.add('hidden');
			const btnStop = document.getElementById('btn-stop-cam');
			if(btnStop) btnStop.classList.remove('hidden');
			
			// 3. Kh·ªüi t·∫°o th∆∞ vi·ªán
			// L∆∞u √Ω: verbose=false ƒë·ªÉ t·∫Øt log r√°c trong console
			html5QrcodeScanner = new Html5Qrcode("reader", { verbose: false });
			
			// 4. C·∫•u h√¨nh qu√©t (Gi·ªØ nguy√™n c√°c t·ªëi ∆∞u t·ªëc ƒë·ªô)
			const config = {
				fps: 25, 
				qrbox: { width: 250, height: 250 }, // V√πng qu√©t (logic)
				aspectRatio: window.innerWidth / window.innerHeight,
				formatsToSupport: [ 
					Html5QrcodeSupportedFormats.EAN_13,
					Html5QrcodeSupportedFormats.EAN_8,
					Html5QrcodeSupportedFormats.CODE_128,
					Html5QrcodeSupportedFormats.UPC_A,
					Html5QrcodeSupportedFormats.UPC_E,
					Html5QrcodeSupportedFormats.QR_CODE
				]
			};

			// 5. B·∫Øt ƒë·∫ßu qu√©t
			// S·ª¨A L·ªñI: Ch·ªâ truy·ªÅn { facingMode: "environment" }, KH√îNG truy·ªÅn th√™m focusMode
			html5QrcodeScanner.start(
				{ facingMode: "environment" }, 
				config, 
				(decodedText) => {
					const currentTime = Date.now();

					// LOGIC CH·ªêNG QU√âT LI√äN T·ª§C:
					// N·∫øu m√£ n√†y GI·ªêNG m√£ v·ª´a qu√©t V√Ä th·ªùi gian ch∆∞a ƒë·ªß 2 gi√¢y -> B·ªé QUA
					if (decodedText === lastScannedCode && (currentTime - lastScanTime < SCAN_DELAY)) {
						return; 
					}

					// N·∫øu m√£ kh√°c ho·∫∑c ƒë√£ ƒë·ªß th·ªùi gian ch·ªù -> Ch·∫•p nh·∫≠n
					lastScannedCode = decodedText;
					lastScanTime = currentTime;

					// Ph√°t ti·∫øng "B√≠p" nh·∫π ƒë·ªÉ b√°o hi·ªáu ƒë√£ nh·∫≠n (n·∫øu mu·ªën)
					playBeepSound(); 

					// Th√™m v√†o gi·ªè
					addToCart(decodedText);
				}, 
				() => {}
			).catch(err => {
				console.error("L·ªói kh·ªüi ƒë·ªông Camera:", err);
				
				// --- X·ª¨ L√ù L·ªñI C·ª§ TH·ªÇ ---
				// 1. L·ªói b·ªã ch·∫∑n quy·ªÅn (NotAllowedError)
				if (err.name === "NotAllowedError" || err.toString().includes("Permission")) {
					 showAlert("‚ö†Ô∏è KH√îNG TH·ªÇ M·ªû CAMERA!",'L√Ω do: B·∫°n ƒë√£ ch·∫∑n quy·ªÅn truy c·∫≠p.\n\nC√°ch s·ª≠a: B·∫•m v√†o bi·ªÉu t∆∞·ª£ng ·ªï kh√≥a üîí tr√™n thanh ƒë·ªãa ch·ªâ -> B·∫≠t quy·ªÅn Camera -> T·∫£i l·∫°i trang.','error');
				} 
				// 2. L·ªói do camera ƒëang b·∫≠n ho·∫∑c kh·ªüi ƒë·ªông ch∆∞a xong (Transition)
				else if (err.toString().includes("transition")) {
					 console.log("Camera ƒëang kh·ªüi ƒë·ªông, vui l√≤ng ch·ªù...");
					 return; // Kh√¥ng c·∫ßn stopScanner, c·ª© ƒë·ªÉ n√≥ ch·∫°y ti·∫øp
				} 
				// 3. C√°c l·ªói kh√°c
				else {
					 showAlert("L·ªói",'L·ªói kh√¥ng x√°c ƒë·ªãnh: ' + err, 'error');
				}

				// Reset v·ªÅ m√†n h√¨nh ch·ªù n·∫øu g·∫∑p l·ªói nghi√™m tr·ªçng
				stopScanner(); 
			});
		}
		
		function playBeepSound() {
			// T·∫°o √¢m thanh b√≠p ng·∫Øn b·∫±ng Web Audio API (kh√¥ng c·∫ßn file mp3)
			const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
			const oscillator = audioCtx.createOscillator();
			const gainNode = audioCtx.createGain();

			oscillator.connect(gainNode);
			gainNode.connect(audioCtx.destination);

			oscillator.type = "sine"; // Ki·ªÉu √¢m thanh
			oscillator.frequency.value = 800; // T·∫ßn s·ªë (ƒë·ªô cao)
			gainNode.gain.value = 0.1; // √Çm l∆∞·ª£ng nh·ªè v·ª´a ph·∫£i

			oscillator.start();
			setTimeout(() => oscillator.stop(), 100); // K√™u trong 0.1 gi√¢y r·ªìi t·∫Øt
		}
		
        async function stopScanner() {
            if (html5QrcodeScanner) {
                try { 
					await html5QrcodeScanner.stop(); 
					html5QrcodeScanner = null;
					
					if (currentScanMode === 'default') {
						document.getElementById('camera-placeholder').classList.remove('hidden'); 
					} else {
						// N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô n√∫t nh·ªè th√¨ v·∫´n ·∫©n n√∫t to
						document.getElementById('camera-placeholder').classList.add('hidden');
					}
					
					//document.getElementById('camera-placeholder').classList.remove('hidden'); 
					document.getElementById('btn-stop-cam').classList.add('hidden'); 
				} 
                catch (err) { 
					console.log(err); 
				}
            }
        }

        // --- CART ---
        function addToCart(key) {
			// 1. Ch·∫ø ƒë·ªô xem gi√°
			if (isCheckPriceMode) {
				processCheckPrice(key);
				return; 
			}

			const k = key.trim().toLowerCase(); if(!k) return;
			
			// 2. T√¨m s·∫£n ph·∫©m
			const p = productsDB.find(x => (x.barcode==k || (x.item_code && x.item_code.toLowerCase()==k))) || productsDB.find(x => x.name.toLowerCase().includes(k));
			
			if(!p) return showAlert("Kh√¥ng t√¨m th·∫•y", `Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o kh·ªõp v·ªõi m√£ "${key}"`, 'error');
			
			// 3. Ki·ªÉm tra kh√≥a s·∫£n ph·∫©m
			if(p.is_locked) return showAlert("S·∫£n ph·∫©m kh√≥a", "S·∫£n ph·∫©m n√†y ƒëang t·∫°m ng∆∞ng kinh doanh.", 'error');

			// 4. KI·ªÇM TRA T·ªíN KHO
			if ((p.quantity || 0) <= 0) {
				return showAlert("H·∫øt h√†ng", `S·∫£n ph·∫©m "${p.name}" ƒë√£ h·∫øt h√†ng trong kho!`, 'error');
			}
			
			// T√¨m xem m√≥n n√†y ƒë√£ c√≥ trong gi·ªè ch∆∞a
			// (L·∫ßn khai b√°o ƒë·∫ßu ti√™n - Gi·ªØ nguy√™n)
			const exist = cart.find(x => x.id === p.id);
			
			// Logic ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn kho so v·ªõi gi·ªè h√†ng
			const currentQtyInCart = exist ? exist.quantity : 0;
			if (currentQtyInCart + currentMultiplier > p.quantity) {
					return showAlert("Kh√¥ng ƒë·ªß h√†ng", `Trong kho ch·ªâ c√≤n ${p.quantity}, b·∫°n ƒëang mua qu√° s·ªë l∆∞·ª£ng!`, 'error');
			}
			
			// 5. Th√™m v√†o gi·ªè
			const qty = currentMultiplier;
			const price = (p.sale_price && p.sale_price < p.price) ? p.sale_price : p.price;
			
			if(exist) {
				// --- ƒê√É S·ª¨A: ·ªû ƒë√¢y kh√¥ng d√πng 'const exist =' n·ªØa m√† d√πng tr·ª±c ti·∫øp bi·∫øn exist ƒë√£ t√¨m th·∫•y ·ªü tr√™n ---
				exist.quantity += qty; 
			} else {
				cart.push({...p, quantity: qty, finalPrice: price});
			}
			
			// 6. C·∫≠p nh·∫≠t giao di·ªán & Hi·ªáu ·ª©ng
			updateCartUI();
			
			document.getElementById('last-item-name').innerText = p.name;
			document.getElementById('last-item-info').innerText = `M√£: ${p.barcode || '---'} | ƒêVT: ${p.unit || '---'}`;
			const priceEl = document.getElementById('last-item-price-container');
			if(p.sale_price && p.sale_price < p.price) { 
				priceEl.innerHTML = `<span class="line-through text-gray-400 text-xs mr-2">${formatMoney(p.price)}</span><span class="text-red-600 font-bold text-sm">${formatMoney(p.sale_price)}</span>`; 
			} else { 
				priceEl.innerHTML = `<span class="font-bold text-blue-600 text-sm">${formatMoney(p.price)}</span>`; 
			}
			document.getElementById('last-item-qty').innerText = "+" + qty;
			
			document.getElementById('last-scanned-card').classList.remove('hidden', 'scan-success'); 
			void document.getElementById('last-scanned-card').offsetWidth; 
			document.getElementById('last-scanned-card').classList.add('scan-success');
			
			if(currentMultiplier > 1) { currentMultiplier = 1; document.getElementById('multiplier-badge').classList.add('hidden'); }
			if(navigator.vibrate) navigator.vibrate(100);
		}

        function updateCartUI() {
			// 1. T√≠nh to√°n
			const totalQty = cart.reduce((s, i) => s + i.quantity, 0);
			const totalMoney = cart.reduce((s, i) => s + (i.quantity * i.finalPrice), 0);

			// 2. L·∫•y c√°c ph·∫ßn t·ª≠
			const btn = document.getElementById('btn-cart-payment');
			const badge = document.getElementById('quick-count');
			const totalText = document.getElementById('quick-total');

			// 3. C·∫≠p nh·∫≠t Text
			// Logic n·∫£y s·ªë: X√≥a class c≈© -> ƒê·ª£i x√≠u -> Th√™m l·∫°i class ƒë·ªÉ n√≥ ch·∫°y l·∫°i animation
			badge.classList.remove('badge-pop');
			void badge.offsetWidth; // Hack: √âp tr√¨nh duy·ªát render l·∫°i ƒë·ªÉ reset animation
			badge.classList.add('badge-pop');
			
			badge.innerText = totalQty;
			totalText.innerText = formatMoney(totalMoney) + " ‚ûú";
			
			localStorage.setItem('pos_current_cart', JSON.stringify(cart));

			// 4. --- LOGIC GIAO DI·ªÜN CAO C·∫§P ---
			if (btn && badge) {
				if (totalQty > 0) {
					// === C√ì H√ÄNG: M√ÄU GRADIENT & PH√ÅT S√ÅNG ===
					
					// X√≥a style x√°m
					btn.classList.remove('bg-gray-200', 'text-gray-400', 'shadow-none', 'pointer-events-none');
					
					// Th√™m Gradient + B√≥ng + Hi·ªáu ·ª©ng nh·ªãp ƒë·∫≠p (pulse)
					// bg-gradient-to-r from-blue-600 to-blue-500: T·∫°o m√†u chuy·ªÉn s·∫Øc
					btn.classList.add(
						'bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', // M√†u chuy·ªÉn s·∫Øc
						'text-white', 
						'shadow-lg', 'shadow-blue-500/50', // B√≥ng ƒë·ªï m√†u xanh m·ªù
						'cursor-pointer',
						'cart-active-pulse' // Class t·ª± t·∫°o ·ªü B∆∞·ªõc 1
					);
					
					// Badge m√†u tr·∫Øng m·ªù sang tr·ªçng
					badge.className = "bg-white/20 px-3 py-1 rounded-lg text-sm font-bold backdrop-blur-md border border-white/20 badge-pop";

				} else {
					// === GI·ªé TR·ªêNG: X√ÅM CH√åM ===
					
					// Reset to√†n b·ªô class x·ªãn
					btn.className = "w-full bg-gray-100 text-gray-400 p-4 rounded-2xl font-bold text-xl shadow-inner flex justify-between items-center transition-all duration-300 pointer-events-none border border-gray-200";
					
					// Badge m√†u t·ªëi
					badge.className = "bg-gray-200 px-3 py-1 rounded-lg text-sm text-gray-400";
				}
			}
		}

        // --- PAYMENT ---
        function goToPayment() {
            if(cart.length==0) return showAlert("Gi·ªè h√†ng tr·ªëng", "Vui l√≤ng qu√©t th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.", 'info');
			
			history.pushState({view: 'payment'}, "Thanh to√°n", "#payment");
			
            if(html5QrcodeScanner) html5QrcodeScanner.pause();
            document.getElementById('scan-screen').classList.add('hidden'); document.getElementById('payment-screen').classList.remove('hidden');
            renderPaymentList();
        }
        function backToScan() {
            document.getElementById('payment-screen').classList.add('hidden'); document.getElementById('scan-screen').classList.remove('hidden');
            if(html5QrcodeScanner) html5QrcodeScanner.resume();
			
			history.back();
        }
        function renderPaymentList() {
            document.getElementById('cart-list').innerHTML = cart.map((i, idx) => `
                <div class="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm">
                    <div class="flex-1">
                        <div class="font-bold text-gray-800">${i.name}</div>
                        <div class="text-[11px] text-gray-500 font-semibold mb-1">M√£: ${i.barcode || '---'} | ƒêVT: ${i.unit || '---'}</div>
                        <div class="text-sm text-blue-600 font-bold">${formatMoney(i.finalPrice)} x ${i.quantity} = ${formatMoney(i.finalPrice * i.quantity)}</div>
                    </div>
                    <div class="flex items-center gap-3 ml-2">
                        <button onclick="changeQty(${idx}, -1)" class="w-9 h-9 bg-gray-100 rounded-lg font-bold text-gray-600 active:bg-gray-200">-</button>
                        <span class="font-bold w-6 text-center text-lg">${i.quantity}</span>
                        <button onclick="changeQty(${idx}, 1)" class="w-9 h-9 bg-blue-100 text-blue-600 rounded-lg font-bold active:bg-blue-200">+</button>
                    </div>
                </div>`).join('');
            const total = cart.reduce((s,i) => s + (i.quantity * i.finalPrice), 0);
            document.getElementById('final-total').innerText = formatMoney(total);
            calculateChange();
        }
        
        function changeQty(idx, d) { 
            const newQty = cart[idx].quantity + d;
            if (newQty <= 0) {
                showAlert("X√≥a s·∫£n ph·∫©m", `B·∫°n mu·ªën x√≥a "${cart[idx].name}" kh·ªèi gi·ªè?`, 'confirm', () => {
                    cart.splice(idx, 1);
                    finalizeChangeQty();
                });
            } else {
                cart[idx].quantity = newQty;
                finalizeChangeQty();
            }
        }
        function finalizeChangeQty() {
            updateCartUI();
            if (cart.length === 0) backToScan(); else renderPaymentList();
            const feedbackCard = document.getElementById('last-scanned-card');
            if(feedbackCard) feedbackCard.classList.add('hidden');
        }

		// --- H√ÄM X√ìA T·∫§T C·∫¢ S·∫¢N PH·∫®M ---
		async function deleteAllProducts() {
			showAlert(
				"C·∫¢NH B√ÅO", 
				"B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA S·∫†CH to√†n b·ªô danh s√°ch h√†ng h√≥a? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ kh√¥i ph·ª•c!", 
				'confirm', 
				async () => {
					// X√≥a t·∫•t c·∫£ d√≤ng c√≥ ID kh√°c 0 (nghƒ©a l√† x√≥a h·∫øt)
					const { error } = await client.from('products').delete().neq('id', 0);
					
					if (error) {
						showAlert("L·ªói", "Kh√¥ng th·ªÉ x√≥a: " + error.message, 'error');
					} else {
						showAlert("ƒê√£ x√≥a", "D·ªØ li·ªáu h√†ng h√≥a ƒë√£ ƒë∆∞·ª£c d·ªçn s·∫°ch.", 'success');
						fetchProducts(); // T·∫£i l·∫°i danh s√°ch tr·ªëng
					}
				}
			);
		}

        function calculateChange() {
			// 1. T√≠nh to√°n
			const total = cart.reduce((s, i) => s + (i.quantity * i.finalPrice), 0);
			const received = parseInt(document.getElementById('money-received').value) || 0;
			const change = received - total;

			// 2. Hi·ªÉn th·ªã text ti·ªÅn th·ª´a/thi·∫øu (Gi·ªØ nguy√™n logic c≈©)
			const el = document.getElementById('change-amount');
			el.innerText = change < 0 ? "Thi·∫øu " + formatMoney(Math.abs(change)) : formatMoney(change);
			el.className = change < 0 ? "text-2xl font-bold text-red-600" : "text-2xl font-bold text-green-600";

			// 3. --- LOGIC ƒê·ªîI M√ÄU N√öT X√ÅC NH·∫¨N (M·ªöI) ---
			const btn = document.getElementById('btn-confirm-pay');
			
			if (btn) {
				if (change >= 0) {
					// === TR∆Ø·ªúNG H·ª¢P 1: ƒê·ª¶ TI·ªÄN (S√ÅNG R·ª∞C) ===
					
					// X√≥a style "thi·∫øu ti·ªÅn"
					btn.classList.remove('bg-gray-200', 'text-gray-400', 'shadow-none', 'bg-red-50', 'text-red-500');
					
					// Th√™m hi·ªáu ·ª©ng Gradient + B√≥ng + Rung (Pulse) gi·ªëng n√∫t Gi·ªè h√†ng
					btn.classList.add(
						'bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', // M√†u chuy·ªÉn s·∫Øc
						'text-white',
						'shadow-lg', 'shadow-blue-500/50', // B√≥ng ƒë·ªï ph√°t s√°ng
						'active:scale-[0.98]', // Hi·ªáu ·ª©ng l√∫n xu·ªëng khi b·∫•m
						'cart-active-pulse' // Hi·ªáu ·ª©ng nh·ªãp ƒë·∫≠p
					);
					
					// ƒê·ªïi n·ªôi dung l·∫°i b√¨nh th∆∞·ªùng ‚úÖ ‚ö†Ô∏è
					btn.innerHTML = `<span>X√ÅC NH·∫¨N THANH TO√ÅN</span> <span class="text-xl"></span>`;
					
				} else {
					// === TR∆Ø·ªúNG H·ª¢P 2: THI·∫æU TI·ªÄN (X√ÅM HO·∫∂C ƒê·ªé NH·∫†T) ===
					
					// Reset style x·ªãn
					btn.className = "w-full p-4 rounded-xl font-bold text-lg transition-all duration-300 flex justify-center items-center gap-2 group";
					
					// Th√™m style c·∫£nh b√°o nh·∫π
					btn.classList.add('bg-red-50', 'text-red-400', 'shadow-inner', 'border', 'border-red-100');
					
					// B√°o lu√¥n s·ªë ti·ªÅn thi·∫øu tr√™n n√∫t
					btn.innerHTML = `<span>C√íN THI·∫æU: ${formatMoney(Math.abs(change))}</span> <span class="animate-bounce"></span>`;
				}
			}
		}
		
        function addMoney(n) { 
			const el=document.getElementById('money-received'); 
			el.value=(parseInt(el.value)||0)+n; 
			calculateChange(); 
		}
		
        function setExactMoney() { 
			document.getElementById('money-received').value = cart.reduce((s,i)=>s+(i.quantity*i.finalPrice),0); 
			calculateChange(); 
		}
        
        async function processPayment() {
			// 1. T√≠nh to√°n tr∆∞·ªõc c√°c con s·ªë
			const t = cart.reduce((s, i) => s + (i.quantity * i.finalPrice), 0); // T·ªïng ti·ªÅn h√†ng
			const r = parseInt(document.getElementById('money-received').value) || 0; // Ti·ªÅn kh√°ch ƒë∆∞a

			// --- LOGIC M·ªöI: KI·ªÇM TRA TI·ªÄN THI·∫æU ---
			if (r < t) {
				const missing = t - r;
				// B√°o l·ªói v√† D·ª™NG H√ÄM NGAY L·∫¨P T·ª®C (return)
				return showAlert("Thi·∫øu ti·ªÅn", `Kh√°ch ƒë∆∞a thi·∫øu ${formatMoney(missing)}. Vui l√≤ng thu ƒë·ªß ti·ªÅn tr∆∞·ªõc khi thanh to√°n!`, 'error');
			}
			// ---------------------------------------

			// 2. N·∫øu ƒë·ªß ti·ªÅn th√¨ m·ªõi hi·ªán popup x√°c nh·∫≠n v√† x·ª≠ l√Ω database
			showAlert("Thanh to√°n", "X√°c nh·∫≠n thanh to√°n ƒë∆°n h√†ng n√†y?", 'confirm', async () => {
    
				// 1. T·∫°o ƒë∆°n h√†ng (Gi·ªØ nguy√™n logic c≈©)
				const extra = { received_money: r, change_money: r - t };
				const { data: order, error } = await client.from('orders').insert({ 
					staff_email: currentUserEmail, total_amount: t, note: JSON.stringify(extra) 
				}).select().single();

				if (order) {
					// 2. L∆∞u chi ti·∫øt ƒë∆°n h√†ng (Gi·ªØ nguy√™n)
					const items = cart.map(i => ({ 
						order_id: order.id, product_name: i.name, quantity: i.quantity, price: i.finalPrice, total: i.quantity * i.finalPrice 
					}));
					await client.from('order_items').insert(items);

					// 3. --- M·ªöI: TR·ª™ T·ªíN KHO ---
					// Ch·∫°y v√≤ng l·∫∑p qua t·ª´ng m√≥n trong gi·ªè ƒë·ªÉ c·∫≠p nh·∫≠t
					const updatePromises = cart.map(item => {
						// T√¨m s·∫£n ph·∫©m g·ªëc trong DB ƒë·ªÉ l·∫•y s·ªë l∆∞·ª£ng hi·ªán t·∫°i
						const originalProd = productsDB.find(p => p.id === item.id);
						if (!originalProd) return null;

						// T√≠nh t·ªìn kho m·ªõi (Kh√¥ng cho √¢m)
						const newQty = Math.max(0, (originalProd.quantity || 0) - item.quantity);
						
						// G·ª≠i l·ªánh update l√™n Supabase
						return client.from('products').update({ quantity: newQty }).eq('id', item.id);
					});

					// ƒê·ª£i t·∫•t c·∫£ l·ªánh update ch·∫°y xong
					await Promise.all(updatePromises);
				}

				// 4. D·ªçn d·∫πp & L√†m m·ªõi d·ªØ li·ªáu
				cart = []; 
				updateCartUI(); 
				document.getElementById('last-scanned-card').classList.add('hidden');
				showAlert("Th√†nh c√¥ng", "ƒê∆°n h√†ng ƒë√£ l∆∞u & ƒê√£ tr·ª´ kho!", 'success');
				
				// QUAN TR·ªåNG: T·∫£i l·∫°i danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng m·ªõi v·ªÅ m√°y
				fetchProducts(); 
				
				backToScan();
			});
		}

		// --- H√ÄM X·ª¨ L√ù PH√çM ENTER KHI ƒêƒÇNG NH·∫¨P ---
		function handleLoginKey(e) {
			if (e.key === 'Enter') {
				handleLogin();
			}
		}

        // --- EXCEL & ADMIN ---
        function openAdminScreen() { 
			if(currentUserRole!=='admin') return showAlert("T·ª´ ch·ªëi", "Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p!", 'error');

			history.pushState({view: 'admin'}, "Qu·∫£n l√Ω", "#admin");
			
			if(html5QrcodeScanner) html5QrcodeScanner.pause(); 
			document.getElementById('scan-screen').classList.add('hidden'); 
			document.getElementById('admin-screen').classList.remove('hidden'); 
			renderProductList(); 
		}
        function closeAdminScreen() { 
			document.getElementById('admin-screen').classList.add('hidden'); 
			document.getElementById('scan-screen').classList.remove('hidden'); 
			if(html5QrcodeScanner) html5QrcodeScanner.resume();

			history.back();
		}
        function switchAdminTab(t) {
			// --- PH·∫¶N 1: X·ª¨ L√ù GIAO DI·ªÜN (UI) ---
			
			// 1. ·∫®n n·ªôi dung c·ªßa T·∫§T C·∫¢ c√°c tab
			document.getElementById('admin-products').classList.add('hidden');
			document.getElementById('admin-revenue').classList.add('hidden');
			document.getElementById('admin-users').classList.add('hidden'); // ƒê·∫£m b·∫£o ID n√†y t·ªìn t·∫°i b√™n HTML
			
			// 2. Reset m√†u n√∫t b·∫•m v·ªÅ m·∫∑c ƒë·ªãnh (X√°m/Tr·∫Øng) cho T·∫§T C·∫¢ c√°c n√∫t
			['products', 'revenue', 'users', 'system'].forEach(k => {
				document.getElementById('admin-'+k).classList.add('hidden');
				document.getElementById('tab-'+k).className = "flex-1 py-2.5 rounded-lg font-bold bg-white text-gray-500 border hover:bg-gray-50";
			});

			document.getElementById('admin-'+t).classList.remove('hidden');
			document.getElementById('tab-'+t).className = "flex-1 py-2.5 rounded-lg font-bold bg-blue-600 text-white shadow-sm";

			// 3. Hi·ªán n·ªôi dung tab ƒëang ch·ªçn
			const targetContent = document.getElementById('admin-'+t);
			if(targetContent) targetContent.classList.remove('hidden');

			// 4. T√¥ m√†u xanh cho n√∫t ƒëang ch·ªçn
			const targetBtn = document.getElementById('tab-'+t);
			if(targetBtn) targetBtn.className = "flex-1 py-2.5 rounded-lg font-bold bg-blue-600 text-white shadow-sm";


			// --- PH·∫¶N 2: X·ª¨ L√ù D·ªÆ LI·ªÜU (DATA) ---

			// Logic ri√™ng cho Tab Nh√¢n vi√™n
			if (t === 'users') {
				fetchUserList();
			}
			
			// Logic ri√™ng cho Tab Doanh thu
			else if (t === 'revenue') {
				loadRevenue(); // T·∫£i t·ªïng quan (Cards)
				
				// T·ª± ƒë·ªông ch·ªçn ng√†y h√¥m nay & t·∫£i chi ti·∫øt (Ch·ªâ l√†m n·∫øu √¥ input ch∆∞a c√≥ d·ªØ li·ªáu)
				const dateInput = document.getElementById('filter-start');
				if (dateInput && !dateInput.value) {
					const today = new Date().toISOString().split('T')[0];
					document.getElementById('filter-start').value = today;
					document.getElementById('filter-end').value = today;
					
					// C·∫≠p nh·∫≠t c·∫£ cho ph·∫ßn export c≈© (n·∫øu c√≤n d√πng)
					if(document.getElementById('report-start')) {
						 document.getElementById('report-start').value = today;
						 document.getElementById('report-end').value = today;
					}
				}

				viewRevenueDetail(); // G·ªçi h√†m t·∫£i danh s√°ch chi ti·∫øt
			}
			
			else if (t === 'system') {
				fetchSystemSettings();
			}
			
			// Logic ri√™ng cho Tab H√†ng h√≥a (N·∫øu c·∫ßn reload khi chuy·ªÉn tab)
			else if (t === 'products') {
				// fetchProducts(); // B·∫≠t d√≤ng n√†y n·∫øu mu·ªën m·ªói l·∫ßn b·∫•m v√†o tab H√†ng h√≥a l√† t·∫£i l·∫°i danh s√°ch
			}
		}
		
		// T·∫£i danh s√°ch User
		async function fetchUserList() {
			document.getElementById('user-list').innerHTML = '<div class="text-center py-4 text-gray-400">‚è≥ ƒêang t·∫£i...</div>';
			
			// S·∫Øp x·∫øp: Admin l√™n ƒë·∫ßu, sau ƒë√≥ ƒë·∫øn ng∆∞·ªùi m·ªõi online
			const { data: users, error } = await client
				.from('app_users')
				.select('*')
				.order('role', { ascending: true }) // 'admin' (a) ƒë·ª©ng tr∆∞·ªõc 'staff' (s)
				.order('last_seen', { ascending: false });
			
			if (error) return showAlert("L·ªói", error.message, 'error');

			document.getElementById('user-list').innerHTML = users.map(u => {
				// 1. T√≠nh tr·∫°ng th√°i Online
				const diffMin = (new Date() - new Date(u.last_seen)) / 60000;
				const isOnline = diffMin < 2;
				
				const statusHtml = isOnline 
					? `<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold border border-green-200 inline-flex items-center gap-1 w-fit">
						<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online
					   </span>`
					: `<span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] font-bold border inline-flex items-center w-fit">
						Offline ${Math.round(diffMin)}p tr∆∞·ªõc
					   </span>`;

				// 2. N√∫t Kh√≥a / M·ªü kh√≥a
				const lockBtn = u.is_locked 
					? `<button onclick="setUserLock('${u.email}', false)" class="bg-green-100 text-green-600 px-3 py-2 rounded font-bold text-xs border border-green-200">M·ªü</button>`
					: `<button onclick="setUserLock('${u.email}', true)" class="bg-gray-100 text-gray-500 px-3 py-2 rounded font-bold text-xs border border-gray-200">Kh√≥a</button>`;

				// 3. --- M·ªöI: N√öT B·ªî NHI·ªÜM / H·∫† C·∫§P ---
				let roleBtn = "";
				if (u.role === 'admin') {
					roleBtn = `<button onclick="changeUserRole('${u.email}', 'staff')" class="bg-purple-100 text-purple-600 px-3 py-2 rounded font-bold text-xs border border-purple-200">‚¨áÔ∏è H·∫° c·∫•p</button>`;
				} else {
					roleBtn = `<button onclick="changeUserRole('${u.email}', 'admin')" class="bg-yellow-100 text-yellow-700 px-3 py-2 rounded font-bold text-xs border border-yellow-200">‚≠ê B·ªï nhi·ªám</button>`;
				}

				// 4. Render giao di·ªán
				// N·∫øu l√† Admin th√¨ vi·ªÅn m√†u T√≠m cho ƒë·∫πp
				const cardBorder = u.role === 'admin' ? "border-purple-300 ring-1 ring-purple-100" : "border-gray-200";
				const bgAvatar = u.role === 'admin' ? "bg-purple-100 text-purple-600" : "bg-blue-50 text-blue-600";

				return `
				<div class="bg-white p-3 rounded-xl border ${cardBorder} shadow-sm flex flex-col gap-3 ${u.is_locked ? 'opacity-60 bg-gray-50' : ''}">
					<div class="flex justify-between items-start">
						<div class="flex items-center gap-3">
							<div class="w-10 h-10 rounded-full ${bgAvatar} flex items-center justify-center font-bold text-lg border">
								${u.email.charAt(0).toUpperCase()}
							</div>
							<div>
								<div class="font-bold text-gray-800 text-sm flex items-center gap-1">
									${u.email}
									${u.role === 'admin' ? '<span class="text-[9px] bg-purple-600 text-white px-1.5 rounded-full">ADMIN</span>' : ''}
								</div>
								<div class="mt-1">${statusHtml}</div>
							</div>
						</div>
					</div>
					
					<div class="flex gap-2 justify-end border-t pt-2 border-dashed">
						<button onclick="showUserQR('${u.email}')" class="bg-gray-800 text-white px-3 py-2 rounded font-bold text-xs border border-gray-600 shadow-sm">ü™™ QR Login</button>
						
						${roleBtn}
						${lockBtn}
						<button onclick="kickUser('${u.email}')" class="bg-red-50 text-red-600 px-3 py-2 rounded font-bold text-xs border border-red-100">Kick ‚ö°</button>
					</div>
				</div>
				`;
			}).join('');
		}

		// Bi·∫øn t·∫°m ƒë·ªÉ l∆∞u email ƒëang mu·ªën t·∫°o QR
		let pendingQREmail = "";

		// 1. H√†m ƒë∆∞·ª£c g·ªçi khi b·∫•m n√∫t "QR" ·ªü danh s√°ch nh√¢n vi√™n
		function showUserQR(email) {
			pendingQREmail = email; // L∆∞u l·∫°i email
			
			// Reset √¥ nh·∫≠p v√† hi·ªán Modal
			document.getElementById('qr-password-input').value = "";
			document.getElementById('password-input-modal').classList.remove('hidden');
			
			// T·ª± ƒë·ªông focus v√†o √¥ nh·∫≠p cho ti·ªán
			setTimeout(() => document.getElementById('qr-password-input').focus(), 100);
		}

		// 2. H√†m ƒë√≥ng Modal nh·∫≠p m·∫≠t kh·∫©u
		function closePassModal() {
			document.getElementById('password-input-modal').classList.add('hidden');
			pendingQREmail = ""; // X√≥a email t·∫°m
		}

		// 3. H√†m x·ª≠ l√Ω khi b·∫•m "T·∫°o M√£" (Logic ch√≠nh n·∫±m ·ªü ƒë√¢y)
		function submitQRPassword() {
			const pass = document.getElementById('qr-password-input').value.trim();
			
			if (!pass) {
				showAlert("L·ªói", "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!", "error");
				return;
			}

			// --- S·ª¨A L·ªñI T·∫†I ƒê√ÇY ---
			
			// 1. L·∫•y email ra bi·∫øn c·ª•c b·ªô TR∆Ø·ªöC
			const email = pendingQREmail;

			// 2. Sau ƒë√≥ m·ªõi ƒë√≥ng Modal (L√∫c n√†y pendingQREmail b·ªã x√≥a c≈©ng kh√¥ng sao)
			closePassModal();

			// -----------------------

			const jsonString = JSON.stringify({ action: "login", email: email, pass: pass });
			
			const modal = document.getElementById('qr-modal');
			const container = document.getElementById('qr-code-container');
			const emailLabel = document.getElementById('qr-user-email');

			if (!modal || !container) return;

			// Hi·ªán Modal hi·ªÉn th·ªã QR
			modal.classList.remove('hidden');
			emailLabel.innerText = email;
			container.innerHTML = ""; 

			setTimeout(() => {
				// C·∫•u h√¨nh QR Code
				new QRCode(container, {
					text: jsonString,
					width: 250,
					height: 250,
					colorDark: "#000000",
					colorLight: "#ffffff",
					correctLevel: QRCode.CorrectLevel.H,
					
					// Logo (Base64 ho·∫∑c link ·∫£nh)
					logo: "mini_pos.png", 
					logoWidth: 60,
					logoHeight: 60,
					logoBackgroundColor: '#ffffff',
					logoBackgroundTransparent: false
				});
			}, 50);
		}

		function closeQRModal() {
			const modal = document.getElementById('qr-modal');
			if(modal) modal.classList.add('hidden');
		}

		function printQR() {
			const container = document.getElementById('qr-code-container');
			if(!container) return;
			
			const printContent = container.innerHTML;
			const email = document.getElementById('qr-user-email').innerText;
			
			const win = window.open('', '', 'height=600,width=600');
			win.document.write('<html><head><title>In Th·∫ª</title><style>body{text-align:center; font-family: sans-serif; padding:20px;} img{margin:0 auto; display:block;}</style></head><body>');
			win.document.write(`<h2>TH·∫∫ NH√ÇN VI√äN</h2>${printContent}<h3>${email}</h3>`);
			win.document.write('</body></html>');
			win.document.close();
			win.print();
		}

		function downloadQR() {
			const container = document.getElementById('qr-code-container');
			const email = document.getElementById('qr-user-email').innerText || "user";
			
			// T√¨m th·∫ª Canvas (Th∆∞ vi·ªán m·ªõi d√πng Canvas ƒë·ªÉ v·∫Ω c·∫£ Logo)
			const canvas = container.querySelector('canvas');

			if (canvas) {
				// Chuy·ªÉn Canvas th√†nh ·∫£nh
				const imageUrl = canvas.toDataURL("image/png");

				// T·∫£i v·ªÅ
				const link = document.createElement('a');
				link.href = imageUrl;
				link.download = `QR_${email}.png`;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			} else {
				// Fallback: N·∫øu th∆∞ vi·ªán l·ª° render ra img (t√πy tr√¨nh duy·ªát)
				const img = container.querySelector('img');
				if(img) {
					const link = document.createElement('a');
					link.href = img.src;
					link.download = `QR_${email}.png`;
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
				} else {
					showAlert("L·ªói", 'Ch∆∞a c√≥ m√£ QR ƒë·ªÉ l∆∞u!', "error");
				}
			}
		}

		// --- H√ÄM B·ªî NHI·ªÜM / H·∫† C·∫§P ---
		async function changeUserRole(email, newRole) {
			// 1. Ch·∫∑n kh√¥ng cho t·ª± thay ƒë·ªïi quy·ªÅn c·ªßa ch√≠nh m√¨nh (tr√°nh l·ª° tay t·ª± h·∫° c·∫•p r·ªìi m·∫•t quy·ªÅn Admin)
			if (email === currentUserEmail) {
				return showAlert("T·ª´ ch·ªëi", "B·∫°n kh√¥ng th·ªÉ t·ª± thay ƒë·ªïi quy·ªÅn c·ªßa ch√≠nh m√¨nh!", 'error');
			}

			// 2. X√°c ƒë·ªãnh n·ªôi dung th√¥ng b√°o
			const title = newRole === 'admin' ? "B·ªï nhi·ªám Qu·∫£n l√Ω" : "H·∫° c·∫•p Nh√¢n vi√™n";
			const msg = newRole === 'admin' 
				? `B·∫°n mu·ªën thƒÉng ch·ª©c cho ${email} th√†nh ADMIN? (H·ªç s·∫Ω c√≥ to√†n quy·ªÅn qu·∫£n l√Ω).`
				: `B·∫°n mu·ªën h·∫° c·∫•p ${email} xu·ªëng th√†nh NH√ÇN VI√äN? (H·ªç s·∫Ω m·∫•t quy·ªÅn truy c·∫≠p trang Qu·∫£n l√Ω).`;

			// 3. H·ªèi x√°c nh·∫≠n
			showAlert(title, msg, 'confirm', async () => {
				// 4. C·∫≠p nh·∫≠t v√†o Database
				const { error } = await client.from('app_users').update({ role: newRole }).eq('email', email);
				
				if (error) {
					showAlert("L·ªói", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t: " + error.message, 'error');
				} else {
					showAlert("Th√†nh c√¥ng", `ƒê√£ c·∫≠p nh·∫≠t quy·ªÅn cho ${email}`, 'success');
					fetchUserList(); // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ th·∫•y thay ƒë·ªïi
				}
			});
		}

		// H√†m Kh√≥a/M·ªü kh√≥a
		async function setUserLock(email, lockStatus) {
			if (email === currentUserEmail) return showAlert("L·ªói", "Kh√¥ng th·ªÉ t·ª± kh√≥a ch√≠nh m√¨nh!", 'error');
			
			showAlert(lockStatus ? "Kh√≥a TK" : "M·ªü kh√≥a", `B·∫°n mu·ªën ${lockStatus ? 'KH√ìA' : 'M·ªû KH√ìA'} t√†i kho·∫£n ${email}?`, 'confirm', async () => {
				await client.from('app_users').update({ is_locked: lockStatus }).eq('email', email);
				fetchUserList();
				showAlert("Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i.", 'success');
			});
		}

		// H√†m Kick (Bu·ªôc ƒëƒÉng xu·∫•t)
		async function kickUser(email) {
			if (email === currentUserEmail) return showAlert("L·ªói", "Kh√¥ng th·ªÉ t·ª± kick ch√≠nh m√¨nh!", 'error');

			showAlert("K√≠ch t√†i kho·∫£n", `Bu·ªôc t√†i kho·∫£n ${email} ƒëƒÉng xu·∫•t ngay l·∫≠p t·ª©c?`, 'confirm', async () => {
				await client.from('app_users').update({ force_logout: true }).eq('email', email);
				fetchUserList();
				showAlert("ƒê√£ Kick", "Ng∆∞·ªùi d√πng s·∫Ω b·ªã vƒÉng ra trong v√≤ng 30 gi√¢y.", 'success');
			});
		}
		
		// --- H√ÄM XEM CHI TI·∫æT DOANH S·ªê (M·ªöI) ---
		async function viewRevenueDetail() {
			const startVal = document.getElementById('filter-start').value;
			const endVal = document.getElementById('filter-end').value;

			if (!startVal || !endVal) return showAlert("Thi·∫øu ng√†y", "Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c", 'error');

			const d1 = new Date(startVal);
			const d2 = new Date(endVal);
			
			// 1. Ki·ªÉm tra ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu
			if (d2 < d1) return showAlert("L·ªói ng√†y", "Ng√†y k·∫øt th√∫c ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng ng√†y b·∫Øt ƒë·∫ßu", 'error');

			// 2. Ki·ªÉm tra gi·ªõi h·∫°n 1 th√°ng (31 ng√†y)
			const diffTime = Math.abs(d2 - d1);
			const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
			if (diffDays > 31) return showAlert("Gi·ªõi h·∫°n", "Vui l√≤ng ch·ªâ xem t·ªëi ƒëa 31 ng√†y ƒë·ªÉ ƒë·∫£m b·∫£o t·ªëc ƒë·ªô.", 'error');

			// Chu·∫©n b·ªã th·ªùi gian query (Full ng√†y)
			const startISO = new Date(startVal + 'T00:00:00').toISOString();
			const endISO = new Date(endVal + 'T23:59:59').toISOString();

			// Hi·ªán tr·∫°ng th√°i ƒëang t·∫£i
			document.getElementById('revenue-list').innerHTML = '<div class="text-center py-8 text-gray-400 text-xs animate-pulse">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>';

			// G·ªçi Supabase
			const { data: orders, error } = await client
				.from('orders')
				.select('*')
				.gte('created_at', startISO)
				.lte('created_at', endISO)
				.order('created_at', { ascending: false });

			if (error) {
				document.getElementById('revenue-list').innerHTML = '<div class="text-center text-red-400 text-xs">L·ªói t·∫£i d·ªØ li·ªáu</div>';
				return showAlert("L·ªói", error.message, 'error');
			}

			// X·ª≠ l√Ω hi·ªÉn th·ªã
			if (!orders || orders.length === 0) {
				document.getElementById('revenue-list').innerHTML = '<div class="text-center py-10 text-gray-400 flex flex-col items-center"><span class="text-4xl mb-2">üì≠</span><span>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</span></div>';
				document.getElementById('filter-count').innerText = "0 ƒë∆°n";
				document.getElementById('filter-sum').innerText = "0ƒë";
				return;
			}

			// T√≠nh t·ªïng
			const total = orders.reduce((sum, o) => sum + o.total_amount, 0);
			document.getElementById('filter-count').innerText = `${orders.length} ƒë∆°n`;
			document.getElementById('filter-sum').innerText = formatMoney(total);

			// Render Danh s√°ch (T√°i s·ª≠ d·ª•ng h√†m viewHistoryDetail ƒë·ªÉ xem chi ti·∫øt khi click)
			document.getElementById('revenue-list').innerHTML = orders.map(o => {
				const noteSafe = encodeURIComponent(o.note || "");
				return `
				<div onclick="viewHistoryDetail(${o.id}, ${o.total_amount}, '${o.created_at}', '${noteSafe}')" class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center active:bg-gray-50 transition-colors cursor-pointer mb-2">
					<div class="flex items-center gap-3">
						<div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-xs">#${o.id}</div>
						<div>
							<div class="text-xs font-bold text-gray-700">${new Date(o.created_at).toLocaleString('vi-VN')}</div>
							<div class="text-[10px] text-gray-400 flex items-center gap-1">
								<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> ${o.staff_email.split('@')[0]}
							</div>
						</div>
					</div>
					<div class="text-right">
						<div class="text-sm font-bold text-blue-600 font-display">${formatMoney(o.total_amount)}</div>
						<div class="text-[10px] text-gray-400">Chi ti·∫øt ></div>
					</div>
				</div>
				`;
			}).join('');
		}
		
		// --- H√ÄM XU·∫§T B√ÅO C√ÅO EXCEL ---
		async function exportRevenueReport() {
			const startStr = document.getElementById('filter-start').value;
			const endStr = document.getElementById('filter-end').value;

			if (!startStr || !endStr) return showAlert("Thi·∫øu th√¥ng tin", "Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!", 'error');

			// T·∫°o th·ªùi gian chu·∫©n ISO (T·ª´ 00:00:00 ng√†y ƒë·∫ßu -> 23:59:59 ng√†y cu·ªëi)
			const startDate = new Date(startStr + 'T00:00:00').toISOString();
			const endDate = new Date(endStr + 'T23:59:59').toISOString();

			showAlert("ƒêang x·ª≠ l√Ω", "ƒêang t·∫£i d·ªØ li·ªáu b√°o c√°o...", 'info');

			// L·∫•y ƒë∆°n h√†ng K√àM THEO chi ti·∫øt s·∫£n ph·∫©m (d√πng Query Relation c·ªßa Supabase)
			const { data: orders, error } = await client
				.from('orders')
				.select('*, order_items(*)') 
				.gte('created_at', startDate)
				.lte('created_at', endDate)
				.order('created_at', { ascending: false });

			if (error) return showAlert("L·ªói", error.message, 'error');
			if (!orders || orders.length === 0) return showAlert("Tr·ªëng", "Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong kho·∫£ng th·ªùi gian n√†y.", 'info');

			// Ch·∫ø bi·∫øn d·ªØ li·ªáu ph·∫≥ng ƒë·ªÉ ƒë∆∞a v√†o Excel
			const excelData = [];
			let totalRevenuePeriod = 0;

			orders.forEach(order => {
				const orderDate = new Date(order.created_at).toLocaleString('vi-VN');
				const staffName = order.staff_email.split('@')[0];
				
				// N·∫øu ƒë∆°n h√†ng c√≥ s·∫£n ph·∫©m con
				if (order.order_items && order.order_items.length > 0) {
					order.order_items.forEach(item => {
						excelData.push({
							"M√£ ƒê∆°n": order.id,
							"Ng√†y Gi·ªù": orderDate,
							"Nh√¢n Vi√™n": staffName,
							"T√™n S·∫£n Ph·∫©m": item.product_name,
							"S·ªë L∆∞·ª£ng": item.quantity,
							"ƒê∆°n Gi√°": item.price,
							"Th√†nh Ti·ªÅn (SP)": item.total,
							"T·ªïng ƒê∆°n H√†ng": "" // ƒê·ªÉ tr·ªëng cho ƒë·∫πp, ƒë·ª° r·ªëi m·∫Øt
						});
					});
					// Th√™m 1 d√≤ng t·ªïng k·∫øt ƒë∆°n (t√πy ch·ªçn, ƒë·ªÉ d·ªÖ nh√¨n trong Excel)
					excelData.push({
						"M√£ ƒê∆°n": `T·ªïng #${order.id}`,
						"Ng√†y Gi·ªù": "", "Nh√¢n Vi√™n": "", "T√™n S·∫£n Ph·∫©m": "---", "S·ªë L∆∞·ª£ng": "", "ƒê∆°n Gi√°": "",
						"Th√†nh Ti·ªÅn (SP)": "",
						"T·ªïng ƒê∆°n H√†ng": order.total_amount
					});
				} else {
					// Tr∆∞·ªùng h·ª£p hi·∫øm: ƒë∆°n l·ªói kh√¥ng c√≥ chi ti·∫øt
					excelData.push({
						"M√£ ƒê∆°n": order.id,
						"Ng√†y Gi·ªù": orderDate,
						"Nh√¢n Vi√™n": staffName,
						"T√™n S·∫£n Ph·∫©m": "(Kh√¥ng c√≥ chi ti·∫øt)",
						"S·ªë L∆∞·ª£ng": 0, "ƒê∆°n Gi√°": 0, "Th√†nh Ti·ªÅn (SP)": 0,
						"T·ªïng ƒê∆°n H√†ng": order.total_amount
					});
				}
				totalRevenuePeriod += order.total_amount;
			});

			// Th√™m d√≤ng t·ªïng doanh thu cu·ªëi c√πng c·ªßa c·∫£ ƒë·ª£t
			excelData.push({}); // D√≤ng tr·ªëng c√°ch ra
			excelData.push({
				"M√£ ƒê∆°n": "T·ªîNG C·ªòNG",
				"T·ªïng ƒê∆°n H√†ng": totalRevenuePeriod
			});

			// Xu·∫•t file b·∫±ng SheetJS
			const ws = XLSX.utils.json_to_sheet(excelData);
			
			// Ch·ªânh ƒë·ªô r·ªông c·ªôt cho ƒë·∫πp
			ws['!cols'] = [{wch:10}, {wch:20}, {wch:15}, {wch:30}, {wch:10}, {wch:15}, {wch:15}, {wch:15}];

			const wb = XLSX.utils.book_new();
			XLSX.utils.book_append_sheet(wb, ws, "Bao_Cao_Chi_Tiet");
			
			// T√™n file: DoanhThu_TuNgay_DenNgay.xlsx
			XLSX.writeFile(wb, `DoanhThu_${startStr}_${endStr}.xlsx`);
			
			closeAlert(); // T·∫Øt th√¥ng b√°o
		}
		
        function renderProductList(search = "") {
			document.getElementById('admin-product-list').innerHTML = productsDB
				.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || 
							 (p.item_code && p.item_code.toLowerCase().includes(search.toLowerCase())) || 
							 (p.barcode && p.barcode.includes(search)))
				.map(p => {
					// X·ª≠ l√Ω hi·ªÉn th·ªã gi√°
					let priceDisplay = `<div class="text-xs font-bold text-blue-600 mt-1">${formatMoney(p.price)}</div>`;
					if (p.sale_price && p.sale_price < p.price) {
						priceDisplay = `<div class="mt-1">
											<span class="text-gray-400 line-through text-[10px] mr-1">${formatMoney(p.price)}</span>
											<span class="text-red-600 font-bold text-xs">${formatMoney(p.sale_price)}</span>
										</div>`;
					}

					// X·ª≠ l√Ω tr·∫°ng th√°i kh√≥a
					const lockedClass = p.is_locked ? "locked-item" : "";
					const lockIcon = p.is_locked ? "üîì" : "üîí";
					const lockBtnColor = p.is_locked ? "bg-gray-500" : "bg-orange-500";

					// --- HTML TR·∫¢ V·ªÄ (ƒê√É S·ª¨A H√ÄNG D·ªåC) ---
					return `
					<div class="bg-white p-3 rounded-lg border flex justify-between items-center shadow-sm ${lockedClass}">
						
						<div class="flex items-center gap-3 flex-1">
							<img src="${p.image || PLACEHOLDER_IMG}" class="w-12 h-12 rounded bg-gray-100 object-cover shrink-0">
							<div>
								<div class="font-bold text-gray-800 text-sm line-clamp-1">
									${p.name} 
									${p.is_locked ? '<span class="text-[10px] text-red-500 bg-red-100 px-1 rounded ml-1">(ƒê√£ kh√≥a)</span>' : ''}
								</div>
								
								<div class="flex flex-wrap gap-1 text-[10px] mt-1">
									<span class="bg-gray-100 px-1 rounded text-gray-500 border">M√£: ${p.barcode || '---'}</span>
									<span class="bg-gray-100 px-1 rounded text-gray-500 border">Item: ${p.item_code || '---'}</span>
									<span class="bg-gray-100 px-1 rounded text-gray-500 border">ƒêVT: ${p.unit || '---'}</span>
									<span class="bg-purple-100 text-purple-700 px-1 rounded font-bold border border-purple-200">Kho: ${p.quantity || 0}</span>
								</div>
								
								${priceDisplay}
							</div>
						</div>

						<div class="flex flex-col gap-2 ml-3 shrink-0 py-1">
							<button onclick="toggleLock(${p.id}, ${p.is_locked})" class="${lockBtnColor} text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-sm transition active:scale-90">
								${lockIcon}
							</button>
							<button onclick="openProductModal(${p.id})" class="text-blue-600 bg-blue-50 border border-blue-100 w-9 h-9 rounded-lg flex items-center justify-center transition active:scale-90">
								‚úèÔ∏è
							</button>
							<button onclick="deleteProduct(${p.id})" class="text-red-600 bg-red-50 border border-red-100 w-9 h-9 rounded-lg flex items-center justify-center transition active:scale-90">
								üóë
							</button>
						</div>

					</div>`;
				}).join('');
		}
        async function toggleLock(id, status) {
            showAlert(status ? "M·ªü kh√≥a" : "Kh√≥a s·∫£n ph·∫©m", status ? "B·∫°n mu·ªën m·ªü b√°n l·∫°i?" : "T·∫°m ng∆∞ng b√°n m√≥n n√†y?", 'confirm', async () => {
                await client.from('products').update({ is_locked: !status }).eq('id', id); fetchProducts();
            });
        }
        async function deleteProduct(id) {
            showAlert("X√≥a s·∫£n ph·∫©m", "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. X√≥a?", 'confirm', async () => {
                await client.from('products').delete().eq('id', id); fetchProducts();
            });
        }
        function downloadTemplate() { 
			// Th√™m c·ªôt "T·ªìn kho" v√†o ti√™u ƒë·ªÅ v√† d·ªØ li·ªáu m·∫´u
			const data = [
				["M√£ v·∫°ch", "M√£ Item", "T√™n s·∫£n ph·∫©m", "Gi√° b√°n", "Gi√° khuy·∫øn m√£i", "ƒê∆°n v·ªã", "T·ªìn kho", "Link ·∫¢nh"], 
				["893...", "NC01", "V√≠ d·ª•: N∆∞·ªõc ng·ªçt", "10000", "8000", "Chai", "100", ""]
			]; 
			
			const wb = XLSX.utils.book_new(); 
			const ws = XLSX.utils.aoa_to_sheet(data); 
			
			// Ch·ªânh ƒë·ªô r·ªông c·ªôt cho d·ªÖ nh√¨n (T√πy ch·ªçn)
			ws['!cols'] = [{wch:15}, {wch:10}, {wch:30}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:20}];

			XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Hang"); 
			XLSX.writeFile(wb, "Mau_Nhap_Hang_POS.xlsx"); 
		}
        async function handleExcelUpload(e) {
			const file = e.target.files[0]; 
			if(!file) return;

			const reader = new FileReader();
			reader.onload = async function(e) {
				const data = new Uint8Array(e.target.result); 
				const workbook = XLSX.read(data, {type: 'array'}); 
				const sheetName = workbook.SheetNames[0]; 
				const worksheet = workbook.Sheets[sheetName]; 
				const jsonData = XLSX.utils.sheet_to_json(worksheet);

				if(jsonData.length === 0) return showAlert("L·ªói", "File kh√¥ng c√≥ d·ªØ li·ªáu!", 'error');

				// --- C·∫¨P NH·∫¨T: Th√™m tr∆∞·ªùng quantity (T·ªìn kho) ---
				const productsToInsert = jsonData.map(row => ({ 
					name: row["T√™n s·∫£n ph·∫©m"] || "M·ªõi", 
					price: parseInt(row["Gi√° b√°n"]) || 0, 
					sale_price: row["Gi√° khuy·∫øn m√£i"] ? parseInt(row["Gi√° khuy·∫øn m√£i"]) : null, 
					barcode: row["M√£ v·∫°ch"] ? String(row["M√£ v·∫°ch"]) : null, 
					item_code: row["M√£ Item"] ? String(row["M√£ Item"]) : null, 
					unit: row["ƒê∆°n v·ªã"] || "C√°i", 
					image: row["Link ·∫¢nh"] || "",
					
					// ƒê·ªçc c·ªôt "T·ªìn kho", n·∫øu kh√¥ng c√≥ ho·∫∑c ƒë·ªÉ tr·ªëng th√¨ m·∫∑c ƒë·ªãnh l√† 0
					quantity: parseInt(row["T·ªìn kho"]) || 0 
				}));

				showAlert("Nh·∫≠p Excel", `T√¨m th·∫•y ${productsToInsert.length} s·∫£n ph·∫©m. Ti·∫øn h√†nh nh·∫≠p?`, 'confirm', async () => {
					const { error } = await client.from('products').insert(productsToInsert);
					
					if(error) {
						showAlert("L·ªói", error.message, 'error'); 
					} else { 
						showAlert("Th√†nh c√¥ng", "ƒê√£ nh·∫≠p h√†ng v√† kho th√†nh c√¥ng!", 'success'); 
						fetchProducts(); 
					}
					document.getElementById('excel-upload').value = "";
				});
			}; 
			reader.readAsArrayBuffer(file);
		}

		async function openHistory() {
            document.getElementById('history-modal').classList.remove('hidden');
            let { data: orders, error } = await client.from('orders').select('*').order('created_at', {ascending:false}).limit(20);
            if(error) { const res = await client.from('orders').select('*').limit(20); orders = res.data; }
            document.getElementById('history-list').innerHTML = orders.map(o => {
                const noteSafe = encodeURIComponent(o.note || "");
                return `
                <div onclick="viewHistoryDetail(${o.id}, ${o.total_amount}, '${o.created_at}', '${noteSafe}')" class="bg-white p-3 border rounded-lg shadow-sm flex justify-between cursor-pointer hover:bg-blue-50 transition">
                    <div>
                        <div class="flex items-center gap-2"><span class="font-bold text-sm bg-gray-200 px-2 rounded">#${o.id}</span><span class="text-xs text-gray-500">${new Date(o.created_at || Date.now()).toLocaleString('vi-VN')}</span></div>
                        <div class="text-xs text-gray-400 mt-1">${o.staff_email.split('@')[0]}</div>
                    </div>
                    <div class="font-bold text-blue-600 text-lg">${formatMoney(o.total_amount)}</div>
                </div>`
            }).join('');
        }

		async function viewHistoryDetail(id, total, time, noteEncoded) {
            document.getElementById('history-detail-panel').classList.remove('hidden');
            document.getElementById('hist-detail-id').innerText = `ƒê∆°n h√†ng #${id}`;
            document.getElementById('hist-detail-time').innerText = new Date(time).toLocaleString('vi-VN');
            document.getElementById('hist-detail-total').innerText = formatMoney(total);
            let received = 0, change = 0;
            try { const noteDecoded = decodeURIComponent(noteEncoded); if(noteDecoded) { const extra = JSON.parse(noteDecoded); received = extra.received_money; change = extra.change_money; } } catch(e) {}
            document.getElementById('hist-detail-received').innerText = received ? formatMoney(received) : "---";
            document.getElementById('hist-detail-change').innerText = change ? formatMoney(change) : "---";
            const { data: items } = await client.from('order_items').select('*').eq('order_id', id);
            document.getElementById('hist-detail-items').innerHTML = items.map(i => {
                const originalProd = productsDB.find(p => p.name === i.product_name) || {};
                const barcode = originalProd.barcode || '---';
                const unit = originalProd.unit || 'C√°i';
                return `<tr><td><div class="font-bold text-gray-800">${i.product_name}</div><div class="text-[10px] text-gray-500">M√£: ${barcode} | ƒêVT: ${unit}</div></td><td class="text-right font-bold">x${i.quantity}</td><td class="text-right text-xs">${formatMoney(i.price)}</td><td class="text-right font-bold text-blue-600">${formatMoney(i.total)}</td></tr>`;
            }).join('');
        }

        // --- PRODUCT MODAL ---
        function openProductModal(id = null) {
            document.getElementById('product-modal').classList.remove('hidden');
            if(id) { 
				const p = productsDB.find(x=>x.id==id);
				document.getElementById('prod-id').value=p.id; 
				document.getElementById('prod-name').value=p.name; 
				document.getElementById('prod-barcode').value=p.barcode||""; 
				document.getElementById('prod-itemcode').value=p.item_code||""; 
				document.getElementById('prod-price').value=p.price; 
				document.getElementById('prod-image').value=p.image||""; 
				document.getElementById('prod-unit').value=p.unit||""; 
				document.getElementById('prod-sale').value=p.sale_price||""; 
				document.getElementById('prod-quantity').value = p.quantity || 0;
			} 
            else { 
				document.getElementById('prod-id').value=""; 
				document.getElementById('prod-name').value=""; 
				document.getElementById('prod-barcode').value=""; 
				document.getElementById('prod-itemcode').value=""; 
				document.getElementById('prod-price').value=""; 
				document.getElementById('prod-image').value=""; 
				document.getElementById('prod-unit').value=""; 
				document.getElementById('prod-sale').value="";
				document.getElementById('prod-quantity').value="0";
			}
        }
        async function saveProduct() {
            const id = document.getElementById('prod-id').value;
            const payload = { 
				name: document.getElementById('prod-name').value, 
				price: parseInt(document.getElementById('prod-price').value), 
				sale_price: parseInt(document.getElementById('prod-sale').value) || null, 
				barcode: document.getElementById('prod-barcode').value, 
				item_code: document.getElementById('prod-itemcode').value, 
				unit: document.getElementById('prod-unit').value, 
				image: document.getElementById('prod-image').value,
				quantity: parseInt(document.getElementById('prod-quantity').value) || 0 };
            if(id) await client.from('products').update(payload).eq('id', id); 
			else await client.from('products').insert(payload);
			
            document.getElementById('product-modal').classList.add('hidden'); 
			fetchProducts(); 
			showAlert("ƒê√£ l∆∞u", "C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng", 'success');
        }

        // --- GENERAL ---
        function confirmLogout() { showAlert("ƒêƒÉng xu·∫•t", "B·∫°n ch·∫Øc ch·∫Øn mu·ªën tho√°t phi√™n l√†m vi·ªác?", 'confirm', forceLogout); }
        function handleManualInput(e) { 
			const val = e.target.value.trim(); 
			
			if (val.endsWith('*') && val.length > 1) { 
				setMultiplier(parseInt(val)); 
				e.target.value = ''; 
				return; 
			} 
			if (e.key === 'Enter') { 
				addToCart(val); 
				e.target.value = '';
				e.target.blur();
			} 
		}
        function setMultiplier(n) { if(!isNaN(n) && n>0) { currentMultiplier = n; document.getElementById('multiplier-badge').classList.remove('hidden'); document.getElementById('multiplier-val').innerText = n; } }
        async function loadRevenue() { const { data: orders } = await client.from('orders').select('*'); if(!orders) return; const today = new Date().toDateString(), thisMonth = new Date().getMonth(); let sumD=0, cntD=0, sumM=0, cntM=0; orders.forEach(o => { const d=new Date(o.created_at); if(d.toDateString()===today) {sumD+=o.total_amount; cntD++} if(d.getMonth()===thisMonth) {sumM+=o.total_amount; cntM++} }); document.getElementById('rev-today').innerText=formatMoney(sumD); document.getElementById('order-count-today').innerText=cntD+" ƒë∆°n"; document.getElementById('rev-month').innerText=formatMoney(sumM); document.getElementById('order-count-month').innerText=cntM+" ƒë∆°n"; }
        
        function parkOrder() { if(cart.length>0) { parkedOrders.push({id:Date.now(), items:[...cart]}); localStorage.setItem('pos_parked_orders',JSON.stringify(parkedOrders)); cart=[]; updateParkedBadge(); updateCartUI(); document.getElementById('last-scanned-card').classList.add('hidden'); showAlert("ƒê√£ l∆∞u", "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o m·ª•c ch·ªù.", 'info'); } }
        function showRecallModal() {
            document.getElementById('recall-modal').classList.remove('hidden');
            const container = document.getElementById('parked-list');
            if (parkedOrders.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 py-4">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>'; return; }
            container.innerHTML = parkedOrders.map((o, i) => {
                const itemsDetailHtml = o.items.map(item => `<div class="flex justify-between items-start py-2 border-b border-dashed border-gray-200 last:border-0"><div class="flex-1 pr-2"><div class="text-sm font-bold text-gray-700">${item.name}</div><div class="text-[10px] text-gray-500 mt-0.5"><span class="bg-gray-100 px-1 rounded border">M√£: ${item.barcode || '---'}</span></div></div><div class="text-right"><div class="text-sm font-bold text-blue-600">x${item.quantity}</div></div></div>`).join('');
                return `<div class="bg-white border rounded-xl shadow-sm mb-4 overflow-hidden"><div class="bg-orange-50 p-3 flex justify-between items-center border-b border-orange-100"><div><span class="font-bold text-orange-800 text-sm">Giao d·ªãch #${i + 1}</span></div><div class="flex gap-2"><button onclick="restoreOrder(${i})" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold">G·ªçi l·∫°i</button><button onclick="deleteParked(${i})" class="text-red-500 border border-red-200 px-2 py-1.5 rounded text-xs">X√≥a</button></div></div><div class="p-3 bg-white">${itemsDetailHtml}</div></div>`;
            }).join('');
        }
        function restoreOrder(i) { 
            const doRestore = () => { cart=parkedOrders[i].items; parkedOrders.splice(i,1); localStorage.setItem('pos_parked_orders',JSON.stringify(parkedOrders)); updateParkedBadge(); updateCartUI(); document.getElementById('recall-modal').classList.add('hidden'); renderPaymentList(); document.getElementById('scan-screen').classList.add('hidden'); document.getElementById('payment-screen').classList.remove('hidden'); };
            if(cart.length>0) showAlert("Ghi ƒë√®", "Gi·ªè h√†ng hi·ªán t·∫°i ƒëang c√≥ s·∫£n ph·∫©m. B·∫°n c√≥ mu·ªën ghi ƒë√® b·∫±ng ƒë∆°n ch·ªù n√†y?", 'confirm', doRestore); else doRestore();
        }
        function deleteParked(i) { showAlert("X√≥a ƒë∆°n ch·ªù", "B·∫°n mu·ªën x√≥a ƒë∆°n l∆∞u t·∫°m n√†y?", 'confirm', () => { parkedOrders.splice(i,1); localStorage.setItem('pos_parked_orders',JSON.stringify(parkedOrders)); updateParkedBadge(); showRecallModal(); }); }
        function updateParkedBadge() { const b=document.getElementById('parked-count'); b.innerText=parkedOrders.length; parkedOrders.length>0?b.classList.remove('hidden'):b.classList.add('hidden'); }
        function voidTransaction() {
			// 1. Ki·ªÉm tra: N·∫øu gi·ªè h√†ng tr·ªëng th√¨ b√°o l·ªói v√† D·ª™NG NGAY
			if (cart.length === 0) {
				return showAlert("Gi·ªè h√†ng tr·ªëng", "Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ x√≥a!", 'info');
			}

			// 2. N·∫øu c√≥ h√†ng th√¨ m·ªõi hi·ªán b·∫£ng h·ªèi x√°c nh·∫≠n
			showAlert("H·ªßy ƒë∆°n", "B·∫°n mu·ªën x√≥a to√†n b·ªô s·∫£n ph·∫©m trong gi·ªè?", 'confirm', () => {
				cart = [];
				updateCartUI(); // H√†m n√†y s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·∫°i localStorage th√†nh r·ªóng lu√¥n
				document.getElementById('last-scanned-card').classList.add('hidden');
				
				// (T√πy ch·ªçn) Rung nh·∫π b√°o hi·ªáu ƒë√£ x√≥a
				if(navigator.vibrate) navigator.vibrate(50);
			});
		}
        
        // --- CHECK PRICE ---
        function openCheckPriceModal() { document.getElementById('check-price-modal').classList.remove('hidden'); document.getElementById('check-result').innerHTML = '<p class="text-gray-400">M·ªùi nh·∫≠p m√£ ho·∫∑c t√™n s·∫£n ph·∫©m</p>'; setTimeout(() => document.getElementById('check-input').focus(), 100); }
        function handleCheckPriceInput(e) {
            if (e.key === 'Enter') { 
				const val = e.target.value.trim().toLowerCase(); 
				if (!val) return; 
				
				const p = productsDB.find(x => (x.barcode && x.barcode == val) || (x.item_code && x.item_code.toLowerCase() == val)) || productsDB.find(x => x.name.toLowerCase().includes(val)); 
				
				renderCheckResult(p); 
				e.target.value = '';
				e.target.blur();
			}
        }
        function renderCheckResult(p) {
            const el = document.getElementById('check-result');
            if (!p) { el.innerHTML = `<div class="text-6xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</div><h3 class="text-red-500 font-bold text-xl">Kh√¥ng t√¨m th·∫•y!</h3>`; return; }
            let priceHtml = ''; if (p.sale_price && p.sale_price < p.price) { priceHtml = `<div class="text-gray-400 line-through text-lg">${formatMoney(p.price)}</div><div class="text-red-600 font-bold text-4xl mt-1">${formatMoney(p.sale_price)}</div><span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs font-bold mt-1 inline-block">ƒêang gi·∫£m gi√°</span>`; } else { priceHtml = `<div class="text-blue-600 font-bold text-4xl mt-2">${formatMoney(p.price)}</div>`; }
            el.innerHTML = `<img src="${p.image || PLACEHOLDER_IMG}" class="w-24 h-24 object-cover rounded-lg mb-2 shadow-sm border mx-auto"><h3 class="font-bold text-gray-800 text-xl leading-tight px-2">${p.name}</h3><div class="text-xs text-gray-500 mt-1">M√£: ${p.barcode || '---'} | Code: ${p.item_code || '---'}</div><div class="text-xs text-gray-500">ƒêVT: ${p.unit || 'C√°i'}</div>${priceHtml}${p.is_locked ? '<div class="mt-2 text-red-500 font-bold border border-red-200 bg-red-50 p-2 rounded">üîí S·∫¢N PH·∫®M ƒêANG KH√ìA</div>' : ''}`;
        }

        function formatMoney(n) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n); }
        checkSession();
		
		// --- X·ª¨ L√ù N√öT BACK TR√äN ƒêI·ªÜN THO·∫†I (History API) ---
		window.addEventListener('popstate', function (event) {
			// Ki·ªÉm tra xem m√†n h√¨nh n√†o ƒëang m·ªü ƒë·ªÉ ƒë√≥ng l·∫°i
			const paymentScreen = document.getElementById('payment-screen');
			const adminScreen = document.getElementById('admin-screen');

			// 1. N·∫øu ƒëang ·ªü m√†n h√¨nh Thanh to√°n -> Quay v·ªÅ B√°n h√†ng
			if (!paymentScreen.classList.contains('hidden')) {
				paymentScreen.classList.add('hidden');
				document.getElementById('scan-screen').classList.remove('hidden');
				if (html5QrcodeScanner) html5QrcodeScanner.resume(); // B·∫≠t l·∫°i camera
			}
			
			// 2. N·∫øu ƒëang ·ªü m√†n h√¨nh Admin -> Quay v·ªÅ B√°n h√†ng
			else if (!adminScreen.classList.contains('hidden')) {
				adminScreen.classList.add('hidden');
				document.getElementById('scan-screen').classList.remove('hidden');
				if (html5QrcodeScanner) html5QrcodeScanner.resume(); // B·∫≠t l·∫°i camera
			}
		});
		
		// --- LOGIC HEARTBEAT (B√ÅO ONLINE & CHECK KICK) ---
		let heartbeatInterval = null;

		function startHeartbeat() {
			if (heartbeatInterval) clearInterval(heartbeatInterval);
			
			// G·ªçi ngay l·∫≠p t·ª©c l·∫ßn ƒë·∫ßu
			pingServer();

			// L·∫∑p l·∫°i m·ªói 30 gi√¢y
			heartbeatInterval = setInterval(pingServer, 30000); 
		}

		async function pingServer() {
			if (!currentUserEmail) return;

			try {
				// 1. Ki·ªÉm tra tr·∫°ng th√°i b·∫£n th√¢n
				const { data: user, error } = await client
					.from('app_users')
					.select('*')
					.eq('email', currentUserEmail)
					.maybeSingle(); // Chu·∫©n: d√πng maybeSingle ƒë·ªÉ tr√°nh l·ªói n·∫øu ch∆∞a c√≥ user

				// N·∫øu ch∆∞a c√≥ -> T·ª± ƒë·ªông th√™m v√†o
				if (!user && !error) {
					await client.from('app_users').insert({ 
						email: currentUserEmail, 
						role: currentUserRole, // L∆∞u √Ω: ƒê·∫£m b·∫£o bi·∫øn n√†y ƒëang ch·ª©a ƒë√∫ng role hi·ªán t·∫°i
						last_seen: new Date() 
					});
				}
				
				if (currentUserRole !== 'admin') {
					const { data: settings } = await client.from('app_settings').select('maintenance_mode, maintenance_message').eq('id', 1).single();
					
					if (settings && settings.maintenance_mode) {
						showAlert("H·ªÜ TH·ªêNG B·∫¢O TR√å", settings.maintenance_message, "error", () => {
							forceLogout();
						});
						return; // D·ª´ng ngay
					}
				}
				
				// N·∫øu ƒë√£ c√≥ -> Ki·ªÉm tra tr·∫°ng th√°i
				if (user) {
					// A. N·∫øu b·ªã KH√ìA ho·∫∑c b·ªã KICK
					if (user.is_locked || user.force_logout) {
						
						// X·ª≠ l√Ω tr∆∞·ªùng h·ª£p Kick (Reset c·ªù tr∆∞·ªõc khi ƒë√°)
						if (user.force_logout) {
							await client.from('app_users').update({ force_logout: false }).eq('email', currentUserEmail);
							
							// S·ª¨A: ƒê∆∞a forceLogout v√†o l√†m tham s·ªë th·ª© 4 (callback)
							showAlert("C·∫¢NH B√ÅO", '‚ö†Ô∏è B·∫†N ƒê√É B·ªä BU·ªòC ƒêƒÇNG XU·∫§T T·ª™ QU·∫¢N TR·ªä VI√äN.', "error", () => {
								forceLogout(); 
							});
						} else {
							// Tr∆∞·ªùng h·ª£p b·ªã Kh√≥a
							showAlert("TH√îNG B√ÅO", '‚õî T√ÄI KHO·∫¢N C·ª¶A B·∫†N ƒê√É B·ªä KH√ìA!', "error", () => {
								forceLogout();
							});
						}
						
						// Ng·∫Øt h√†m lu√¥n ƒë·ªÉ kh√¥ng ch·∫°y c·∫≠p nh·∫≠t last_seen b√™n d∆∞·ªõi
						return; 
					}

					// B. N·∫øu b√¨nh th∆∞·ªùng -> C·∫≠p nh·∫≠t 'last_seen'
					await client.from('app_users').update({ last_seen: new Date() }).eq('email', currentUserEmail);
				}
			} catch (e) { 
				// L·ªói m·∫°ng ho·∫∑c l·ªói server th√¨ b·ªè qua, kh√¥ng c·∫ßn l√†m phi·ªÅn user
				console.log("L·ªói Heartbeat:", e); 
			}
		}
		
		// --- SYSTEM SETTINGS ---
		async function fetchSystemSettings() {
			const { data, error } = await client.from('app_settings').select('*').eq('id', 1).single();
			if (data) {
				document.getElementById('sys-maintenance-toggle').checked = data.maintenance_mode;
				document.getElementById('sys-message').value = data.maintenance_message;
			}
		}

		async function saveSystemSettings() {
			const mode = document.getElementById('sys-maintenance-toggle').checked;
			const msg = document.getElementById('sys-message').value.trim() || "H·ªá th·ªëng ƒëang b·∫£o tr√¨.";

			showAlert("L∆∞u c√†i ƒë·∫∑t", `B·∫°n mu·ªën ${mode ? 'B·∫¨T' : 'T·∫ÆT'} ch·∫ø ƒë·ªô b·∫£o tr√¨?`, 'confirm', async () => {
				const { error } = await client.from('app_settings').update({
					maintenance_mode: mode,
					maintenance_message: msg
				}).eq('id', 1);

				if (error) showAlert("L·ªói", error.message, 'error');
				else showAlert("Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t c·∫•u h√¨nh h·ªá th·ªëng.", 'success');
			});
		}
		
		// ==========================================
		// --- T√çNH NƒÇNG ƒêƒÇNG NH·∫¨P B·∫∞NG QR CODE ---
		// ==========================================
		let html5QrCode; 

		function startLoginScanner() {
			const overlay = document.getElementById('login-scanner-overlay');
			if (overlay) overlay.classList.remove('hidden');

			if (!html5QrCode) {
				// --- S·ª¨A ID ·ªû ƒê√ÇY CHO KH·ªöP V·ªöI HTML ---
				html5QrCode = new Html5Qrcode("reader-login"); 
			}

			const config = { fps: 10, qrbox: 250, aspectRatio: 1.0 };

			html5QrCode.start(
				{ facingMode: "environment" },
				config,
				(decodedText) => {
					// Khi qu√©t th√†nh c√¥ng
					console.log("QR Login Scan:", decodedText);
					handleLoginQRResult(decodedText);
				},
				() => {} // B·ªè qua l·ªói ƒëang qu√©t
			).catch(err => {
				console.error(err);
				showAlert("L·ªói", 'Kh√¥ng m·ªü ƒë∆∞·ª£c camera sau. ƒêang th·ª≠ camera tr∆∞·ªõc...', "error");
				// Fallback sang camera tr∆∞·ªõc n·∫øu l·ªói
				html5QrCode.start({ facingMode: "user" }, config, (t) => handleLoginQRResult(t));
			});
		}

		function stopLoginScanner() {
			// 1. T·∫Øt camera
			if (html5QrCode && html5QrCode.isScanning) {
				html5QrCode.stop().then(() => {
					console.log("ƒê√£ t·∫Øt camera");
					html5QrCode.clear();
				}).catch(err => console.log("L·ªói t·∫Øt camera:", err));
			}

			// 2. ·∫®n Overlay
			const overlay = document.getElementById('login-scanner-overlay');
			if (overlay) overlay.classList.add('hidden');
		}

		function handleLoginQRResult(text) {
			try {
				// 1. Th·ª≠ gi·∫£i m√£ JSON
				const data = JSON.parse(text);
				
				console.log("D·ªØ li·ªáu qu√©t ƒë∆∞·ª£c:", data); // Xem trong Console F12

				// 2. Ki·ªÉm tra d·ªØ li·ªáu
				// M√£ chu·∫©n ph·∫£i c√≥ ƒë·ªß 3 m√≥n: action="login", email, pass
				if (data.action === 'login' && data.email && data.pass) {
					
					if(navigator.vibrate) navigator.vibrate(200);
					stopLoginScanner();

					document.getElementById('email').value = data.email;
					document.getElementById('password').value = data.pass;
					
					document.getElementById('login-msg').innerText = "‚úÖ ƒê√£ nh·∫≠n m√£! ƒêang ƒëƒÉng nh·∫≠p...";
					document.getElementById('login-msg').className = "text-center text-green-600 text-xs font-bold min-h-[20px]";

					setTimeout(() => { handleLogin(); }, 500);

				} else {
					// --- ƒê√ÇY L√Ä CH·ªñ B√ÅO L·ªñI C·ª¶A B·∫†N ---
					let missing = [];
					if (data.action !== 'login') missing.push(`Sai action (nh·∫≠n ƒë∆∞·ª£c: ${data.action})`);
					if (!data.email) missing.push("Thi·∫øu Email");
					if (!data.pass) missing.push("Thi·∫øu Pass");

					showAlert("C·∫£nh b√°o",'‚ö†Ô∏è M√£ kh√¥ng h·ª£p l·ªá!', "waning");
				}
			} catch (e) {
				console.log("L·ªói ƒë·ªçc m√£:", text);
				showAlert("L·ªói", '‚ùå L·ªói format: M√£ QR n√†y kh√¥ng ch·ª©a d·ªØ li·ªáu JSON h·ª£p l·ªá.', "error");
			}
		}
		
		// L·∫Øng nghe s·ª± ki·ªán ph√≠m Enter t·∫°i √¥ m·∫≠t kh·∫©u
		document.getElementById('qr-password-input').addEventListener('keyup', function (e) {
			if (e.key === 'Enter') {
				// ·∫®n b√†n ph√≠m ·∫£o ngay l·∫≠p t·ª©c ƒë·ªÉ nh√¨n th·∫•y m√†n h√¨nh
				e.target.blur(); 
				submitQRPassword();
			}
		});
		
		// === LOGIC C√ÄI ƒê·∫∂T N√öT SCAN (3 CH·∫æ ƒê·ªò M·ªöI) ===
		let currentScanMode = localStorage.getItem('pos_scan_mode') || 'default'; // M·∫∑c ƒë·ªãnh l√† n√∫t to

		function initScanSettings() {
			const radios = document.getElementsByName('scan_mode');
			radios.forEach(r => {
				if(r.value === currentScanMode) r.checked = true;
			});
			updateScanButtonBehavior();
		}

		// 2. H√†m m·ªü b·∫£ng c√†i ƒë·∫∑t
		function openScanSettings() {
			initScanSettings();
			document.getElementById('scan-settings-modal').classList.remove('hidden');
		}

		// 3. H√†m l∆∞u c√†i ƒë·∫∑t khi ch·ªçn Radio
		function saveScanMode(mode) {
			currentScanMode = mode;
			localStorage.setItem('pos_scan_mode', mode);
			updateScanButtonBehavior();
			
			// N·∫øu chuy·ªÉn ch·∫ø ƒë·ªô, t·ªët nh·∫•t l√† t·∫Øt camera ƒëi ƒë·ªÉ reset giao di·ªán
			stopScanner();
			
			if(navigator.vibrate) navigator.vibrate(50);
		}

		// 4. C·∫≠p nh·∫≠t h√†nh vi n√∫t b·∫•m (QUAN TR·ªåNG)
		function updateScanButtonBehavior() {
			const container = document.getElementById('scan-buttons-container');
			const bigButton = document.getElementById('camera-placeholder'); // N√∫t to gi·ªØa m√†n h√¨nh
			
			if(!container) return;
			container.innerHTML = ""; // X√≥a n√∫t nh·ªè c≈©

			if (currentScanMode === 'default') {
				// --- CH·∫æ ƒê·ªò 1: M·∫∂C ƒê·ªäNH ---
				// 1. Hi·ªán n√∫t to (n·∫øu camera ƒëang t·∫Øt)
				if (bigButton && (!html5QrcodeScanner || !html5QrcodeScanner.isScanning)) {
					bigButton.classList.remove('hidden');
				}
				// 2. Kh√¥ng hi·ªán n√∫t nh·ªè n√†o c·∫£ (container r·ªóng)
			} 
			else {
				// --- CH·∫æ ƒê·ªò 2 & 3: D√ôNG N√öT NH·ªé ---
				
				// 1. Lu√¥n ·∫®n n√∫t to
				if (bigButton) bigButton.classList.add('hidden');

				// 2. Th√™m n√∫t nh·ªè t∆∞∆°ng ·ª©ng
				if (currentScanMode === 'toggle') {
					container.appendChild(createToggleButton());
				} 
				else if (currentScanMode === 'hold') {
					container.appendChild(createHoldButton());
				}
			}
		}

		function createToggleButton() {
			const btn = document.createElement('button');
			btn.className = "w-14 h-12 rounded-xl bg-blue-600 text-white flex items-center justify-center text-2xl shadow-lg active:scale-90 transition-transform shrink-0";
			btn.innerHTML = `
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
				  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z" />
				  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75zM6.75 16.5h.75v.75h-.75v-.75zM16.5 6.75h.75v.75h-.75v-.75zM13.5 13.5h.75v.75h-.75v-.75zM13.5 19.5h.75v.75h-.75v-.75zM19.5 13.5h.75v.75h-.75v-.75zM16.5 16.5h.75v.75h-.75v-.75zM16.5 19.5h.75v.75h-.75v-.75z" />
				</svg>
			`;
			btn.onclick = () => {
				if (html5QrcodeScanner && html5QrcodeScanner.isScanning) stopScanner();
				else startScanner();
			};
			return btn;
		}

		function createHoldButton() {
			const btn = document.createElement('button');
			btn.className = "w-14 h-12 rounded-xl bg-orange-500 text-white flex items-center justify-center text-2xl shadow-lg active:scale-90 transition-transform shrink-0 select-none touch-none";
			btn.innerHTML = "üëÜ";
			
			const start = (e) => { 
				if(e.cancelable) e.preventDefault(); 
				startScanner(); 
				btn.classList.add('scale-110', 'bg-orange-600'); 
			};
			const stop = (e) => { 
				if(e.cancelable) e.preventDefault(); 
				stopScanner(); 
				btn.classList.remove('scale-110', 'bg-orange-600'); 
			};

			btn.addEventListener('touchstart', start, { passive: false });
			btn.addEventListener('touchend', stop);
			btn.addEventListener('mousedown', start);
			btn.addEventListener('mouseup', stop);
			btn.addEventListener('mouseleave', () => {
				if (html5QrcodeScanner && html5QrcodeScanner.isScanning) stop();
			});

			return btn;
		}

		// G·ªçi h√†m kh·ªüi t·∫°o ngay khi script ch·∫°y (ho·∫∑c nh√©t v√†o checkSession)
		setTimeout(initScanSettings, 500);
    </script>
	<script>
		// ƒêƒÉng k√Ω PWA Service Worker
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', () => {
				navigator.serviceWorker.register('./sw.js')
					.then(reg => console.log('PWA ƒë√£ s·∫µn s√†ng:', reg.scope))
					.catch(err => console.log('L·ªói PWA:', err));
			});
		}
	</script>
</body>
</html>